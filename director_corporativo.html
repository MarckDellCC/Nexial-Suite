<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Director Corporativo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        .role-warning { background: #e74c3c; color: white; padding: 20px; margin: 20px 0; border-radius: 5px; display: none; }
        .logout-btn { float: right; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; }
        .tabs { display: flex; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; }
        .tab { padding: 10px 20px; cursor: pointer; background: #ecf0f1; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #2c3e50; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; }
        .tab-content.active { display: block; }
        .controls { margin-bottom: 20px; }
        .btn { padding: 8px 15px; margin-right: 10px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #2c3e50; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 5px; max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
        .form-row { display: flex; gap: 15px; }
        .form-row > div { flex: 1; }
        .close { float: right; font-size: 24px; cursor: pointer; }
        .loading { text-align: center; padding: 20px; }
        .error { color: #e74c3c; padding: 10px; background: #ffeaea; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Panel del Director Corporativo</h1>
        <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
        <p>Usuario: <span id="currentUser">Cargando...</span></p>
    </div>

    <div class="role-warning" id="roleWarning">
        <h2>Acceso Denegado</h2>
        <p>Esta secciÃ³n es exclusiva para usuarios con rol "Director Corporativo".</p>
        <button onclick="window.location.href='index.html'">Volver al Inicio</button>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="tabs" id="tabsContainer"></div>
        
        <div class="tab-contents">
            <!-- El contenido de cada pestaÃ±a se generarÃ¡ dinÃ¡micamente -->
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Formulario</h2>
            <div id="modalForm"></div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de Supabase
        const SUPABASE_URL = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        
        // Inicializar Supabase solo una vez
        let supabaseClient;
        
        // Variables globales
        let currentTable = '';
        let currentRecordId = null;
        let monedas = [];
        let empresas = [];
        let categoriasProductos = [];
        let categoriaNegocios = [];
        let empleados = [];
        
        // Tablas disponibles con sus columnas y tipos
        const tables = {
            'monedas': {
                fields: [
                    { name: 'codigo', label: 'CÃ³digo', type: 'text', required: true, maxlength: 3 },
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 100 },
                    { name: 'simbolo', label: 'SÃ­mbolo', type: 'text', maxlength: 10 },
                    { name: 'pais', label: 'PaÃ­s', type: 'text', maxlength: 100 },
                    { name: 'tasa_cambio', label: 'Tasa de Cambio', type: 'number', step: '0.000001' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'empresas': {
                fields: [
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 255 },
                    { name: 'rfc', label: 'RFC', type: 'text', required: true, maxlength: 50 },
                    { name: 'direccion', label: 'DirecciÃ³n', type: 'textarea' },
                    { name: 'telefono', label: 'TelÃ©fono', type: 'text', maxlength: 50 },
                    { name: 'email', label: 'Email', type: 'email', maxlength: 255 },
                    { name: 'website', label: 'Sitio Web', type: 'url', maxlength: 255 },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [] },
                    { name: 'logo_url', label: 'URL del Logo', type: 'text' },
                    { name: 'tipo_empresa', label: 'Tipo de Empresa', type: 'text', maxlength: 50 },
                    { name: 'regimen_fiscal', label: 'RÃ©gimen Fiscal', type: 'text', maxlength: 100 },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'usuarios': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'empleado_id', label: 'Empleado', type: 'select', options: [] },
                    { name: 'nombres', label: 'Nombres', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_materno', label: 'Apellido Materno', type: 'text', maxlength: 100 },
                    { name: 'email', label: 'Email', type: 'email', required: true, maxlength: 255 },
                    { name: 'usuario', label: 'Usuario', type: 'text', required: true, maxlength: 50 },
                    { name: 'contrasena_plano', label: 'ContraseÃ±a', type: 'password', required: true },
                    { name: 'rol', label: 'Rol', type: 'select', options: [
                        'Director Corporativo', 'Administrador', 'Gerente', 'Supervisor', 'Ejecutivo Comercial', 'Empleado'
                    ], required: true },
                    { name: 'foto_url', label: 'URL de Foto', type: 'text' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'empleados': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'nombres', label: 'Nombres', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_materno', label: 'Apellido Materno', type: 'text', maxlength: 100 },
                    { name: 'documento_identidad', label: 'Documento Identidad', type: 'text', maxlength: 50 },
                    { name: 'tipo_documento', label: 'Tipo Documento', type: 'text', maxlength: 20 },
                    { name: 'direccion', label: 'DirecciÃ³n', type: 'textarea' },
                    { name: 'telefono', label: 'TelÃ©fono', type: 'text', maxlength: 20 },
                    { name: 'email', label: 'Email', type: 'email', maxlength: 255 },
                    { name: 'fecha_nacimiento', label: 'Fecha Nacimiento', type: 'date' },
                    { name: 'genero', label: 'GÃ©nero', type: 'select', options: ['Masculino', 'Femenino', 'Otro'] },
                    { name: 'foto_url', label: 'URL Foto', type: 'text' },
                    { name: 'fecha_contratacion', label: 'Fecha ContrataciÃ³n', type: 'date' },
                    { name: 'salario_base', label: 'Salario Base', type: 'number', step: '0.01' },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [] },
                    { name: 'tipo_contrato', label: 'Tipo Contrato', type: 'text', maxlength: 50 },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'clientes': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'categoria_negocio_id', label: 'CategorÃ­a Negocio', type: 'select', options: [] },
                    { name: 'nombres', label: 'Nombres', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_materno', label: 'Apellido Materno', type: 'text', maxlength: 100 },
                    { name: 'documento_identidad', label: 'Documento Identidad', type: 'text', maxlength: 50 },
                    { name: 'tipo_documento', label: 'Tipo Documento', type: 'text', maxlength: 20 },
                    { name: 'ciudad', label: 'Ciudad', type: 'text', maxlength: 100 },
                    { name: 'estado', label: 'Estado', type: 'text', maxlength: 100 },
                    { name: 'pais', label: 'PaÃ­s', type: 'text', maxlength: 100 },
                    { name: 'codigo_postal', label: 'CÃ³digo Postal', type: 'text', maxlength: 20 },
                    { name: 'telefono', label: 'TelÃ©fono', type: 'text', maxlength: 20 },
                    { name: 'email', label: 'Email', type: 'email', maxlength: 255 },
                    { name: 'fecha_nacimiento', label: 'Fecha Nacimiento', type: 'date' },
                    { name: 'genero', label: 'GÃ©nero', type: 'select', options: ['Masculino', 'Femenino', 'Otro'] },
                    { name: 'foto_url', label: 'URL Foto', type: 'text' },
                    { name: 'tipo_cliente', label: 'Tipo Cliente', type: 'text', maxlength: 50 },
                    { name: 'limite_credito', label: 'LÃ­mite CrÃ©dito', type: 'number', step: '0.01' },
                    { name: 'dias_credito', label: 'DÃ­as CrÃ©dito', type: 'number' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'productos': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'codigo', label: 'CÃ³digo', type: 'text', required: true, maxlength: 50 },
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 255 },
                    { name: 'descripcion', label: 'DescripciÃ³n', type: 'textarea' },
                    { name: 'categoria_id', label: 'CategorÃ­a', type: 'select', options: [] },
                    { name: 'precio_compra', label: 'Precio Compra', type: 'number', step: '0.01' },
                    { name: 'precio_venta', label: 'Precio Venta', type: 'number', step: '0.01', required: true },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [], required: true },
                    { name: 'imagen_url', label: 'URL Imagen', type: 'text' },
                    { name: 'peso', label: 'Peso', type: 'number', step: '0.01' },
                    { name: 'dimensiones', label: 'Dimensiones', type: 'text', maxlength: 50 },
                    { name: 'unidad_medida', label: 'Unidad Medida', type: 'text', maxlength: 20 },
                    { name: 'es_producto_clave', label: 'Producto Clave', type: 'checkbox' },
                    { name: 'compra_minima_cantidad', label: 'Compra MÃ­nima Cantidad', type: 'number', step: '1' },
                    { name: 'compra_minima_monto', label: 'Compra MÃ­nima Monto', type: 'number', step: '0.01' },
                    { name: 'compra_minima_peso', label: 'Compra MÃ­nima Peso', type: 'number', step: '0.01' },
                    { name: 'codigo_barras', label: 'CÃ³digo Barras', type: 'text', maxlength: 100 },
                    { name: 'ubicacion_almacen', label: 'UbicaciÃ³n AlmacÃ©n', type: 'text', maxlength: 100 },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'ventas': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'cliente_id', label: 'Cliente', type: 'select', options: [], required: true },
                    { name: 'empleado_id', label: 'Empleado', type: 'select', options: [] },
                    { name: 'almacen_id', label: 'AlmacÃ©n', type: 'select', options: [] },
                    { name: 'numero_venta', label: 'NÃºmero Venta', type: 'text', required: true, maxlength: 50 },
                    { name: 'fecha', label: 'Fecha', type: 'datetime-local' },
                    { name: 'subtotal', label: 'Subtotal', type: 'number', step: '0.01', required: true },
                    { name: 'impuesto', label: 'Impuesto', type: 'number', step: '0.01', required: true },
                    { name: 'total', label: 'Total', type: 'number', step: '0.01', required: true },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [], required: true },
                    { name: 'estado', label: 'Estado', type: 'select', options: ['pendiente', 'completada', 'cancelada'], required: true },
                    { name: 'metodo_pago', label: 'MÃ©todo Pago', type: 'text', maxlength: 50 },
                    { name: 'tipo_venta', label: 'Tipo Venta', type: 'text', maxlength: 50 },
                    { name: 'observaciones', label: 'Observaciones', type: 'textarea' }
                ]
            }
        };
        
        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializar Supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Verificar sesiÃ³n y rol
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                document.getElementById('currentUser').textContent = session.user.email;
                
                // Obtener el rol del usuario
                const { data: userData, error } = await supabaseClient
                    .from('usuarios')
                    .select('rol')
                    .eq('email', session.user.email)
                    .single();
                
                if (error) {
                    console.error('Error obteniendo datos de usuario:', error);
                    throw error;
                }
                
                if (userData.rol !== 'Director Corporativo') {
                    document.getElementById('roleWarning').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    await loadReferenceData();
                    createTabs();
                    loadTableData('monedas');
                }
            } catch (error) {
                console.error('Error inicializando:', error);
                document.getElementById('roleWarning').style.display = 'block';
            }
        });
        
        // Cerrar sesiÃ³n
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error cerrando sesiÃ³n:', error);
            }
        }
        
        // Cargar datos de referencia
        async function loadReferenceData() {
            try {
                // Cargar monedas
                const { data: monedasData, error: monedasError } = await supabaseClient
                    .from('monedas')
                    .select('*')
                    .order('codigo');
                
                if (!monedasError) {
                    monedas = monedasData;
                    tables.empresas.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                    tables.productos.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                    tables.ventas.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                    tables.empleados.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                }
                
                // Cargar empresas
                const { data: empresasData, error: empresasError } = await supabaseClient
                    .from('empresas')
                    .select('*')
                    .order('nombre');
                
                if (!empresasError) {
                    empresas = empresasData;
                    const empresaOptions = empresas.map(e => ({ value: e.id, label: e.nombre }));
                    
                    tables.usuarios.fields.find(f => f.name === 'empresa_id').options = empresaOptions;
                    tables.clientes.fields.find(f => f.name === 'empresa_id').options = empresaOptions;
                    tables.productos.fields.find(f => f.name === 'empresa_id').options = empresaOptions;
                    tables.ventas.fields.find(f => f.name === 'empresa_id').options = empresaOptions;
                    tables.empleados.fields.find(f => f.name === 'empresa_id').options = empresaOptions;
                }
                
                // Cargar categorÃ­as de productos
                const { data: categoriasData, error: categoriasError } = await supabaseClient
                    .from('categoria_productos')
                    .select('*')
                    .order('nombre');
                
                if (!categoriasError) {
                    categoriasProductos = categoriasData;
                    tables.productos.fields.find(f => f.name === 'categoria_id').options = 
                        categoriasProductos.map(c => ({ value: c.id, label: c.nombre }));
                }
                
                // Cargar categorÃ­as de negocios
                const { data: categoriasNegociosData, error: categoriasNegociosError } = await supabaseClient
                    .from('categoria_negocios')
                    .select('*')
                    .order('nombre');
                
                if (!categoriasNegociosError) {
                    categoriaNegocios = categoriasNegociosData;
                    tables.clientes.fields.find(f => f.name === 'categoria_negocio_id').options = 
                        categoriaNegocios.map(c => ({ value: c.id, label: c.nombre }));
                }
                
                // Cargar empleados
                const { data: empleadosData, error: empleadosError } = await supabaseClient
                    .from('empleados')
                    .select('*')
                    .order('nombres');
                
                if (!empleadosError) {
                    empleados = empleadosData;
                    const empleadoOptions = empleados.map(e => ({ 
                        value: e.id, 
                        label: `${e.nombres} ${e.apellido_paterno}` 
                    }));
                    
                    tables.usuarios.fields.find(f => f.name === 'empleado_id').options = empleadoOptions;
                    tables.ventas.fields.find(f => f.name === 'empleado_id').options = empleadoOptions;
                }
                
                // Cargar clientes para ventas
                const { data: clientesData, error: clientesError } = await supabaseClient
                    .from('clientes')
                    .select('*')
                    .order('nombres');
                
                if (!clientesError) {
                    tables.ventas.fields.find(f => f.name === 'cliente_id').options = 
                        clientesData.map(c => ({ 
                            value: c.id, 
                            label: `${c.nombres} ${c.apellido_paterno}` 
                        }));
                }
                
            } catch (error) {
                console.error('Error cargando datos de referencia:', error);
                showError('Error cargando datos de referencia');
            }
        }
        
        // Crear pestaÃ±as
        function createTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            Object.keys(tables).forEach((tableName, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = tableName.charAt(0).toUpperCase() + tableName.slice(1);
                tab.onclick = () => switchTab(tableName);
                tabsContainer.appendChild(tab);
                
                const content = document.createElement('div');
                content.id = `tab-${tableName}`;
                content.className = `tab-content ${index === 0 ? 'active' : ''}`;
                content.innerHTML = `
                    <div class="controls">
                        <button class="btn btn-primary" onclick="openCreateModal('${tableName}')">
                            Nuevo Registro
                        </button>
                    </div>
                    <div id="table-${tableName}">
                        <div class="loading">Cargando datos...</div>
                    </div>
                `;
                document.querySelector('.tab-contents').appendChild(content);
            });
        }
        
        // Cambiar pestaÃ±a
        function switchTab(tableName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tableName}`).classList.add('active');
            
            loadTableData(tableName);
        }
        
        // Cargar datos de tabla
        async function loadTableData(tableName) {
            currentTable = tableName;
            const tableContainer = document.getElementById(`table-${tableName}`);
            
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .order('creado_en', { ascending: false });
                
                if (error) throw error;
                
                if (data.length === 0) {
                    tableContainer.innerHTML = '<p>No hay registros disponibles.</p>';
                    return;
                }
                
                let html = '<table>';
                
                // Encabezados
                html += '<thead><tr>';
                Object.keys(data[0]).forEach(key => {
                    if (key !== 'contrasena_plano') {
                        html += `<th>${formatColumnName(key)}</th>`;
                    }
                });
                html += '<th>Acciones</th></tr></thead>';
                
                // Filas
                html += '<tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    Object.entries(row).forEach(([key, value]) => {
                        if (key !== 'contrasena_plano') {
                            html += `<td>${formatCellValue(key, value)}</td>`;
                        }
                    });
                    
                    html += `
                        <td>
                            <button class="btn btn-success" onclick="openEditModal('${tableName}', '${row.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRecord('${tableName}', '${row.id}')">Eliminar</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                
                tableContainer.innerHTML = html;
                
            } catch (error) {
                console.error(`Error cargando ${tableName}:`, error);
                tableContainer.innerHTML = `<div class="error">Error cargando datos: ${error.message}</div>`;
            }
        }
        
        // Formatear nombre de columna
        function formatColumnName(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Formatear valor de celda
        function formatCellValue(key, value) {
            if (value === null || value === undefined) return '';
            
            if (typeof value === 'boolean') {
                return value ? 'SÃ­' : 'No';
            }
            
            if (typeof value === 'object') {
                return JSON.stringify(value).substring(0, 50) + '...';
            }
            
            if (key.includes('fecha') || key.includes('_en')) {
                return new Date(value).toLocaleString();
            }
            
            if (key.includes('precio') || key.includes('monto') || key.includes('salario') || key.includes('total')) {
                return parseFloat(value).toFixed(2);
            }
            
            if ((key === 'moneda_id' || key === 'empresa_id' || key === 'categoria_id' || 
                 key === 'cliente_id' || key === 'empleado_id') && value) {
                return value.substring(0, 8) + '...';
            }
            
            return String(value);
        }
        
        // Abrir modal para crear
        function openCreateModal(tableName) {
            currentRecordId = null;
            document.getElementById('modalTitle').textContent = `Nuevo ${tableName.slice(0, -1)}`;
            
            const form = generateForm(tableName);
            document.getElementById('modalForm').innerHTML = form;
            document.getElementById('modal').style.display = 'block';
        }
        
        // Abrir modal para editar
        async function openEditModal(tableName, recordId) {
            currentRecordId = recordId;
            
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('id', recordId)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('modalTitle').textContent = `Editar ${tableName.slice(0, -1)}`;
                const form = generateForm(tableName, data);
                document.getElementById('modalForm').innerHTML = form;
                document.getElementById('modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error cargando registro:', error);
                showError('Error cargando registro: ' + error.message);
            }
        }
        
        // Generar formulario
        function generateForm(tableName, recordData = null) {
            const fields = tables[tableName].fields;
            let formHTML = `<form id="recordForm" onsubmit="saveRecord(event)">`;
            
            fields.forEach(field => {
                const value = recordData ? recordData[field.name] : '';
                
                formHTML += '<div class="form-group">';
                formHTML += `<label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>`;
                
                switch (field.type) {
                    case 'select':
                        formHTML += `<select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>`;
                        formHTML += `<option value="">Seleccionar...</option>`;
                        
                        if (Array.isArray(field.options)) {
                            field.options.forEach(option => {
                                if (typeof option === 'object') {
                                    const selected = (value === option.value || 
                                                     (recordData && recordData[field.name] === option.value)) ? 'selected' : '';
                                    formHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                                } else {
                                    const selected = value === option ? 'selected' : '';
                                    formHTML += `<option value="${option}" ${selected}>${option}</option>`;
                                }
                            });
                        }
                        
                        formHTML += '</select>';
                        break;
                    
                    case 'checkbox':
                        const checked = value ? 'checked' : '';
                        formHTML += `<input type="checkbox" id="${field.name}" name="${field.name}" ${checked}>`;
                        break;
                    
                    case 'textarea':
                        formHTML += `<textarea id="${field.name}" name="${field.name}" 
                            ${field.required ? 'required' : ''} 
                            ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}>${value || ''}</textarea>`;
                        break;
                    
                    case 'datetime-local':
                        let dateValue = value;
                        if (value && typeof value === 'string') {
                            const date = new Date(value);
                            dateValue = date.toISOString().slice(0, 16);
                        }
                        formHTML += `<input type="datetime-local" id="${field.name}" name="${field.name}" 
                            value="${dateValue || ''}" 
                            ${field.required ? 'required' : ''}>`;
                        break;
                    
                    case 'date':
                        let dateOnlyValue = value;
                        if (value && typeof value === 'string') {
                            dateOnlyValue = value.split('T')[0];
                        }
                        formHTML += `<input type="date" id="${field.name}" name="${field.name}" 
                            value="${dateOnlyValue || ''}" 
                            ${field.required ? 'required' : ''}>`;
                        break;
                    
                    default:
                        const inputValue = field.type === 'password' ? '' : value || '';
                        formHTML += `<input type="${field.type}" id="${field.name}" name="${field.name}" 
                            value="${inputValue}" 
                            ${field.required ? 'required' : ''}
                            ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}
                            ${field.step ? `step="${field.step}"` : ''}
                            ${field.type === 'number' ? 'style="width: 100%"' : ''}>`;
                        break;
                }
                
                formHTML += '</div>';
            });
            
            formHTML += `
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>`;
            
            return formHTML;
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modalForm').innerHTML = '';
        }
        
        // Guardar registro
        async function saveRecord(event) {
            event.preventDefault();
            
            const form = document.getElementById('recordForm');
            const formData = new FormData(form);
            const data = {};
            
            tables[currentTable].fields.forEach(field => {
                if (field.type === 'checkbox') {
                    data[field.name] = document.getElementById(field.name).checked;
                } else {
                    const value = formData.get(field.name);
                    if (value !== '' && value !== null) {
                        if (field.type === 'number') {
                            data[field.name] = parseFloat(value);
                        } else {
                            data[field.name] = value;
                        }
                    } else if (field.name.includes('_id')) {
                        data[field.name] = null;
                    }
                }
            });
            
            try {
                let result;
                
                if (currentRecordId) {
                    // Actualizar
                    result = await supabaseClient
                        .from(currentTable)
                        .update(data)
                        .eq('id', currentRecordId);
                } else {
                    // Crear
                    result = await supabaseClient
                        .from(currentTable)
                        .insert([data]);
                }
                
                if (result.error) throw result.error;
                
                alert('Registro guardado exitosamente');
                closeModal();
                loadTableData(currentTable);
                
            } catch (error) {
                console.error('Error guardando registro:', error);
                showError('Error guardando registro: ' + error.message);
            }
        }
        
        // Eliminar registro
        async function deleteRecord(tableName, recordId) {
            if (!confirm('Â¿EstÃ¡ seguro de eliminar este registro? Esta acciÃ³n no se puede deshacer.')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from(tableName)
                    .delete()
                    .eq('id', recordId);
                
                if (error) throw error;
                
                alert('Registro eliminado exitosamente');
                loadTableData(tableName);
                
            } catch (error) {
                console.error('Error eliminando registro:', error);
                showError('Error eliminando registro: ' + error.message);
            }
        }
        
        // Mostrar error
        function showError(message) {
            alert(message);
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
