<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Director Corporativo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        .role-warning { background: #e74c3c; color: white; padding: 20px; margin: 20px 0; border-radius: 5px; display: none; }
        .logout-btn { float: right; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; }
        .tabs { display: flex; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; }
        .tab { padding: 10px 20px; cursor: pointer; background: #ecf0f1; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #2c3e50; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; }
        .tab-content.active { display: block; }
        .controls { margin-bottom: 20px; }
        .btn { padding: 8px 15px; margin-right: 10px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #2c3e50; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 5px; max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; }
        .form-row { display: flex; gap: 15px; }
        .form-row > div { flex: 1; }
        .close { float: right; font-size: 24px; cursor: pointer; }
        .loading { text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Panel del Director Corporativo</h1>
        <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        <p>Usuario: <span id="currentUser">Cargando...</span></p>
    </div>

    <div class="role-warning" id="roleWarning">
        <h2>Acceso Denegado</h2>
        <p>Esta sección es exclusiva para usuarios con rol "Director Corporativo".</p>
        <button onclick="window.location.href='index.html'">Volver al Inicio</button>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="tabs" id="tabsContainer"></div>
        
        <div class="tab-contents">
            <!-- El contenido de cada pestaña se generará dinámicamente -->
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Formulario</h2>
            <div id="modalForm"></div>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentTable = '';
        let currentRecordId = null;
        let monedas = [];
        let empresas = [];
        
        // Tablas disponibles con sus columnas y tipos
        const tables = {
            'monedas': {
                fields: [
                    { name: 'codigo', label: 'Código', type: 'text', required: true, maxlength: 3 },
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 100 },
                    { name: 'simbolo', label: 'Símbolo', type: 'text', maxlength: 10 },
                    { name: 'pais', label: 'País', type: 'text', maxlength: 100 },
                    { name: 'tasa_cambio', label: 'Tasa de Cambio', type: 'number', step: '0.000001' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'empresas': {
                fields: [
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 255 },
                    { name: 'rfc', label: 'RFC', type: 'text', required: true, maxlength: 50 },
                    { name: 'direccion', label: 'Dirección', type: 'textarea' },
                    { name: 'telefono', label: 'Teléfono', type: 'text', maxlength: 50 },
                    { name: 'email', label: 'Email', type: 'email', maxlength: 255 },
                    { name: 'website', label: 'Sitio Web', type: 'url', maxlength: 255 },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [] },
                    { name: 'logo_url', label: 'URL del Logo', type: 'text' },
                    { name: 'tipo_empresa', label: 'Tipo de Empresa', type: 'text', maxlength: 50 },
                    { name: 'regimen_fiscal', label: 'Régimen Fiscal', type: 'text', maxlength: 100 },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'usuarios': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'empleado_id', label: 'Empleado', type: 'select', options: [] },
                    { name: 'nombres', label: 'Nombres', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_materno', label: 'Apellido Materno', type: 'text', maxlength: 100 },
                    { name: 'email', label: 'Email', type: 'email', required: true, maxlength: 255 },
                    { name: 'usuario', label: 'Usuario', type: 'text', required: true, maxlength: 50 },
                    { name: 'contrasena_plano', label: 'Contraseña', type: 'password', required: true },
                    { name: 'rol', label: 'Rol', type: 'select', options: [
                        'Director Corporativo', 'Administrador', 'Gerente', 'Supervisor', 'Ejecutivo'
                    ], required: true },
                    { name: 'foto_url', label: 'URL de Foto', type: 'text' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'clientes': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'categoria_negocio_id', label: 'Categoría Negocio', type: 'select', options: [] },
                    { name: 'nombres', label: 'Nombres', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true, maxlength: 100 },
                    { name: 'apellido_materno', label: 'Apellido Materno', type: 'text', maxlength: 100 },
                    { name: 'documento_identidad', label: 'Documento Identidad', type: 'text', maxlength: 50 },
                    { name: 'tipo_documento', label: 'Tipo Documento', type: 'text', maxlength: 20 },
                    { name: 'ciudad', label: 'Ciudad', type: 'text', maxlength: 100 },
                    { name: 'estado', label: 'Estado', type: 'text', maxlength: 100 },
                    { name: 'pais', label: 'País', type: 'text', maxlength: 100 },
                    { name: 'codigo_postal', label: 'Código Postal', type: 'text', maxlength: 20 },
                    { name: 'telefono', label: 'Teléfono', type: 'text', maxlength: 20 },
                    { name: 'email', label: 'Email', type: 'email', maxlength: 255 },
                    { name: 'fecha_nacimiento', label: 'Fecha Nacimiento', type: 'date' },
                    { name: 'genero', label: 'Género', type: 'select', options: ['Masculino', 'Femenino', 'Otro'] },
                    { name: 'foto_url', label: 'URL Foto', type: 'text' },
                    { name: 'tipo_cliente', label: 'Tipo Cliente', type: 'text', maxlength: 50 },
                    { name: 'limite_credito', label: 'Límite Crédito', type: 'number', step: '0.01' },
                    { name: 'dias_credito', label: 'Días Crédito', type: 'number' },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            },
            'productos': {
                fields: [
                    { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                    { name: 'codigo', label: 'Código', type: 'text', required: true, maxlength: 50 },
                    { name: 'nombre', label: 'Nombre', type: 'text', required: true, maxlength: 255 },
                    { name: 'descripcion', label: 'Descripción', type: 'textarea' },
                    { name: 'categoria_id', label: 'Categoría', type: 'select', options: [] },
                    { name: 'precio_compra', label: 'Precio Compra', type: 'number', step: '0.01' },
                    { name: 'precio_venta', label: 'Precio Venta', type: 'number', step: '0.01', required: true },
                    { name: 'moneda_id', label: 'Moneda', type: 'select', options: [], required: true },
                    { name: 'imagen_url', label: 'URL Imagen', type: 'text' },
                    { name: 'peso', label: 'Peso', type: 'number', step: '0.01' },
                    { name: 'dimensiones', label: 'Dimensiones', type: 'text', maxlength: 50 },
                    { name: 'unidad_medida', label: 'Unidad Medida', type: 'text', maxlength: 20 },
                    { name: 'es_producto_clave', label: 'Producto Clave', type: 'checkbox' },
                    { name: 'codigo_barras', label: 'Código Barras', type: 'text', maxlength: 100 },
                    { name: 'ubicacion_almacen', label: 'Ubicación Almacén', type: 'text', maxlength: 100 },
                    { name: 'activo', label: 'Activo', type: 'checkbox' }
                ]
            }
            // Se pueden añadir más tablas aquí...
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserRole();
            if (document.getElementById('mainContent').style.display === 'block') {
                await loadReferenceData();
                createTabs();
                loadTableData('monedas');
            }
        });
        
        // Verificar rol del usuario
        async function checkUserRole() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                document.getElementById('currentUser').textContent = session.user.email;
                
                // Obtener el rol del usuario desde la tabla usuarios
                const { data: userData, error } = await supabase
                    .from('usuarios')
                    .select('rol')
                    .eq('email', session.user.email)
                    .single();
                
                if (error) throw error;
                
                if (userData.rol !== 'Director Corporativo') {
                    document.getElementById('roleWarning').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                }
            } catch (error) {
                console.error('Error verificando rol:', error);
                document.getElementById('roleWarning').style.display = 'block';
            }
        }
        
        // Cerrar sesión
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Cargar datos de referencia (monedas, empresas, etc.)
        async function loadReferenceData() {
            try {
                // Cargar monedas
                const { data: monedasData, error: monedasError } = await supabase
                    .from('monedas')
                    .select('*');
                
                if (!monedasError) {
                    monedas = monedasData;
                    tables.empresas.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                    tables.productos.fields.find(f => f.name === 'moneda_id').options = 
                        monedas.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
                }
                
                // Cargar empresas
                const { data: empresasData, error: empresasError } = await supabase
                    .from('empresas')
                    .select('*');
                
                if (!empresasError) {
                    empresas = empresasData;
                    tables.usuarios.fields.find(f => f.name === 'empresa_id').options = 
                        empresas.map(e => ({ value: e.id, label: e.nombre }));
                    tables.clientes.fields.find(f => f.name === 'empresa_id').options = 
                        empresas.map(e => ({ value: e.id, label: e.nombre }));
                    tables.productos.fields.find(f => f.name === 'empresa_id').options = 
                        empresas.map(e => ({ value: e.id, label: e.nombre }));
                }
                
                // Cargar categorías de productos
                const { data: categoriasData, error: categoriasError } = await supabase
                    .from('categoria_productos')
                    .select('*');
                
                if (!categoriasError) {
                    tables.productos.fields.find(f => f.name === 'categoria_id').options = 
                        categoriasData.map(c => ({ value: c.id, label: c.nombre }));
                }
                
            } catch (error) {
                console.error('Error cargando datos de referencia:', error);
            }
        }
        
        // Crear pestañas dinámicamente
        function createTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            Object.keys(tables).forEach((tableName, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = tableName.charAt(0).toUpperCase() + tableName.slice(1);
                tab.onclick = () => switchTab(tableName);
                tabsContainer.appendChild(tab);
                
                const content = document.createElement('div');
                content.id = `tab-${tableName}`;
                content.className = `tab-content ${index === 0 ? 'active' : ''}`;
                content.innerHTML = `
                    <div class="controls">
                        <button class="btn btn-primary" onclick="openCreateModal('${tableName}')">
                            Nuevo Registro
                        </button>
                    </div>
                    <div id="table-${tableName}">
                        <div class="loading">Cargando datos...</div>
                    </div>
                `;
                document.querySelector('.tab-contents').appendChild(content);
            });
        }
        
        // Cambiar entre pestañas
        function switchTab(tableName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tableName}`).classList.add('active');
            
            loadTableData(tableName);
        }
        
        // Cargar datos de una tabla específica
        async function loadTableData(tableName) {
            currentTable = tableName;
            const tableContainer = document.getElementById(`table-${tableName}`);
            
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .order('creado_en', { ascending: false });
                
                if (error) throw error;
                
                if (data.length === 0) {
                    tableContainer.innerHTML = '<p>No hay registros disponibles.</p>';
                    return;
                }
                
                // Crear tabla
                let html = '<table>';
                
                // Encabezados
                html += '<thead><tr>';
                Object.keys(data[0]).forEach(key => {
                    if (key !== 'contrasena_plano') { // No mostrar contraseñas
                        html += `<th>${key}</th>`;
                    }
                });
                html += '<th>Acciones</th></tr></thead>';
                
                // Filas
                html += '<tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    Object.entries(row).forEach(([key, value]) => {
                        if (key !== 'contrasena_plano') {
                            let displayValue = value;
                            
                            if (typeof value === 'boolean') {
                                displayValue = value ? 'Sí' : 'No';
                            } else if (value === null || value === undefined) {
                                displayValue = '';
                            } else if (typeof value === 'object') {
                                displayValue = JSON.stringify(value).substring(0, 50) + '...';
                            } else if (key === 'moneda_id' || key === 'empresa_id') {
                                // Intentar mostrar nombre en lugar de UUID
                                const refData = key === 'moneda_id' ? monedas : empresas;
                                const refItem = refData.find(item => item.id === value);
                                displayValue = refItem ? `${refItem.nombre} (${value.substring(0, 8)}...)` : value;
                            }
                            
                            html += `<td title="${value}">${displayValue}</td>`;
                        }
                    });
                    
                    html += `
                        <td>
                            <button class="btn btn-success" onclick="openEditModal('${tableName}', '${row.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRecord('${tableName}', '${row.id}')">Eliminar</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                
                tableContainer.innerHTML = html;
                
            } catch (error) {
                console.error(`Error cargando ${tableName}:`, error);
                tableContainer.innerHTML = `<p class="error">Error cargando datos: ${error.message}</p>`;
            }
        }
        
        // Abrir modal para crear nuevo registro
        function openCreateModal(tableName) {
            currentRecordId = null;
            document.getElementById('modalTitle').textContent = `Nuevo ${tableName.slice(0, -1)}`;
            
            const form = generateForm(tableName);
            document.getElementById('modalForm').innerHTML = form;
            document.getElementById('modal').style.display = 'block';
        }
        
        // Abrir modal para editar registro
        async function openEditModal(tableName, recordId) {
            currentRecordId = recordId;
            
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .eq('id', recordId)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('modalTitle').textContent = `Editar ${tableName.slice(0, -1)}`;
                const form = generateForm(tableName, data);
                document.getElementById('modalForm').innerHTML = form;
                document.getElementById('modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error cargando registro:', error);
                alert('Error cargando registro: ' + error.message);
            }
        }
        
        // Generar formulario dinámicamente
        function generateForm(tableName, recordData = null) {
            const fields = tables[tableName].fields;
            let formHTML = `<form id="recordForm" onsubmit="saveRecord(event)">`;
            
            fields.forEach(field => {
                formHTML += '<div class="form-group">';
                formHTML += `<label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>`;
                
                const value = recordData ? recordData[field.name] : '';
                
                switch (field.type) {
                    case 'select':
                        formHTML += `<select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>`;
                        formHTML += `<option value="">Seleccionar...</option>`;
                        
                        if (Array.isArray(field.options)) {
                            field.options.forEach(option => {
                                if (typeof option === 'object') {
                                    const selected = value === option.value ? 'selected' : '';
                                    formHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                                } else {
                                    const selected = value === option ? 'selected' : '';
                                    formHTML += `<option value="${option}" ${selected}>${option}</option>`;
                                }
                            });
                        }
                        
                        formHTML += '</select>';
                        break;
                    
                    case 'checkbox':
                        const checked = value ? 'checked' : '';
                        formHTML += `<input type="checkbox" id="${field.name}" name="${field.name}" ${checked}>`;
                        break;
                    
                    case 'textarea':
                        formHTML += `<textarea id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''} ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}>${value || ''}</textarea>`;
                        break;
                    
                    default:
                        const inputType = field.type === 'number' ? 'number' : 
                                         field.type === 'email' ? 'email' : 
                                         field.type === 'url' ? 'url' : 
                                         field.type === 'date' ? 'date' : 'text';
                        
                        const inputValue = field.type === 'password' ? '' : value || '';
                        
                        formHTML += `<input type="${inputType}" id="${field.name}" name="${field.name}" 
                            value="${inputValue}" 
                            ${field.required ? 'required' : ''}
                            ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}
                            ${field.step ? `step="${field.step}"` : ''}
                            ${field.type === 'password' && !recordData ? 'required' : ''}>`;
                        break;
                }
                
                formHTML += '</div>';
            });
            
            formHTML += `
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>`;
            
            return formHTML;
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modalForm').innerHTML = '';
        }
        
        // Guardar registro (crear o actualizar)
        async function saveRecord(event) {
            event.preventDefault();
            
            const form = document.getElementById('recordForm');
            const formData = new FormData(form);
            const data = {};
            
            // Convertir FormData a objeto
            tables[currentTable].fields.forEach(field => {
                if (field.type === 'checkbox') {
                    data[field.name] = document.getElementById(field.name).checked;
                } else if (field.type === 'select' && field.name.includes('_id')) {
                    const value = formData.get(field.name);
                    data[field.name] = value || null;
                } else {
                    const value = formData.get(field.name);
                    if (value !== '' && value !== null) {
                        data[field.name] = value;
                    }
                }
            });
            
            try {
                let result;
                
                if (currentRecordId) {
                    // Actualizar registro existente
                    result = await supabase
                        .from(currentTable)
                        .update(data)
                        .eq('id', currentRecordId);
                } else {
                    // Crear nuevo registro
                    result = await supabase
                        .from(currentTable)
                        .insert([data]);
                }
                
                if (result.error) throw result.error;
                
                alert('Registro guardado exitosamente');
                closeModal();
                loadTableData(currentTable);
                
            } catch (error) {
                console.error('Error guardando registro:', error);
                alert('Error guardando registro: ' + error.message);
            }
        }
        
        // Eliminar registro
        async function deleteRecord(tableName, recordId) {
            if (!confirm('¿Está seguro de eliminar este registro? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', recordId);
                
                if (error) throw error;
                
                alert('Registro eliminado exitosamente');
                loadTableData(tableName);
                
            } catch (error) {
                console.error('Error eliminando registro:', error);
                alert('Error eliminando registro: ' + error.message);
            }
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
