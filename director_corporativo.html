<!-- director_corporativo.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Director Corporativo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 2rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f1f1f1; }
        button { padding: 5px 10px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-edit { background: #ffc107; color: black; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-add { background: #28a745; color: white; padding: 10px 20px; font-size: 1rem; margin-bottom: 20px; }
        .form-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-cancel { background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .logout { float: right; background: #dc3545; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
    </style>
</head>
<body>
    <a href="#" class="logout" id="logoutBtn">Cerrar sesión</a>
    <h1>Panel de Director Corporativo</h1>
    <p>Bienvenido, <span id="userName"></span></p>

    <button class="btn-add" id="showAddFormBtn">+ Nueva Empresa</button>

    <!-- Formulario para crear/editar empresa -->
    <div class="form-container" id="empresaFormContainer" style="display: none;">
        <h2 id="formTitle">Nueva Empresa</h2>
        <form id="empresaForm">
            <input type="hidden" id="empresaId">
            <div class="form-group">
                <label for="nombre">Nombre *</label>
                <input type="text" id="nombre" required>
            </div>
            <div class="form-group">
                <label for="rfc">RFC *</label>
                <input type="text" id="rfc" required>
            </div>
            <div class="form-group">
                <label for="direccion">Dirección</label>
                <textarea id="direccion" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="telefono">Teléfono</label>
                <input type="text" id="telefono">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email">
            </div>
            <div class="form-group">
                <label for="website">Website</label>
                <input type="url" id="website">
            </div>
            <div class="form-group">
                <label for="moneda_id">Moneda *</label>
                <select id="moneda_id" required>
                    <option value="">Seleccione una moneda</option>
                </select>
            </div>
            <div class="form-group">
                <label for="logo_url">Logo URL</label>
                <input type="url" id="logo_url">
            </div>
            <div class="form-group">
                <label for="tipo_empresa">Tipo de empresa</label>
                <input type="text" id="tipo_empresa">
            </div>
            <div class="form-group">
                <label for="regimen_fiscal">Régimen fiscal</label>
                <input type="text" id="regimen_fiscal">
            </div>
            <div class="form-group">
                <label for="activo">Activo</label>
                <input type="checkbox" id="activo" checked> Sí
            </div>
            <button type="submit" class="btn-submit">Guardar</button>
            <button type="button" class="btn-cancel" id="cancelFormBtn">Cancelar</button>
            <div id="formError" class="error"></div>
            <div id="formSuccess" class="success"></div>
        </form>
    </div>

    <!-- Tabla de empresas -->
    <h2>Empresas registradas</h2>
    <table id="empresasTable">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>RFC</th>
                <th>Teléfono</th>
                <th>Email</th>
                <th>Moneda</th>
                <th>Activo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="empresasTableBody">
            <tr><td colspan="7">Cargando...</td></tr>
        </tbody>
    </table>

    <script>
        const SUPABASE_URL = 'https://sknyockrczifqemmdysx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_H3NG5ebaUykfhQgXSezZzw_mwhWAcVQ';

        // Verificar autenticación y rol
        const userJson = sessionStorage.getItem('user');
        if (!userJson) {
            window.location.href = 'login.html';
        } else {
            const user = JSON.parse(userJson);
            if (user.rol !== 'Director Corporativo') {
                alert('Acceso denegado: No tienes el rol de Director Corporativo.');
                window.location.href = 'login.html';
            } else {
                document.getElementById('userName').textContent = `${user.nombres} (${user.usuario})`;
            }
        }

        let monedasMap = new Map(); // id -> codigo

        // Cargar monedas para el selector
        async function loadMonedas() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/monedas?select=id,codigo,nombre&activo=eq.true`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            if (!response.ok) throw new Error('Error al cargar monedas');
            const monedas = await response.json();
            const select = document.getElementById('moneda_id');
            select.innerHTML = '<option value="">Seleccione una moneda</option>';
            monedas.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.codigo} - ${m.nombre}`;
                select.appendChild(option);
                monedasMap.set(m.id, m.codigo);
            });
        }

        // Cargar empresas y mostrarlas en la tabla
        async function loadEmpresas() {
            const tbody = document.getElementById('empresasTableBody');
            tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/empresas?select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) throw new Error('Error al cargar empresas');
                const empresas = await response.json();
                if (empresas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay empresas registradas</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                empresas.forEach(emp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${emp.nombre || ''}</td>
                        <td>${emp.rfc || ''}</td>
                        <td>${emp.telefono || ''}</td>
                        <td>${emp.email || ''}</td>
                        <td>${monedasMap.get(emp.moneda_id) || emp.moneda_id}</td>
                        <td>${emp.activo ? 'Sí' : 'No'}</td>
                        <td>
                            <button class="btn-edit" data-id="${emp.id}">Editar</button>
                            <button class="btn-delete" data-id="${emp.id}">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Asignar eventos a botones de editar y eliminar
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', () => editEmpresa(btn.dataset.id));
                });
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', () => deleteEmpresa(btn.dataset.id));
                });
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="7">Error: ${error.message}</td></tr>`;
            }
        }

        // Función para obtener una empresa por ID
        async function getEmpresaById(id) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/empresas?id=eq.${id}&select=*`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            if (!response.ok) throw new Error('Error al obtener empresa');
            const data = await response.json();
            return data[0];
        }

        // Mostrar formulario en modo edición
        async function editEmpresa(id) {
            try {
                const empresa = await getEmpresaById(id);
                document.getElementById('formTitle').textContent = 'Editar Empresa';
                document.getElementById('empresaId').value = empresa.id;
                document.getElementById('nombre').value = empresa.nombre || '';
                document.getElementById('rfc').value = empresa.rfc || '';
                document.getElementById('direccion').value = empresa.direccion || '';
                document.getElementById('telefono').value = empresa.telefono || '';
                document.getElementById('email').value = empresa.email || '';
                document.getElementById('website').value = empresa.website || '';
                document.getElementById('moneda_id').value = empresa.moneda_id || '';
                document.getElementById('logo_url').value = empresa.logo_url || '';
                document.getElementById('tipo_empresa').value = empresa.tipo_empresa || '';
                document.getElementById('regimen_fiscal').value = empresa.regimen_fiscal || '';
                document.getElementById('activo').checked = empresa.activo !== false;
                document.getElementById('empresaFormContainer').style.display = 'block';
                document.getElementById('formError').textContent = '';
                document.getElementById('formSuccess').textContent = '';
            } catch (error) {
                alert('Error al cargar datos de la empresa: ' + error.message);
            }
        }

        // Eliminar empresa
        async function deleteEmpresa(id) {
            if (!confirm('¿Está seguro de eliminar esta empresa? Esta acción puede afectar datos relacionados.')) return;
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/empresas?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Error al eliminar');
                loadEmpresas();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Guardar (crear o actualizar)
        async function saveEmpresa(event) {
            event.preventDefault();
            const id = document.getElementById('empresaId').value;
            const empresaData = {
                nombre: document.getElementById('nombre').value.trim(),
                rfc: document.getElementById('rfc').value.trim(),
                direccion: document.getElementById('direccion').value.trim() || null,
                telefono: document.getElementById('telefono').value.trim() || null,
                email: document.getElementById('email').value.trim() || null,
                website: document.getElementById('website').value.trim() || null,
                moneda_id: document.getElementById('moneda_id').value,
                logo_url: document.getElementById('logo_url').value.trim() || null,
                tipo_empresa: document.getElementById('tipo_empresa').value.trim() || null,
                regimen_fiscal: document.getElementById('regimen_fiscal').value.trim() || null,
                activo: document.getElementById('activo').checked
            };

            // Validar campos requeridos
            if (!empresaData.nombre || !empresaData.rfc || !empresaData.moneda_id) {
                document.getElementById('formError').textContent = 'Nombre, RFC y Moneda son obligatorios.';
                return;
            }

            try {
                let response;
                if (id) {
                    // Actualizar
                    response = await fetch(`${SUPABASE_URL}/rest/v1/empresas?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(empresaData)
                    });
                } else {
                    // Crear nueva
                    response = await fetch(`${SUPABASE_URL}/rest/v1/empresas`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(empresaData)
                    });
                }
                if (!response.ok) throw new Error('Error al guardar');
                document.getElementById('formSuccess').textContent = 'Empresa guardada correctamente.';
                setTimeout(() => {
                    document.getElementById('empresaFormContainer').style.display = 'none';
                    loadEmpresas();
                }, 1500);
            } catch (error) {
                document.getElementById('formError').textContent = error.message;
            }
        }

        // Eventos
        document.getElementById('showAddFormBtn').addEventListener('click', () => {
            document.getElementById('formTitle').textContent = 'Nueva Empresa';
            document.getElementById('empresaForm').reset();
            document.getElementById('empresaId').value = '';
            document.getElementById('formError').textContent = '';
            document.getElementById('formSuccess').textContent = '';
            document.getElementById('empresaFormContainer').style.display = 'block';
        });

        document.getElementById('cancelFormBtn').addEventListener('click', () => {
            document.getElementById('empresaFormContainer').style.display = 'none';
        });

        document.getElementById('empresaForm').addEventListener('submit', saveEmpresa);

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.removeItem('user');
            window.location.href = 'login.html';
        });

        // Inicializar
        (async function init() {
            await loadMonedas();
            await loadEmpresas();
        })();
    </script>
</body>
</html>
