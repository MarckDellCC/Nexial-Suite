<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Nexial Suite</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-header h2 {
            margin: 0;
            color: #333;
        }
        .btn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 20px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Director Corporativo - Nexial Suite</h1>
        <button class="logout-btn" id="logout-btn">Cerrar Sesión</button>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="empresas">Empresas</button>
            <button class="tab" data-tab="usuarios">Usuarios</button>
            <button class="tab" data-tab="monitoreo">Monitoreo</button>
        </div>
        
        <!-- Tab Empresas -->
        <div class="tab-content active" id="empresas-tab">
            <div class="section-header">
                <h2>Gestión de Empresas</h2>
                <button class="btn" id="nueva-empresa-btn">Nueva Empresa</button>
            </div>
            
            <div id="empresas-list">
                <div class="loading">Cargando empresas...</div>
            </div>
        </div>
        
        <!-- Tab Usuarios -->
        <div class="tab-content" id="usuarios-tab">
            <div class="section-header">
                <h2>Gestión de Usuarios</h2>
                <button class="btn" id="nuevo-usuario-btn">Nuevo Usuario</button>
            </div>
            
            <div id="usuarios-list">
                <div class="loading">Cargando usuarios...</div>
            </div>
        </div>
        
        <!-- Tab Monitoreo -->
        <div class="tab-content" id="monitoreo-tab">
            <div class="section-header">
                <h2>Monitoreo del Sistema</h2>
            </div>
            
            <div id="monitoreo-content">
                <div class="loading">Cargando información del sistema...</div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Empresa -->
    <div class="modal" id="empresa-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="empresa-modal-title">Nueva Empresa</h3>
                <button class="close-btn" id="close-empresa-modal">&times;</button>
            </div>
            <form id="empresa-form">
                <input type="hidden" id="empresa-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="codigo_empresa">Código Empresa *</label>
                        <input type="text" id="codigo_empresa" name="codigo_empresa" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre_legal">Nombre Legal *</label>
                        <input type="text" id="nombre_legal" name="nombre_legal" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="nombre_comercial">Nombre Comercial</label>
                    <input type="text" id="nombre_comercial" name="nombre_comercial">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rut_nit_identificacion">RUT/NIT/Identificación</label>
                        <input type="text" id="rut_nit_identificacion" name="rut_nit_identificacion">
                    </div>
                    <div class="form-group">
                        <label for="pais">País *</label>
                        <input type="text" id="pais" name="pais" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ciudad">Ciudad</label>
                        <input type="text" id="ciudad" name="ciudad">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="text" id="telefono" name="telefono">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="moneda_principal">Moneda Principal *</label>
                        <input type="text" id="moneda_principal" name="moneda_principal" required value="COP">
                    </div>
                    <div class="form-group">
                        <label for="moneda_alternativa">Moneda Alternativa</label>
                        <input type="text" id="moneda_alternativa" name="moneda_alternativa">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="zona_horaria">Zona Horaria *</label>
                        <input type="text" id="zona_horaria" name="zona_horaria" required value="America/Bogota">
                    </div>
                    <div class="form-group">
                        <label for="activa">Estado</label>
                        <select id="activa" name="activa">
                            <option value="true">Activa</option>
                            <option value="false">Inactiva</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="direccion">Dirección</label>
                    <textarea id="direccion" name="direccion" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="configuracion">Configuración (JSON)</label>
                    <textarea id="configuracion" name="configuracion" rows="3">{}</textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">Guardar Empresa</button>
                    <button type="button" class="btn btn-danger" id="eliminar-empresa-btn" style="display: none;">Eliminar Empresa</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Usuario -->
    <div class="modal" id="usuario-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="usuario-modal-title">Nuevo Usuario</h3>
                <button class="close-btn" id="close-usuario-modal">&times;</button>
            </div>
            <form id="usuario-form">
                <input type="hidden" id="usuario-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="usuario-empresa-id">Empresa *</label>
                        <select id="usuario-empresa-id" name="empresa_id" required></select>
                    </div>
                    <div class="form-group">
                        <label for="empleado_id">Empleado Asociado</label>
                        <select id="empleado_id" name="empleado_id"></select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Username *</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario-email">Email *</label>
                        <input type="email" id="usuario-email" name="email" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Contraseña *</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="rol_sistema">Rol Sistema *</label>
                        <select id="rol_sistema" name="rol_sistema" required>
                            <option value="DIRECTOR_CORPORATIVO">Director Corporativo</option>
                            <option value="DIRECTOR_GENERAL">Director General</option>
                            <option value="DIRECTOR_FINANCIERO">Director Financiero</option>
                            <option value="SUPERVISOR_SENIOR">Supervisor Senior</option>
                            <option value="EJECUTIVO_COMERCIAL">Ejecutivo Comercial</option>
                            <option value="ESPECIALISTA_LOGISTICO">Especialista Logístico</option>
                            <option value="GESTOR_ALMACEN">Gestor de Almacén</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nivel_acceso">Nivel Acceso *</label>
                        <input type="number" id="nivel_acceso" name="nivel_acceso" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="cuenta_activada">Estado Cuenta</label>
                        <select id="cuenta_activada" name="cuenta_activada">
                            <option value="true">Activada</option>
                            <option value="false">Desactivada</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="permisos">Permisos (JSON array)</label>
                    <textarea id="permisos" name="permisos" rows="2">[]</textarea>
                </div>
                
                <div class="form-group">
                    <label for="configuracion_usuario">Configuración Usuario (JSON)</label>
                    <textarea id="configuracion_usuario" name="configuracion_usuario" rows="3">{"tema": "claro", "idioma": "es"}</textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">Guardar Usuario</button>
                    <button type="button" class="btn btn-danger" id="eliminar-usuario-btn" style="display: none;">Eliminar Usuario</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://pvzdimdeapyoijqyskgw.supabase.co';
        const supabaseKey = 'sb_publishable_TMnyMhf1VJ0aPZhNuChVeA_bX4_C1hx';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Verificar sesión
        const SESSION_KEY = 'nexial_user_session';
        let currentUser = null;
        
        function checkSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if (!session) {
                window.location.href = 'login.html';
                return false;
            }
            
            currentUser = JSON.parse(session);
            
            // Verificar que sea Director Corporativo
            if (currentUser.rol_sistema !== 'DIRECTOR_CORPORATIVO') {
                alert('No tienes permisos para acceder a esta página');
                window.location.href = 'login.html';
                return false;
            }
            
            return true;
        }
        
        // Función para cerrar sesión
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem(SESSION_KEY);
            window.location.href = 'login.html';
        });
        
        // Manejo de pestañas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Cargar contenido de la pestaña
                switch(tabId) {
                    case 'empresas':
                        loadEmpresas();
                        break;
                    case 'usuarios':
                        loadUsuarios();
                        break;
                    case 'monitoreo':
                        loadMonitoreo();
                        break;
                }
            });
        });
        
        // Modal para empresas
        const empresaModal = document.getElementById('empresa-modal');
        const closeEmpresaModal = document.getElementById('close-empresa-modal');
        const nuevaEmpresaBtn = document.getElementById('nueva-empresa-btn');
        
        nuevaEmpresaBtn.addEventListener('click', () => {
            document.getElementById('empresa-modal-title').textContent = 'Nueva Empresa';
            document.getElementById('empresa-form').reset();
            document.getElementById('empresa-id').value = '';
            document.getElementById('eliminar-empresa-btn').style.display = 'none';
            empresaModal.style.display = 'flex';
        });
        
        closeEmpresaModal.addEventListener('click', () => {
            empresaModal.style.display = 'none';
        });
        
        // Modal para usuarios
        const usuarioModal = document.getElementById('usuario-modal');
        const closeUsuarioModal = document.getElementById('close-usuario-modal');
        const nuevoUsuarioBtn = document.getElementById('nuevo-usuario-btn');
        
        nuevoUsuarioBtn.addEventListener('click', async () => {
            document.getElementById('usuario-modal-title').textContent = 'Nuevo Usuario';
            document.getElementById('usuario-form').reset();
            document.getElementById('usuario-id').value = '';
            document.getElementById('eliminar-usuario-btn').style.display = 'none';
            
            // Cargar lista de empresas para el select
            await loadEmpresasForSelect();
            
            usuarioModal.style.display = 'flex';
        });
        
        closeUsuarioModal.addEventListener('click', () => {
            usuarioModal.style.display = 'none';
        });
        
        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', (e) => {
            if (e.target === empresaModal) empresaModal.style.display = 'none';
            if (e.target === usuarioModal) usuarioModal.style.display = 'none';
        });
        
        // Cargar empresas
        async function loadEmpresas() {
            const container = document.getElementById('empresas-list');
            container.innerHTML = '<div class="loading">Cargando empresas...</div>';
            
            try {
                const { data: empresas, error } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('fecha_registro', { ascending: false });
                
                if (error) throw error;
                
                if (!empresas || empresas.length === 0) {
                    container.innerHTML = '<p>No hay empresas registradas.</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre Legal</th>
                                <th>País</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                empresas.forEach(empresa => {
                    html += `
                        <tr>
                            <td>${empresa.codigo_empresa}</td>
                            <td>${empresa.nombre_legal}</td>
                            <td>${empresa.pais}</td>
                            <td>${empresa.telefono || '-'}</td>
                            <td>${empresa.activa ? '<span style="color:green">Activa</span>' : '<span style="color:red">Inactiva</span>'}</td>
                            <td>${new Date(empresa.fecha_registro).toLocaleDateString()}</td>
                            <td>
                                <button class="btn" onclick="editEmpresa('${empresa.id}')">Editar</button>
                                <button class="btn btn-danger" onclick="deleteEmpresa('${empresa.id}', '${empresa.nombre_legal}')">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando empresas:', error);
                container.innerHTML = '<div class="error">Error al cargar empresas</div>';
            }
        }
        
        // Cargar usuarios
        async function loadUsuarios() {
            const container = document.getElementById('usuarios-list');
            container.innerHTML = '<div class="loading">Cargando usuarios...</div>';
            
            try {
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('*, empresas(nombre_legal)')
                    .eq('eliminado', false)
                    .order('fecha_creacion', { ascending: false });
                
                if (error) throw error;
                
                if (!usuarios || usuarios.length === 0) {
                    container.innerHTML = '<p>No hay usuarios registrados.</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Empresa</th>
                                <th>Estado</th>
                                <th>Último Login</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                usuarios.forEach(usuario => {
                    html += `
                        <tr>
                            <td>${usuario.username}</td>
                            <td>${usuario.email}</td>
                            <td>${usuario.rol_sistema}</td>
                            <td>${usuario.empresas?.nombre_legal || '-'}</td>
                            <td>${usuario.cuenta_activada ? (usuario.cuenta_bloqueada ? '<span style="color:orange">Bloqueada</span>' : '<span style="color:green">Activa</span>') : '<span style="color:red">Inactiva</span>'}</td>
                            <td>${usuario.fecha_ultimo_login ? new Date(usuario.fecha_ultimo_login).toLocaleDateString() : 'Nunca'}</td>
                            <td>
                                <button class="btn" onclick="editUsuario('${usuario.id}')">Editar</button>
                                <button class="btn btn-danger" onclick="deleteUsuario('${usuario.id}', '${usuario.username}')">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                container.innerHTML = '<div class="error">Error al cargar usuarios</div>';
            }
        }
        
        // Cargar monitoreo
        async function loadMonitoreo() {
            const container = document.getElementById('monitoreo-content');
            
            try {
                // Obtener estadísticas
                const [
                    empresasCount,
                    usuariosCount,
                    ventasCount,
                    inventarioCount
                ] = await Promise.all([
                    supabase.from('empresas').select('*', { count: 'exact', head: true }),
                    supabase.from('usuarios').select('*', { count: 'exact', head: true }).eq('eliminado', false),
                    supabase.from('ventas').select('*', { count: 'exact', head: true }),
                    supabase.from('inventario').select('*', { count: 'exact', head: true })
                ]);
                
                // Obtener últimos eventos de auditoría
                const { data: auditoria } = await supabase
                    .from('auditoria')
                    .select('*')
                    .order('fecha_cambio', { ascending: false })
                    .limit(10);
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #666;">Empresas</h3>
                            <p style="font-size: 32px; margin: 10px 0; color: #007bff;">${empresasCount.count || 0}</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #666;">Usuarios Activos</h3>
                            <p style="font-size: 32px; margin: 10px 0; color: #28a745;">${usuariosCount.count || 0}</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #666;">Ventas Totales</h3>
                            <p style="font-size: 32px; margin: 10px 0; color: #ffc107;">${ventasCount.count || 0}</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #666;">Items en Inventario</h3>
                            <p style="font-size: 32px; margin: 10px 0; color: #17a2b8;">${inventarioCount.count || 0}</p>
                        </div>
                    </div>
                    
                    <h3>Últimos Eventos del Sistema</h3>
                `;
                
                if (auditoria && auditoria.length > 0) {
                    html += `
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tabla</th>
                                    <th>Acción</th>
                                    <th>Usuario</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    auditoria.forEach(evento => {
                        html += `
                            <tr>
                                <td>${new Date(evento.fecha_cambio).toLocaleString()}</td>
                                <td>${evento.tabla_afectada}</td>
                                <td>${evento.accion}</td>
                                <td>${evento.usuario_id ? evento.usuario_id.substring(0, 8) + '...' : 'Sistema'}</td>
                                <td>${evento.ip_address || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p>No hay eventos registrados.</p>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando monitoreo:', error);
                container.innerHTML = '<div class="error">Error al cargar información del sistema</div>';
            }
        }
        
        // Cargar empresas para select
        async function loadEmpresasForSelect() {
            const select = document.getElementById('usuario-empresa-id');
            
            try {
                const { data: empresas, error } = await supabase
                    .from('empresas')
                    .select('id, nombre_legal')
                    .eq('activa', true)
                    .order('nombre_legal');
                
                if (error) throw error;
                
                select.innerHTML = '<option value="">Seleccionar empresa...</option>';
                
                if (empresas && empresas.length > 0) {
                    empresas.forEach(empresa => {
                        select.innerHTML += `<option value="${empresa.id}">${empresa.nombre_legal}</option>`;
                    });
                }
                
            } catch (error) {
                console.error('Error cargando empresas:', error);
            }
        }
        
        // Formulario para empresa
        document.getElementById('empresa-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const empresaId = document.getElementById('empresa-id').value;
            const formData = {
                codigo_empresa: document.getElementById('codigo_empresa').value,
                nombre_legal: document.getElementById('nombre_legal').value,
                nombre_comercial: document.getElementById('nombre_comercial').value,
                rut_nit_identificacion: document.getElementById('rut_nit_identificacion').value,
                pais: document.getElementById('pais').value,
                ciudad: document.getElementById('ciudad').value,
                direccion: document.getElementById('direccion').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value,
                moneda_principal: document.getElementById('moneda_principal').value,
                moneda_alternativa: document.getElementById('moneda_alternativa').value,
                zona_horaria: document.getElementById('zona_horaria').value,
                activa: document.getElementById('activa').value === 'true',
                configuracion: JSON.parse(document.getElementById('configuracion').value || '{}')
            };
            
            try {
                if (empresaId) {
                    // Actualizar empresa existente
                    const { error } = await supabase
                        .from('empresas')
                        .update(formData)
                        .eq('id', empresaId);
                    
                    if (error) throw error;
                    
                    alert('Empresa actualizada correctamente');
                } else {
                    // Crear nueva empresa
                    const { error } = await supabase
                        .from('empresas')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    alert('Empresa creada correctamente');
                }
                
                empresaModal.style.display = 'none';
                loadEmpresas();
                
            } catch (error) {
                console.error('Error guardando empresa:', error);
                alert('Error al guardar empresa: ' + error.message);
            }
        });
        
        // Formulario para usuario
        document.getElementById('usuario-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const usuarioId = document.getElementById('usuario-id').value;
            const formData = {
                empresa_id: document.getElementById('usuario-empresa-id').value,
                empleado_id: document.getElementById('empleado_id').value || null,
                username: document.getElementById('username').value,
                email: document.getElementById('usuario-email').value,
                password_hash: document.getElementById('password').value, // En producción, hashear esto
                salt: 'salt_temp', // En producción, generar salt único
                rol_sistema: document.getElementById('rol_sistema').value,
                nivel_acceso: parseInt(document.getElementById('nivel_acceso').value),
                cuenta_activada: document.getElementById('cuenta_activada').value === 'true',
                permisos: JSON.parse(document.getElementById('permisos').value || '[]'),
                configuracion_usuario: JSON.parse(document.getElementById('configuracion_usuario').value || '{}'),
                creado_por: currentUser.id
            };
            
            try {
                if (usuarioId) {
                    // Actualizar usuario existente (no actualizar contraseña si está vacía)
                    if (!formData.password_hash) {
                        delete formData.password_hash;
                        delete formData.salt;
                    }
                    
                    const { error } = await supabase
                        .from('usuarios')
                        .update(formData)
                        .eq('id', usuarioId);
                    
                    if (error) throw error;
                    
                    alert('Usuario actualizado correctamente');
                } else {
                    // Crear nuevo usuario
                    const { error } = await supabase
                        .from('usuarios')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    alert('Usuario creado correctamente');
                }
                
                usuarioModal.style.display = 'none';
                loadUsuarios();
                
            } catch (error) {
                console.error('Error guardando usuario:', error);
                alert('Error al guardar usuario: ' + error.message);
            }
        });
        
        // Editar empresa
        window.editEmpresa = async function(id) {
            try {
                const { data: empresa, error } = await supabase
                    .from('empresas')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('empresa-modal-title').textContent = 'Editar Empresa';
                document.getElementById('empresa-id').value = empresa.id;
                document.getElementById('codigo_empresa').value = empresa.codigo_empresa;
                document.getElementById('nombre_legal').value = empresa.nombre_legal;
                document.getElementById('nombre_comercial').value = empresa.nombre_comercial || '';
                document.getElementById('rut_nit_identificacion').value = empresa.rut_nit_identificacion || '';
                document.getElementById('pais').value = empresa.pais;
                document.getElementById('ciudad').value = empresa.ciudad || '';
                document.getElementById('direccion').value = empresa.direccion || '';
                document.getElementById('telefono').value = empresa.telefono || '';
                document.getElementById('email').value = empresa.email || '';
                document.getElementById('moneda_principal').value = empresa.moneda_principal;
                document.getElementById('moneda_alternativa').value = empresa.moneda_alternativa || '';
                document.getElementById('zona_horaria').value = empresa.zona_horaria;
                document.getElementById('activa').value = empresa.activa.toString();
                document.getElementById('configuracion').value = JSON.stringify(empresa.configuracion || {});
                
                document.getElementById('eliminar-empresa-btn').style.display = 'inline-block';
                empresaModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error cargando empresa:', error);
                alert('Error al cargar empresa');
            }
        };
        
        // Eliminar empresa
        window.deleteEmpresa = async function(id, nombre) {
            if (confirm(`¿Estás seguro de eliminar la empresa "${nombre}"? Esta acción no se puede deshacer.`)) {
                try {
                    const { error } = await supabase
                        .from('empresas')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    alert('Empresa eliminada correctamente');
                    loadEmpresas();
                    
                } catch (error) {
                    console.error('Error eliminando empresa:', error);
                    alert('Error al eliminar empresa: ' + error.message);
                }
            }
        };
        
        // Editar usuario
        window.editUsuario = async function(id) {
            try {
                const { data: usuario, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Cargar empresas para el select
                await loadEmpresasForSelect();
                
                document.getElementById('usuario-modal-title').textContent = 'Editar Usuario';
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-empresa-id').value = usuario.empresa_id;
                document.getElementById('empleado_id').value = usuario.empleado_id || '';
                document.getElementById('username').value = usuario.username;
                document.getElementById('usuario-email').value = usuario.email;
                document.getElementById('password').value = ''; // No mostrar contraseña actual
                document.getElementById('rol_sistema').value = usuario.rol_sistema;
                document.getElementById('nivel_acceso').value = usuario.nivel_acceso;
                document.getElementById('cuenta_activada').value = usuario.cuenta_activada.toString();
                document.getElementById('permisos').value = JSON.stringify(usuario.permisos || []);
                document.getElementById('configuracion_usuario').value = JSON.stringify(usuario.configuracion_usuario || {});
                
                document.getElementById('eliminar-usuario-btn').style.display = 'inline-block';
                usuarioModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error cargando usuario:', error);
                alert('Error al cargar usuario');
            }
        };
        
        // Eliminar usuario (soft delete)
        window.deleteUsuario = async function(id, username) {
            if (confirm(`¿Estás seguro de eliminar el usuario "${username}"?`)) {
                try {
                    const { error } = await supabase
                        .from('usuarios')
                        .update({ eliminado: true, fecha_eliminacion: new Date().toISOString() })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    alert('Usuario eliminado correctamente');
                    loadUsuarios();
                    
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    alert('Error al eliminar usuario: ' + error.message);
                }
            }
        };
        
        // Botón eliminar empresa en modal
        document.getElementById('eliminar-empresa-btn').addEventListener('click', function() {
            const empresaId = document.getElementById('empresa-id').value;
            const nombre = document.getElementById('nombre_legal').value;
            
            if (empresaId && confirm(`¿Estás seguro de eliminar la empresa "${nombre}"?`)) {
                deleteEmpresa(empresaId, nombre);
                empresaModal.style.display = 'none';
            }
        });
        
        // Botón eliminar usuario en modal
        document.getElementById('eliminar-usuario-btn').addEventListener('click', function() {
            const usuarioId = document.getElementById('usuario-id').value;
            const username = document.getElementById('username').value;
            
            if (usuarioId && confirm(`¿Estás seguro de eliminar el usuario "${username}"?`)) {
                deleteUsuario(usuarioId, username);
                usuarioModal.style.display = 'none';
            }
        });
        
        // Inicializar
        if (checkSession()) {
            loadEmpresas();
        }
    </script>
</body>
</html>
