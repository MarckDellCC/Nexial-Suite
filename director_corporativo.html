<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Panel de Control</title>
    <!-- Supabase JS SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header y navegación */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #2c3e50;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab:hover {
            background-color: #e0e0e0;
        }
        
        .tab.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        /* Contenido de las pestañas */
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Controles de la tabla */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            max-width: 100%;
        }
        
        .add-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .add-btn:hover {
            background-color: #27ae60;
        }
        
        /* Tablas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table th {
            background-color: #3498db;
            color: white;
            text-align: left;
            padding: 12px;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #e67e22;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 5px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-title {
            font-size: 20px;
            color: #2c3e50;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close-btn:hover {
            color: #34495e;
        }
        
        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-col {
            flex: 1;
            min-width: 200px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .submit-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .submit-btn {
            background-color: #3498db;
            color: white;
        }
        
        .submit-btn:hover {
            background-color: #2980b9;
        }
        
        .cancel-btn {
            background-color: #95a5a6;
            color: white;
        }
        
        .cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        /* Mensajes de estado */
        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        /* Responsividad */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .data-table {
                font-size: 14px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 5px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Panel de Control - Director Corporativo</h1>
            <div class="user-info">
                <span id="userEmail">Cargando...</span>
                <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
            </div>
        </div>
        
        <!-- Mensajes de estado -->
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Tabs de navegación -->
        <div class="tabs">
            <button class="tab active" data-tab="empresas">Empresas</button>
            <button class="tab" data-tab="usuarios">Usuarios</button>
            <button class="tab" data-tab="empleados">Empleados</button>
            <button class="tab" data-tab="clientes">Clientes</button>
            <button class="tab" data-tab="productos">Productos</button>
            <button class="tab" data-tab="ventas">Ventas</button>
            <button class="tab" data-tab="inventario">Inventario</button>
        </div>
        
        <!-- Contenido de las pestañas -->
        <div id="empresas" class="tab-content active">
            <div class="table-controls">
                <input type="text" id="searchEmpresas" class="search-box" placeholder="Buscar empresas...">
                <button class="add-btn" id="addEmpresaBtn">+ Nueva Empresa</button>
            </div>
            <div id="empresasTableContainer">
                <div class="loading">Cargando empresas...</div>
            </div>
        </div>
        
        <div id="usuarios" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchUsuarios" class="search-box" placeholder="Buscar usuarios...">
                <button class="add-btn" id="addUsuarioBtn">+ Nuevo Usuario</button>
            </div>
            <div id="usuariosTableContainer">
                <div class="loading">Cargando usuarios...</div>
            </div>
        </div>
        
        <div id="empleados" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchEmpleados" class="search-box" placeholder="Buscar empleados...">
                <button class="add-btn" id="addEmpleadoBtn">+ Nuevo Empleado</button>
            </div>
            <div id="empleadosTableContainer">
                <div class="loading">Cargando empleados...</div>
            </div>
        </div>
        
        <div id="clientes" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchClientes" class="search-box" placeholder="Buscar clientes...">
                <button class="add-btn" id="addClienteBtn">+ Nuevo Cliente</button>
            </div>
            <div id="clientesTableContainer">
                <div class="loading">Cargando clientes...</div>
            </div>
        </div>
        
        <div id="productos" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchProductos" class="search-box" placeholder="Buscar productos...">
                <button class="add-btn" id="addProductoBtn">+ Nuevo Producto</button>
            </div>
            <div id="productosTableContainer">
                <div class="loading">Cargando productos...</div>
            </div>
        </div>
        
        <div id="ventas" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchVentas" class="search-box" placeholder="Buscar ventas...">
                <button class="add-btn" id="addVentaBtn">+ Nueva Venta</button>
            </div>
            <div id="ventasTableContainer">
                <div class="loading">Cargando ventas...</div>
            </div>
        </div>
        
        <div id="inventario" class="tab-content">
            <div class="table-controls">
                <input type="text" id="searchInventario" class="search-box" placeholder="Buscar inventario...">
                <button class="add-btn" id="addInventarioBtn">+ Nuevo Registro</button>
            </div>
            <div id="inventarioTableContainer">
                <div class="loading">Cargando inventario...</div>
            </div>
        </div>
    </div>
    
    <!-- Modal para formularios -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Formulario</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="modalForm">
                <div id="formFields">
                    <!-- Los campos del formulario se generarán dinámicamente aquí -->
                </div>
                <div class="form-buttons">
                    <button type="submit" class="submit-btn" id="submitFormBtn">Guardar</button>
                    <button type="button" class="cancel-btn" id="cancelFormBtn">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variables globales
        let currentUser = null;
        let currentTable = '';
        let currentAction = 'add'; // 'add' o 'edit'
        let currentEditId = null;
        let empresasData = [];
        let monedasData = [];
        let categoriasNegociosData = [];
        let categoriasProductosData = [];
        let almacenesData = [];
        
        // Elementos DOM
        const statusMessage = document.getElementById('statusMessage');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalForm = document.getElementById('modalForm');
        const formFields = document.getElementById('formFields');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelFormBtn = document.getElementById('cancelFormBtn');
        
        // Estructuras de datos para formularios
        const formSchemas = {
            empresas: [
                { name: 'nombre', label: 'Nombre', type: 'text', required: true },
                { name: 'rfc', label: 'RFC', type: 'text', required: true },
                { name: 'direccion', label: 'Dirección', type: 'textarea' },
                { name: 'telefono', label: 'Teléfono', type: 'text' },
                { name: 'email', label: 'Email', type: 'email' },
                { name: 'website', label: 'Website', type: 'text' },
                { name: 'moneda_id', label: 'Moneda', type: 'select', options: [] },
                { name: 'logo_url', label: 'URL del Logo', type: 'text' },
                { name: 'tipo_empresa', label: 'Tipo de Empresa', type: 'text' },
                { name: 'regimen_fiscal', label: 'Régimen Fiscal', type: 'text' },
                { name: 'activo', label: 'Activo', type: 'checkbox', default: true }
            ],
            usuarios: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'empleado_id', label: 'Empleado', type: 'select', options: [] },
                { name: 'nombres', label: 'Nombres', type: 'text', required: true },
                { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true },
                { name: 'apellido_materno', label: 'Apellido Materno', type: 'text' },
                { name: 'email', label: 'Email', type: 'email', required: true },
                { name: 'usuario', label: 'Usuario', type: 'text', required: true },
                { name: 'contrasena_plano', label: 'Contraseña', type: 'password', required: true },
                { name: 'rol', label: 'Rol', type: 'text', required: true },
                { name: 'foto_url', label: 'URL de Foto', type: 'text' },
                { name: 'activo', label: 'Activo', type: 'checkbox', default: true }
            ],
            empleados: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'nombres', label: 'Nombres', type: 'text', required: true },
                { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true },
                { name: 'apellido_materno', label: 'Apellido Materno', type: 'text' },
                { name: 'documento_identidad', label: 'Documento de Identidad', type: 'text' },
                { name: 'tipo_documento', label: 'Tipo de Documento', type: 'text' },
                { name: 'direccion', label: 'Dirección', type: 'textarea' },
                { name: 'telefono', label: 'Teléfono', type: 'text' },
                { name: 'email', label: 'Email', type: 'email' },
                { name: 'fecha_nacimiento', label: 'Fecha de Nacimiento', type: 'date' },
                { name: 'genero', label: 'Género', type: 'text' },
                { name: 'foto_url', label: 'URL de Foto', type: 'text' },
                { name: 'fecha_contratacion', label: 'Fecha de Contratación', type: 'date' },
                { name: 'salario_base', label: 'Salario Base', type: 'number', step: '0.01' },
                { name: 'moneda_id', label: 'Moneda', type: 'select', options: [] },
                { name: 'tipo_contrato', label: 'Tipo de Contrato', type: 'text' },
                { name: 'activo', label: 'Activo', type: 'checkbox', default: true }
            ],
            clientes: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'categoria_negocio_id', label: 'Categoría de Negocio', type: 'select', options: [] },
                { name: 'nombres', label: 'Nombres', type: 'text', required: true },
                { name: 'apellido_paterno', label: 'Apellido Paterno', type: 'text', required: true },
                { name: 'apellido_materno', label: 'Apellido Materno', type: 'text' },
                { name: 'documento_identidad', label: 'Documento de Identidad', type: 'text' },
                { name: 'tipo_documento', label: 'Tipo de Documento', type: 'text' },
                { name: 'ciudad', label: 'Ciudad', type: 'text' },
                { name: 'estado', label: 'Estado', type: 'text' },
                { name: 'pais', label: 'País', type: 'text' },
                { name: 'codigo_postal', label: 'Código Postal', type: 'text' },
                { name: 'telefono', label: 'Teléfono', type: 'text' },
                { name: 'email', label: 'Email', type: 'email' },
                { name: 'fecha_nacimiento', label: 'Fecha de Nacimiento', type: 'date' },
                { name: 'genero', label: 'Género', type: 'text' },
                { name: 'foto_url', label: 'URL de Foto', type: 'text' },
                { name: 'direcciones', label: 'Direcciones (JSON)', type: 'textarea', default: '[]' },
                { name: 'horarios_apertura', label: 'Horarios de Apertura (JSON)', type: 'textarea', default: '[]' },
                { name: 'tipo_cliente', label: 'Tipo de Cliente', type: 'text' },
                { name: 'limite_credito', label: 'Límite de Crédito', type: 'number', step: '0.01' },
                { name: 'dias_credito', label: 'Días de Crédito', type: 'number' },
                { name: 'activo', label: 'Activo', type: 'checkbox', default: true }
            ],
            productos: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'codigo', label: 'Código', type: 'text', required: true },
                { name: 'nombre', label: 'Nombre', type: 'text', required: true },
                { name: 'descripcion', label: 'Descripción', type: 'textarea' },
                { name: 'categoria_id', label: 'Categoría', type: 'select', options: [] },
                { name: 'precio_compra', label: 'Precio de Compra', type: 'number', step: '0.01' },
                { name: 'precio_venta', label: 'Precio de Venta', type: 'number', step: '0.01', required: true },
                { name: 'moneda_id', label: 'Moneda', type: 'select', options: [], required: true },
                { name: 'imagen_url', label: 'URL de Imagen', type: 'text' },
                { name: 'peso', label: 'Peso', type: 'number', step: '0.01' },
                { name: 'dimensiones', label: 'Dimensiones', type: 'text' },
                { name: 'unidad_medida', label: 'Unidad de Medida', type: 'text' },
                { name: 'es_producto_clave', label: 'Es Producto Clave', type: 'checkbox' },
                { name: 'compra_minima_cantidad', label: 'Compra Mínima (Cantidad)', type: 'number', default: 1 },
                { name: 'compra_minima_monto', label: 'Compra Mínima (Monto)', type: 'number', step: '0.01', default: 0 },
                { name: 'compra_minima_peso', label: 'Compra Mínima (Peso)', type: 'number', step: '0.01', default: 0 },
                { name: 'codigo_barras', label: 'Código de Barras', type: 'text' },
                { name: 'ubicacion_almacen', label: 'Ubicación en Almacén', type: 'text' },
                { name: 'activo', label: 'Activo', type: 'checkbox', default: true }
            ],
            ventas: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'cliente_id', label: 'Cliente', type: 'select', options: [], required: true },
                { name: 'empleado_id', label: 'Empleado', type: 'select', options: [] },
                { name: 'almacen_id', label: 'Almacén', type: 'select', options: [] },
                { name: 'numero_venta', label: 'Número de Venta', type: 'text', required: true },
                { name: 'fecha', label: 'Fecha', type: 'datetime-local' },
                { name: 'subtotal', label: 'Subtotal', type: 'number', step: '0.01', required: true },
                { name: 'impuesto', label: 'Impuesto', type: 'number', step: '0.01', required: true },
                { name: 'total', label: 'Total', type: 'number', step: '0.01', required: true },
                { name: 'moneda_id', label: 'Moneda', type: 'select', options: [], required: true },
                { name: 'estado', label: 'Estado', type: 'text', default: 'pendiente' },
                { name: 'metodo_pago', label: 'Método de Pago', type: 'text' },
                { name: 'tipo_venta', label: 'Tipo de Venta', type: 'text' },
                { name: 'observaciones', label: 'Observaciones', type: 'textarea' }
            ],
            inventario: [
                { name: 'empresa_id', label: 'Empresa', type: 'select', options: [], required: true },
                { name: 'producto_id', label: 'Producto', type: 'select', options: [], required: true },
                { name: 'almacen_id', label: 'Almacén', type: 'select', options: [], required: true },
                { name: 'lote', label: 'Lote', type: 'text' },
                { name: 'fecha_vencimiento', label: 'Fecha de Vencimiento', type: 'date' },
                { name: 'cantidad', label: 'Cantidad', type: 'number', required: true, default: 0 },
                { name: 'cantidad_minima', label: 'Cantidad Mínima', type: 'number', default: 10 },
                { name: 'cantidad_maxima', label: 'Cantidad Máxima', type: 'number' },
                { name: 'ubicacion', label: 'Ubicación', type: 'text' },
                { name: 'estado_stock', label: 'Estado del Stock', type: 'text' }
            ]
        };
        
        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticación y rol
            await checkAuthAndRole();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Cargar datos de referencia
            await loadReferenceData();
            
            // Cargar datos iniciales
            loadTableData('empresas');
        });
        
        // Verificar autenticación y rol del usuario
        async function checkAuthAndRole() {
            try {
                // Obtener sesión actual
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (!session) {
                    // No hay sesión, redirigir al login
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = session.user;
                userEmail.textContent = currentUser.email;
                
                // Verificar rol del usuario en la tabla usuarios
                const { data: usuarioData, error: usuarioError } = await supabase
                    .from('usuarios')
                    .select('rol')
                    .eq('email', currentUser.email)
                    .single();
                
                if (usuarioError) {
                    showError('Error al verificar rol de usuario: ' + usuarioError.message);
                    // Forzar logout si no se puede verificar el rol
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }
                
                // Verificar si el usuario es Director Corporativo
                if (usuarioData.rol !== 'Director Corporativo') {
                    showError('Acceso denegado. Solo usuarios con rol "Director Corporativo" pueden acceder a esta página.');
                    // Redirigir después de 3 segundos
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                    return;
                }
                
                // Mostrar mensaje de bienvenida
                showSuccess(`Bienvenido, Director Corporativo (${currentUser.email})`);
                
            } catch (error) {
                console.error('Error en autenticación:', error);
                showError('Error de autenticación: ' + error.message);
                window.location.href = 'login.html';
            }
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Botón de logout
            logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            });
            
            // Botones para agregar nuevos registros
            document.getElementById('addEmpresaBtn').addEventListener('click', () => openModal('empresas', 'add'));
            document.getElementById('addUsuarioBtn').addEventListener('click', () => openModal('usuarios', 'add'));
            document.getElementById('addEmpleadoBtn').addEventListener('click', () => openModal('empleados', 'add'));
            document.getElementById('addClienteBtn').addEventListener('click', () => openModal('clientes', 'add'));
            document.getElementById('addProductoBtn').addEventListener('click', () => openModal('productos', 'add'));
            document.getElementById('addVentaBtn').addEventListener('click', () => openModal('ventas', 'add'));
            document.getElementById('addInventarioBtn').addEventListener('click', () => openModal('inventario', 'add'));
            
            // Buscadores
            document.getElementById('searchEmpresas').addEventListener('input', (e) => filterTable('empresas', e.target.value));
            document.getElementById('searchUsuarios').addEventListener('input', (e) => filterTable('usuarios', e.target.value));
            document.getElementById('searchEmpleados').addEventListener('input', (e) => filterTable('empleados', e.target.value));
            document.getElementById('searchClientes').addEventListener('input', (e) => filterTable('clientes', e.target.value));
            document.getElementById('searchProductos').addEventListener('input', (e) => filterTable('productos', e.target.value));
            document.getElementById('searchVentas').addEventListener('input', (e) => filterTable('ventas', e.target.value));
            document.getElementById('searchInventario').addEventListener('input', (e) => filterTable('inventario', e.target.value));
            
            // Modal
            closeModalBtn.addEventListener('click', closeModal);
            cancelFormBtn.addEventListener('click', closeModal);
            
            // Formulario del modal
            modalForm.addEventListener('submit', handleFormSubmit);
        }
        
        // Cargar datos de referencia para selects
        async function loadReferenceData() {
            try {
                // Cargar empresas
                const { data: empresas, error: empresasError } = await supabase
                    .from('empresas')
                    .select('id, nombre')
                    .eq('activo', true)
                    .order('nombre');
                
                if (empresasError) throw empresasError;
                empresasData = empresas;
                
                // Cargar monedas
                const { data: monedas, error: monedasError } = await supabase
                    .from('monedas')
                    .select('id, codigo, nombre')
                    .eq('activo', true)
                    .order('codigo');
                
                if (monedasError) throw monedasError;
                monedasData = monedas;
                
                // Cargar categorías de negocios
                const { data: categoriasNegocios, error: categoriasNegociosError } = await supabase
                    .from('categoria_negocios')
                    .select('id, nombre')
                    .order('nombre');
                
                if (categoriasNegociosError) throw categoriasNegociosError;
                categoriasNegociosData = categoriasNegocios;
                
                // Cargar categorías de productos
                const { data: categoriasProductos, error: categoriasProductosError } = await supabase
                    .from('categoria_productos')
                    .select('id, nombre')
                    .order('nombre');
                
                if (categoriasProductosError) throw categoriasProductosError;
                categoriasProductosData = categoriasProductos;
                
                // Cargar almacenes
                const { data: almacenes, error: almacenesError } = await supabase
                    .from('almacenes')
                    .select('id, nombre')
                    .eq('activo', true)
                    .order('nombre');
                
                if (almacenesError) throw almacenesError;
                almacenesData = almacenes;
                
                // Actualizar opciones en los esquemas de formularios
                updateFormSelectOptions();
                
            } catch (error) {
                console.error('Error cargando datos de referencia:', error);
                showError('Error cargando datos de referencia: ' + error.message);
            }
        }
        
        // Actualizar opciones de select en los esquemas de formularios
        function updateFormSelectOptions() {
            // Empresas
            formSchemas.usuarios.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            formSchemas.empleados.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            formSchemas.clientes.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            formSchemas.productos.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            formSchemas.ventas.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            formSchemas.inventario.find(f => f.name === 'empresa_id').options = empresasData.map(e => ({ value: e.id, label: e.nombre }));
            
            // Monedas
            formSchemas.empresas.find(f => f.name === 'moneda_id').options = monedasData.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
            formSchemas.empleados.find(f => f.name === 'moneda_id').options = monedasData.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
            formSchemas.productos.find(f => f.name === 'moneda_id').options = monedasData.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
            formSchemas.ventas.find(f => f.name === 'moneda_id').options = monedasData.map(m => ({ value: m.id, label: `${m.codigo} - ${m.nombre}` }));
            
            // Categorías de negocios
            formSchemas.clientes.find(f => f.name === 'categoria_negocio_id').options = categoriasNegociosData.map(c => ({ value: c.id, label: c.nombre }));
            
            // Categorías de productos
            formSchemas.productos.find(f => f.name === 'categoria_id').options = categoriasProductosData.map(c => ({ value: c.id, label: c.nombre }));
            
            // Almacenes
            formSchemas.ventas.find(f => f.name === 'almacen_id').options = almacenesData.map(a => ({ value: a.id, label: a.nombre }));
            formSchemas.inventario.find(f => f.name === 'almacen_id').options = almacenesData.map(a => ({ value: a.id, label: a.nombre }));
        }
        
        // Cambiar entre pestañas
        function switchTab(tabId) {
            // Actualizar tabs activos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Actualizar contenido activo
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
            
            // Cargar datos de la tabla si no se han cargado todavía
            const tableContainer = document.getElementById(`${tabId}TableContainer`);
            if (tableContainer.innerHTML.includes('Cargando')) {
                loadTableData(tabId);
            }
        }
        
        // Cargar datos de una tabla específica
        async function loadTableData(tableName) {
            try {
                const tableContainer = document.getElementById(`${tableName}TableContainer`);
                tableContainer.innerHTML = '<div class="loading">Cargando datos...</div>';
                
                let query = supabase
                    .from(tableName)
                    .select('*');
                
                // Para tablas con relaciones, incluir datos relacionados
                if (tableName === 'usuarios') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        empleados(nombres, apellido_paterno)
                    `);
                } else if (tableName === 'empleados') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        monedas(codigo, nombre)
                    `);
                } else if (tableName === 'clientes') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        categoria_negocios(nombre)
                    `);
                } else if (tableName === 'productos') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        categoria_productos(nombre),
                        monedas(codigo, nombre)
                    `);
                } else if (tableName === 'ventas') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        clientes(nombres, apellido_paterno),
                        empleados(nombres, apellido_paterno),
                        almacenes(nombre),
                        monedas(codigo, nombre)
                    `);
                } else if (tableName === 'inventario') {
                    query = query.select(`
                        *,
                        empresas(nombre),
                        productos(nombre, codigo),
                        almacenes(nombre)
                    `);
                }
                
                const { data, error } = await query.order('creado_en', { ascending: false });
                
                if (error) throw error;
                
                // Renderizar la tabla
                renderTable(tableName, data);
                
            } catch (error) {
                console.error(`Error cargando ${tableName}:`, error);
                const tableContainer = document.getElementById(`${tableName}TableContainer`);
                tableContainer.innerHTML = `<div class="error">Error cargando datos: ${error.message}</div>`;
            }
        }
        
        // Renderizar una tabla con datos
        function renderTable(tableName, data) {
            const tableContainer = document.getElementById(`${tableName}TableContainer`);
            
            if (!data || data.length === 0) {
                tableContainer.innerHTML = '<div class="loading">No hay datos disponibles.</div>';
                return;
            }
            
            // Determinar las columnas a mostrar
            const columns = getTableColumns(tableName, data[0]);
            
            // Crear tabla HTML
            let html = `<table class="data-table" id="${tableName}Table">`;
            
            // Encabezados
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col.label}</th>`;
            });
            html += '<th>Acciones</th>';
            html += '</tr></thead>';
            
            // Filas de datos
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col.key];
                    
                    // Formatear valores especiales
                    if (col.type === 'boolean') {
                        value = value ? 'Sí' : 'No';
                    } else if (col.type === 'date' && value) {
                        value = new Date(value).toLocaleDateString();
                    } else if (col.type === 'datetime' && value) {
                        value = new Date(value).toLocaleString();
                    } else if (col.type === 'money' && value) {
                        value = '$' + parseFloat(value).toFixed(2);
                    } else if (col.type === 'relation' && value && typeof value === 'object') {
                        // Para relaciones, mostrar el nombre relacionado
                        value = value.nombre || value.codigo || value.nombres || 'N/A';
                    }
                    
                    html += `<td>${value || ''}</td>`;
                });
                
                // Botones de acción
                html += `<td class="action-btns">
                    <button class="edit-btn" onclick="editRecord('${tableName}', '${row.id}')">Editar</button>
                    <button class="delete-btn" onclick="deleteRecord('${tableName}', '${row.id}')">Eliminar</button>
                </td>`;
                
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            tableContainer.innerHTML = html;
        }
        
        // Obtener columnas para una tabla específica
        function getTableColumns(tableName, sampleRow) {
            const columnConfigs = {
                empresas: [
                    { key: 'nombre', label: 'Nombre' },
                    { key: 'rfc', label: 'RFC' },
                    { key: 'telefono', label: 'Teléfono' },
                    { key: 'email', label: 'Email' },
                    { key: 'tipo_empresa', label: 'Tipo' },
                    { key: 'activo', label: 'Activo', type: 'boolean' },
                    { key: 'creado_en', label: 'Creado', type: 'datetime' }
                ],
                usuarios: [
                    { key: 'nombres', label: 'Nombres' },
                    { key: 'apellido_paterno', label: 'Apellido Paterno' },
                    { key: 'apellido_materno', label: 'Apellido Materno' },
                    { key: 'email', label: 'Email' },
                    { key: 'usuario', label: 'Usuario' },
                    { key: 'rol', label: 'Rol' },
                    { key: 'empresas', label: 'Empresa', type: 'relation' },
                    { key: 'activo', label: 'Activo', type: 'boolean' },
                    { key: 'ultimo_acceso', label: 'Último Acceso', type: 'datetime' }
                ],
                empleados: [
                    { key: 'nombres', label: 'Nombres' },
                    { key: 'apellido_paterno', label: 'Apellido Paterno' },
                    { key: 'apellido_materno', label: 'Apellido Materno' },
                    { key: 'documento_identidad', label: 'Documento' },
                    { key: 'telefono', label: 'Teléfono' },
                    { key: 'email', label: 'Email' },
                    { key: 'empresas', label: 'Empresa', type: 'relation' },
                    { key: 'salario_base', label: 'Salario', type: 'money' },
                    { key: 'activo', label: 'Activo', type: 'boolean' }
                ],
                clientes: [
                    { key: 'nombres', label: 'Nombres' },
                    { key: 'apellido_paterno', label: 'Apellido Paterno' },
                    { key: 'apellido_materno', label: 'Apellido Materno' },
                    { key: 'documento_identidad', label: 'Documento' },
                    { key: 'ciudad', label: 'Ciudad' },
                    { key: 'telefono', label: 'Teléfono' },
                    { key: 'email', label: 'Email' },
                    { key: 'empresas', label: 'Empresa', type: 'relation' },
                    { key: 'limite_credito', label: 'Límite Crédito', type: 'money' },
                    { key: 'activo', label: 'Activo', type: 'boolean' }
                ],
                productos: [
                    { key: 'codigo', label: 'Código' },
                    { key: 'nombre', label: 'Nombre' },
                    { key: 'precio_venta', label: 'Precio Venta', type: 'money' },
                    { key: 'empresas', label: 'Empresa', type: 'relation' },
                    { key: 'categoria_productos', label: 'Categoría', type: 'relation' },
                    { key: 'monedas', label: 'Moneda', type: 'relation' },
                    { key: 'es_producto_clave', label: 'Es Clave', type: 'boolean' },
                    { key: 'activo', label: 'Activo', type: 'boolean' }
                ],
                ventas: [
                    { key: 'numero_venta', label: 'Número' },
                    { key: 'fecha', label: 'Fecha', type: 'datetime' },
                    { key: 'clientes', label: 'Cliente', type: 'relation' },
                    { key: 'total', label: 'Total', type: 'money' },
                    { key: 'monedas', label: 'Moneda', type: 'relation' },
                    { key: 'estado', label: 'Estado' },
                    { key: 'metodo_pago', label: 'Método Pago' },
                    { key: 'creado_en', label: 'Creado', type: 'datetime' }
                ],
                inventario: [
                    { key: 'productos', label: 'Producto', type: 'relation' },
                    { key: 'almacenes', label: 'Almacén', type: 'relation' },
                    { key: 'lote', label: 'Lote' },
                    { key: 'fecha_vencimiento', label: 'Vencimiento', type: 'date' },
                    { key: 'cantidad', label: 'Cantidad' },
                    { key: 'cantidad_minima', label: 'Mínimo' },
                    { key: 'estado_stock', label: 'Estado' },
                    { key: 'actualizado_en', label: 'Actualizado', type: 'datetime' }
                ]
            };
            
            return columnConfigs[tableName] || Object.keys(sampleRow || {}).map(key => ({ key, label: key }));
        }
        
        // Filtrar tabla según búsqueda
        function filterTable(tableName, searchTerm) {
            const table = document.getElementById(`${tableName}Table`);
            if (!table) return;
            
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            searchTerm = searchTerm.toLowerCase();
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                
                row.style.display = found ? '' : 'none';
            }
        }
        
        // Abrir modal para agregar/editar
        async function openModal(tableName, action, recordId = null) {
            currentTable = tableName;
            currentAction = action;
            currentEditId = recordId;
            
            // Establecer título del modal
            modalTitle.textContent = `${action === 'add' ? 'Agregar' : 'Editar'} ${getTableLabel(tableName)}`;
            
            // Limpiar formulario
            formFields.innerHTML = '';
            
            // Obtener esquema del formulario
            const schema = formSchemas[tableName];
            
            // Si es edición, cargar datos del registro
            let recordData = {};
            if (action === 'edit' && recordId) {
                try {
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('*')
                        .eq('id', recordId)
                        .single();
                    
                    if (error) throw error;
                    recordData = data;
                } catch (error) {
                    console.error('Error cargando datos del registro:', error);
                    showError('Error cargando datos del registro: ' + error.message);
                    return;
                }
            }
            
            // Generar campos del formulario
            schema.forEach(field => {
                const fieldId = `${tableName}_${field.name}`;
                let fieldHtml = '';
                
                fieldHtml += `<div class="form-group">`;
                fieldHtml += `<label class="form-label" for="${fieldId}">${field.label}${field.required ? ' *' : ''}</label>`;
                
                const value = recordData[field.name] !== undefined ? recordData[field.name] : (field.default !== undefined ? field.default : '');
                
                switch (field.type) {
                    case 'text':
                    case 'email':
                    case 'password':
                    case 'number':
                    case 'date':
                    case 'datetime-local':
                        fieldHtml += `<input type="${field.type}" id="${fieldId}" name="${field.name}" class="form-input" value="${value || ''}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''}>`;
                        break;
                    
                    case 'textarea':
                        fieldHtml += `<textarea id="${fieldId}" name="${field.name}" class="form-textarea" ${field.required ? 'required' : ''}>${value || ''}</textarea>`;
                        break;
                    
                    case 'select':
                        fieldHtml += `<select id="${fieldId}" name="${field.name}" class="form-select" ${field.required ? 'required' : ''}>`;
                        fieldHtml += `<option value="">Seleccionar...</option>`;
                        if (field.options) {
                            field.options.forEach(option => {
                                const selected = option.value === value ? 'selected' : '';
                                fieldHtml += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                            });
                        }
                        fieldHtml += `</select>`;
                        break;
                    
                    case 'checkbox':
                        const checked = value === true || value === 'true' ? 'checked' : '';
                        fieldHtml += `<div class="checkbox-group">`;
                        fieldHtml += `<input type="checkbox" id="${fieldId}" name="${field.name}" ${checked}>`;
                        fieldHtml += `<label for="${fieldId}">${field.label}</label>`;
                        fieldHtml += `</div>`;
                        break;
                }
                
                fieldHtml += `</div>`;
                formFields.innerHTML += fieldHtml;
            });
            
            // Mostrar modal
            modal.style.display = 'block';
        }
        
        // Cerrar modal
        function closeModal() {
            modal.style.display = 'none';
            currentTable = '';
            currentAction = 'add';
            currentEditId = null;
        }
        
        // Manejar envío del formulario
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Obtener datos del formulario
            const formData = new FormData(modalForm);
            const data = {};
            
            // Recopilar datos según el esquema
            const schema = formSchemas[currentTable];
            schema.forEach(field => {
                if (field.type === 'checkbox') {
                    const checkbox = document.getElementById(`${currentTable}_${field.name}`);
                    data[field.name] = checkbox.checked;
                } else {
                    data[field.name] = formData.get(field.name);
                }
                
                // Convertir tipos de datos
                if (field.type === 'number' && data[field.name]) {
                    data[field.name] = parseFloat(data[field.name]);
                } else if (field.name === 'activo' && typeof data[field.name] !== 'boolean') {
                    data[field.name] = data[field.name] === 'true' || data[field.name] === true;
                }
                
                // Manejar campos JSON
                if ((field.name === 'direcciones' || field.name === 'horarios_apertura') && data[field.name]) {
                    try {
                        data[field.name] = JSON.parse(data[field.name]);
                    } catch (error) {
                        // Si no es JSON válido, mantener como está
                        console.warn(`Campo ${field.name} no es JSON válido`);
                    }
                }
            });
            
            try {
                let result;
                
                if (currentAction === 'add') {
                    // Insertar nuevo registro
                    const { data: newData, error } = await supabase
                        .from(currentTable)
                        .insert([data])
                        .select();
                    
                    if (error) throw error;
                    result = newData;
                    showSuccess(`${getTableLabel(currentTable)} agregado exitosamente.`);
                } else {
                    // Actualizar registro existente
                    const { data: updatedData, error } = await supabase
                        .from(currentTable)
                        .update(data)
                        .eq('id', currentEditId)
                        .select();
                    
                    if (error) throw error;
                    result = updatedData;
                    showSuccess(`${getTableLabel(currentTable)} actualizado exitosamente.`);
                }
                
                // Cerrar modal y recargar tabla
                closeModal();
                loadTableData(currentTable);
                
            } catch (error) {
                console.error('Error guardando datos:', error);
                showError('Error guardando datos: ' + error.message);
            }
        }
        
        // Editar registro
        async function editRecord(tableName, recordId) {
            openModal(tableName, 'edit', recordId);
        }
        
        // Eliminar registro
        async function deleteRecord(tableName, recordId) {
            if (!confirm(`¿Está seguro de eliminar este ${getTableLabel(tableName)}? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', recordId);
                
                if (error) throw error;
                
                showSuccess(`${getTableLabel(tableName)} eliminado exitosamente.`);
                loadTableData(tableName);
                
            } catch (error) {
                console.error('Error eliminando registro:', error);
                showError('Error eliminando registro: ' + error.message);
            }
        }
        
        // Obtener etiqueta para una tabla
        function getTableLabel(tableName) {
            const labels = {
                empresas: 'empresa',
                usuarios: 'usuario',
                empleados: 'empleado',
                clientes: 'cliente',
                productos: 'producto',
                ventas: 'venta',
                inventario: 'registro de inventario'
            };
            
            return labels[tableName] || 'registro';
        }
        
        // Mostrar mensaje de éxito
        function showSuccess(message) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message success';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Mostrar mensaje de error
        function showError(message) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message error';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Hacer funciones globales para los event handlers en los botones
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
    </script>
</body>
</html>
