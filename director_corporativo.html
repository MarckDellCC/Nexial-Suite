<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Panel de Administración</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .user-info {
            text-align: right;
        }
        
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        .control-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .table-selector {
            flex: 1;
            min-width: 250px;
        }
        
        .table-selector select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .data-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .table-actions {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .form-section {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .hidden {
            display: none;
        }
        
        .status-active {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .page-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 14px;
            }
            
            .table-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo">DIRECTOR CORPORATIVO</div>
                <div class="user-role" id="userRole">Cargando rol...</div>
            </div>
            <div class="user-info">
                <div id="userEmail">usuario@empresa.com</div>
                <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
            </div>
        </header>
        
        <div id="accessDenied" class="hidden">
            <div class="alert alert-danger">
                <h2>Acceso Denegado</h2>
                <p>No tienes permisos para acceder a esta sección. Solo los usuarios con rol "Director Corporativo" pueden acceder.</p>
                <p>Tu rol actual es: <span id="currentRole"></span></p>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">Volver al Inicio</button>
            </div>
        </div>
        
        <div id="adminPanel" class="hidden">
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="empresasCount">0</div>
                    <div class="stat-label">Empresas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="usuariosCount">0</div>
                    <div class="stat-label">Usuarios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="empleadosCount">0</div>
                    <div class="stat-label">Empleados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="clientesCount">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="table-selector">
                    <select id="tableSelector">
                        <option value="">Selecciona una tabla</option>
                        <option value="empresas">Empresas</option>
                        <option value="usuarios">Usuarios</option>
                        <option value="empleados">Empleados</option>
                        <option value="clientes">Clientes</option>
                        <option value="productos">Productos</option>
                        <option value="categoria_productos">Categorías de Productos</option>
                        <option value="almacenes">Almacenes</option>
                        <option value="inventario">Inventario</option>
                        <option value="monedas">Monedas</option>
                        <option value="categoria_negocios">Categorías de Negocios</option>
                        <option value="departamentos">Departamentos</option>
                        <option value="areas">Áreas</option>
                        <option value="ventas">Ventas</option>
                        <option value="detalle_ventas">Detalle de Ventas</option>
                        <option value="pagos">Pagos</option>
                        <option value="comisiones">Comisiones</option>
                        <option value="rutas_distribucion">Rutas de Distribución</option>
                        <option value="zonas_geograficas">Zonas Geográficas</option>
                        <option value="niveles_antiguedad">Niveles de Antigüedad</option>
                        <option value="metas">Metas</option>
                        <option value="objetivos">Objetivos</option>
                        <option value="metricas_empleados">Métricas de Empleados</option>
                        <option value="beneficios_clientes">Beneficios de Clientes</option>
                        <option value="comportamiento_clientes">Comportamiento de Clientes</option>
                        <option value="analisis_mercado">Análisis de Mercado</option>
                        <option value="campanas_marketing">Campañas de Marketing</option>
                        <option value="eventos_externos">Eventos Externos</option>
                        <option value="historico_precios">Histórico de Precios</option>
                        <option value="incidencias_ventas">Incidencias de Ventas</option>
                        <option value="solicitudes_cambios">Solicitudes de Cambios</option>
                        <option value="auditoria">Auditoría</option>
                        <option value="configuraciones_empresa">Configuraciones de Empresa</option>
                        <option value="registros_vencimientos">Registros de Vencimientos</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="loadTableBtn">Cargar Tabla</button>
                    <button class="btn btn-success" id="newRecordBtn">Nuevo Registro</button>
                    <button class="btn btn-warning" id="refreshDataBtn">Actualizar Datos</button>
                </div>
            </div>
            
            <div class="alert hidden" id="messageAlert"></div>
            
            <div class="data-section">
                <div class="loading" id="tableLoading">Cargando datos...</div>
                <div id="tableContainer"></div>
                <div class="pagination" id="pagination"></div>
            </div>
            
            <div class="form-section hidden" id="formSection">
                <h3 id="formTitle">Nuevo Registro</h3>
                <form id="dataForm">
                    <div class="form-grid" id="formFields"></div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Guardar</button>
                        <button type="button" class="btn btn-danger" id="cancelBtn">Cancelar</button>
                        <button type="button" class="btn btn-warning hidden" id="deleteBtn">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const supabaseKey = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variables de estado
        let currentUser = null;
        let currentTable = '';
        let currentData = [];
        let currentRecordId = null;
        let currentPage = 1;
        const recordsPerPage = 20;
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar si el usuario está autenticado
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                // Redirigir al login si no hay sesión
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = session.user;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            // Obtener el rol del usuario desde la tabla usuarios
            await checkUserRole();
            
            // Configurar eventos
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('loadTableBtn').addEventListener('click', loadTableData);
            document.getElementById('newRecordBtn').addEventListener('click', showNewForm);
            document.getElementById('refreshDataBtn').addEventListener('click', refreshData);
            document.getElementById('cancelBtn').addEventListener('click', hideForm);
            document.getElementById('deleteBtn').addEventListener('click', deleteRecord);
            document.getElementById('dataForm').addEventListener('submit', saveRecord);
            
            // Cargar estadísticas iniciales
            loadStatistics();
        });
        
        // Verificar el rol del usuario
        async function checkUserRole() {
            try {
                // Buscar al usuario en la tabla usuarios por email
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('rol')
                    .eq('email', currentUser.email)
                    .single();
                
                if (error || !data) {
                    showMessage('No se pudo verificar tu rol. Contacta al administrador.', 'danger');
                    document.getElementById('currentRole').textContent = 'No encontrado';
                    return;
                }
                
                const userRole = data.rol;
                document.getElementById('userRole').textContent = `Rol: ${userRole}`;
                document.getElementById('currentRole').textContent = userRole;
                
                // Verificar si es Director Corporativo
                if (userRole === 'Director Corporativo') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                } else {
                    document.getElementById('accessDenied').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error al verificar rol:', error);
                document.getElementById('accessDenied').classList.remove('hidden');
            }
        }
        
        // Cargar estadísticas
        async function loadStatistics() {
            try {
                // Contar empresas
                const { count: empresasCount } = await supabase
                    .from('empresas')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('empresasCount').textContent = empresasCount || 0;
                
                // Contar usuarios
                const { count: usuariosCount } = await supabase
                    .from('usuarios')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('usuariosCount').textContent = usuariosCount || 0;
                
                // Contar empleados
                const { count: empleadosCount } = await supabase
                    .from('empleados')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('empleadosCount').textContent = empleadosCount || 0;
                
                // Contar clientes
                const { count: clientesCount } = await supabase
                    .from('clientes')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('clientesCount').textContent = clientesCount || 0;
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }
        
        // Cargar datos de la tabla seleccionada
        async function loadTableData() {
            const tableSelect = document.getElementById('tableSelector');
            currentTable = tableSelect.value;
            
            if (!currentTable) {
                showMessage('Selecciona una tabla primero', 'warning');
                return;
            }
            
            document.getElementById('tableLoading').classList.remove('hidden');
            document.getElementById('tableContainer').innerHTML = '';
            document.getElementById('pagination').innerHTML = '';
            
            try {
                // Obtener datos de la tabla
                const { data, error, count } = await supabase
                    .from(currentTable)
                    .select('*', { count: 'exact' })
                    .order('creado_en', { ascending: false })
                    .range((currentPage - 1) * recordsPerPage, currentPage * recordsPerPage - 1);
                
                if (error) throw error;
                
                currentData = data || [];
                
                // Obtener información de las columnas
                const columns = await getTableColumns(currentTable);
                
                // Mostrar los datos
                displayTableData(currentData, columns);
                
                // Mostrar paginación si hay muchos registros
                if (count > recordsPerPage) {
                    displayPagination(count);
                }
                
                showMessage(`Se cargaron ${currentData.length} registros de la tabla ${currentTable}`, 'success');
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showMessage(`Error al cargar datos: ${error.message}`, 'danger');
            } finally {
                document.getElementById('tableLoading').classList.add('hidden');
            }
        }
        
        // Obtener información de columnas de una tabla
        async function getTableColumns(tableName) {
            // Mapeo de tipos de datos para mostrar controles adecuados en el formulario
            const typeMapping = {
                'uuid': 'text',
                'text': 'textarea',
                'varchar': 'text',
                'boolean': 'checkbox',
                'integer': 'number',
                'decimal': 'number',
                'numeric': 'number',
                'date': 'date',
                'timestamp': 'datetime-local',
                'jsonb': 'textarea'
            };
            
            // Para simplificar, definimos las columnas principales de cada tabla
            // En un sistema real, esto se obtendría de information_schema.columns
            const tableColumns = {
                'empresas': [
                    { name: 'id', type: 'uuid', required: false, pk: true },
                    { name: 'nombre', type: 'varchar', required: true },
                    { name: 'rfc', type: 'varchar', required: true },
                    { name: 'direccion', type: 'text', required: false },
                    { name: 'telefono', type: 'varchar', required: false },
                    { name: 'email', type: 'varchar', required: false },
                    { name: 'website', type: 'varchar', required: false },
                    { name: 'moneda_id', type: 'uuid', required: false, fk: 'monedas' },
                    { name: 'logo_url', type: 'text', required: false },
                    { name: 'tipo_empresa', type: 'varchar', required: false },
                    { name: 'regimen_fiscal', type: 'varchar', required: false },
                    { name: 'activo', type: 'boolean', required: false },
                    { name: 'creado_en', type: 'timestamp', required: false },
                    { name: 'actualizado_en', type: 'timestamp', required: false }
                ],
                'usuarios': [
                    { name: 'id', type: 'uuid', required: false, pk: true },
                    { name: 'empresa_id', type: 'uuid', required: true, fk: 'empresas' },
                    { name: 'empleado_id', type: 'uuid', required: false, fk: 'empleados' },
                    { name: 'nombres', type: 'varchar', required: true },
                    { name: 'apellido_paterno', type: 'varchar', required: true },
                    { name: 'apellido_materno', type: 'varchar', required: false },
                    { name: 'email', type: 'varchar', required: true },
                    { name: 'usuario', type: 'varchar', required: true },
                    { name: 'contrasena_plano', type: 'varchar', required: true },
                    { name: 'rol', type: 'varchar', required: true },
                    { name: 'foto_url', type: 'text', required: false },
                    { name: 'activo', type: 'boolean', required: false },
                    { name: 'ultimo_acceso', type: 'timestamp', required: false },
                    { name: 'creado_en', type: 'timestamp', required: false },
                    { name: 'actualizado_en', type: 'timestamp', required: false }
                ],
                'clientes': [
                    { name: 'id', type: 'uuid', required: false, pk: true },
                    { name: 'empresa_id', type: 'uuid', required: true, fk: 'empresas' },
                    { name: 'categoria_negocio_id', type: 'uuid', required: false, fk: 'categoria_negocios' },
                    { name: 'nombres', type: 'varchar', required: true },
                    { name: 'apellido_paterno', type: 'varchar', required: true },
                    { name: 'apellido_materno', type: 'varchar', required: false },
                    { name: 'documento_identidad', type: 'varchar', required: false },
                    { name: 'tipo_documento', type: 'varchar', required: false },
                    { name: 'ciudad', type: 'varchar', required: false },
                    { name: 'estado', type: 'varchar', required: false },
                    { name: 'pais', type: 'varchar', required: false },
                    { name: 'codigo_postal', type: 'varchar', required: false },
                    { name: 'telefono', type: 'varchar', required: false },
                    { name: 'email', type: 'varchar', required: false },
                    { name: 'fecha_nacimiento', type: 'date', required: false },
                    { name: 'genero', type: 'varchar', required: false },
                    { name: 'foto_url', type: 'text', required: false },
                    { name: 'direcciones', type: 'jsonb', required: false },
                    { name: 'horarios_apertura', type: 'jsonb', required: false },
                    { name: 'tipo_cliente', type: 'varchar', required: false },
                    { name: 'limite_credito', type: 'decimal', required: false },
                    { name: 'dias_credito', type: 'integer', required: false },
                    { name: 'activo', type: 'boolean', required: false },
                    { name: 'creado_en', type: 'timestamp', required: false },
                    { name: 'actualizado_en', type: 'timestamp', required: false }
                ]
            };
            
            // Si tenemos definición para esta tabla, la devolvemos
            if (tableColumns[tableName]) {
                return tableColumns[tableName].map(col => ({
                    ...col,
                    inputType: typeMapping[col.type] || 'text'
                }));
            }
            
            // Para tablas no definidas, usamos un enfoque genérico
            // Obtenemos la primera fila para inferir las columnas
            const { data } = await supabase
                .from(tableName)
                .select('*')
                .limit(1);
            
            if (data && data.length > 0) {
                return Object.keys(data[0]).map(key => ({
                    name: key,
                    type: typeof data[0][key] === 'boolean' ? 'boolean' : 
                          typeof data[0][key] === 'number' ? 'number' :
                          key.includes('fecha') || key.includes('creado') || key.includes('actualizado') ? 'timestamp' :
                          'text',
                    required: false,
                    inputType: typeof data[0][key] === 'boolean' ? 'checkbox' : 
                              typeof data[0][key] === 'number' ? 'number' :
                              key.includes('fecha') || key.includes('creado') || key.includes('actualizado') ? 'datetime-local' :
                              'text'
                }));
            }
            
            return [];
        }
        
        // Mostrar datos en una tabla
        function displayTableData(data, columns) {
            if (data.length === 0) {
                document.getElementById('tableContainer').innerHTML = '<p>No hay registros en esta tabla.</p>';
                return;
            }
            
            let tableHTML = '<table class="data-table"><thead><tr>';
            
            // Encabezados de columna
            columns.forEach(col => {
                tableHTML += `<th>${col.name}</th>`;
            });
            
            tableHTML += '<th>Acciones</th></tr></thead><tbody>';
            
            // Filas de datos
            data.forEach(row => {
                tableHTML += '<tr>';
                
                columns.forEach(col => {
                    const value = row[col.name];
                    let displayValue = value;
                    
                    if (value === null || value === undefined) {
                        displayValue = '<em>NULL</em>';
                    } else if (col.type === 'boolean') {
                        displayValue = value ? 
                            '<span class="status-active">Activo</span>' : 
                            '<span class="status-inactive">Inactivo</span>';
                    } else if (col.type === 'timestamp' || col.type === 'date') {
                        displayValue = new Date(value).toLocaleString();
                    } else if (typeof value === 'object') {
                        displayValue = JSON.stringify(value).substring(0, 50) + '...';
                    } else if (typeof value === 'string' && value.length > 50) {
                        displayValue = value.substring(0, 50) + '...';
                    }
                    
                    tableHTML += `<td>${displayValue}</td>`;
                });
                
                // Botones de acción
                tableHTML += `
                    <td>
                        <div class="table-actions">
                            <button class="action-btn btn-primary" onclick="editRecord('${row.id}')">Editar</button>
                            <button class="action-btn btn-danger" onclick="confirmDelete('${row.id}')">Eliminar</button>
                        </div>
                    </td>
                `;
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }
        
        // Mostrar paginación
        function displayPagination(totalCount) {
            const totalPages = Math.ceil(totalCount / recordsPerPage);
            let paginationHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            document.getElementById('pagination').innerHTML = paginationHTML;
        }
        
        // Ir a una página específica
        function goToPage(page) {
            currentPage = page;
            loadTableData();
        }
        
        // Mostrar formulario para nuevo registro
        async function showNewForm() {
            if (!currentTable) {
                showMessage('Selecciona una tabla primero', 'warning');
                return;
            }
            
            currentRecordId = null;
            document.getElementById('formTitle').textContent = `Nuevo Registro en ${currentTable}`;
            document.getElementById('deleteBtn').classList.add('hidden');
            
            // Obtener columnas de la tabla
            const columns = await getTableColumns(currentTable);
            
            // Generar campos del formulario
            generateFormFields(columns);
            
            // Mostrar el formulario
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Editar un registro
        async function editRecord(id) {
            if (!currentTable) return;
            
            currentRecordId = id;
            document.getElementById('formTitle').textContent = `Editar Registro en ${currentTable}`;
            document.getElementById('deleteBtn').classList.remove('hidden');
            
            // Obtener el registro específico
            const { data, error } = await supabase
                .from(currentTable)
                .select('*')
                .eq('id', id)
                .single();
            
            if (error) {
                showMessage(`Error al cargar registro: ${error.message}`, 'danger');
                return;
            }
            
            // Obtener columnas de la tabla
            const columns = await getTableColumns(currentTable);
            
            // Generar campos del formulario con datos existentes
            generateFormFields(columns, data);
            
            // Mostrar el formulario
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Generar campos del formulario
        function generateFormFields(columns, data = null) {
            let formHTML = '';
            
            columns.forEach(col => {
                // Omitir campos automáticos como id y timestamps
                if (col.name === 'id' || col.name === 'creado_en' || col.name === 'actualizado_en') {
                    return;
                }
                
                const value = data ? data[col.name] : '';
                let inputHTML = '';
                
                if (col.inputType === 'checkbox') {
                    inputHTML = `
                        <input type="checkbox" 
                               id="${col.name}" 
                               name="${col.name}"
                               ${value ? 'checked' : ''}
                               class="form-control">
                    `;
                } else if (col.inputType === 'textarea') {
                    inputHTML = `
                        <textarea id="${col.name}" 
                                  name="${col.name}" 
                                  class="form-control"
                                  rows="3">${value || ''}</textarea>
                    `;
                } else if (col.inputType === 'datetime-local') {
                    // Formatear fecha para input datetime-local
                    let formattedValue = '';
                    if (value) {
                        const date = new Date(value);
                        formattedValue = date.toISOString().slice(0, 16);
                    }
                    inputHTML = `
                        <input type="${col.inputType}" 
                               id="${col.name}" 
                               name="${col.name}" 
                               value="${formattedValue}"
                               class="form-control">
                    `;
                } else if (col.inputType === 'date') {
                    // Formatear fecha para input date
                    let formattedValue = '';
                    if (value) {
                        const date = new Date(value);
                        formattedValue = date.toISOString().slice(0, 10);
                    }
                    inputHTML = `
                        <input type="${col.inputType}" 
                               id="${col.name}" 
                               name="${col.name}" 
                               value="${formattedValue}"
                               class="form-control">
                    `;
                } else {
                    inputHTML = `
                        <input type="${col.inputType}" 
                               id="${col.name}" 
                               name="${col.name}" 
                               value="${value || ''}"
                               class="form-control"
                               ${col.required ? 'required' : ''}>
                    `;
                }
                
                formHTML += `
                    <div class="form-group">
                        <label for="${col.name}">${col.name}</label>
                        ${inputHTML}
                    </div>
                `;
            });
            
            document.getElementById('formFields').innerHTML = formHTML;
        }
        
        // Guardar registro (crear o actualizar)
        async function saveRecord(event) {
            event.preventDefault();
            
            if (!currentTable) return;
            
            // Obtener datos del formulario
            const formData = new FormData(document.getElementById('dataForm'));
            const recordData = {};
            
            // Obtener columnas para saber qué campos incluir
            const columns = await getTableColumns(currentTable);
            
            columns.forEach(col => {
                // Omitir campos automáticos
                if (col.name === 'id' || col.name === 'creado_en' || col.name === 'actualizado_en') {
                    return;
                }
                
                const value = formData.get(col.name);
                
                if (col.inputType === 'checkbox') {
                    recordData[col.name] = document.getElementById(col.name).checked;
                } else if (col.type === 'integer' || col.type === 'decimal' || col.type === 'numeric') {
                    recordData[col.name] = value ? parseFloat(value) : null;
                } else if (value) {
                    recordData[col.name] = value;
                }
            });
            
            try {
                if (currentRecordId) {
                    // Actualizar registro existente
                    const { error } = await supabase
                        .from(currentTable)
                        .update(recordData)
                        .eq('id', currentRecordId);
                    
                    if (error) throw error;
                    
                    showMessage('Registro actualizado correctamente', 'success');
                } else {
                    // Crear nuevo registro
                    const { error } = await supabase
                        .from(currentTable)
                        .insert([recordData]);
                    
                    if (error) throw error;
                    
                    showMessage('Registro creado correctamente', 'success');
                }
                
                // Ocultar formulario y actualizar tabla
                hideForm();
                loadTableData();
                loadStatistics();
                
            } catch (error) {
                console.error('Error al guardar registro:', error);
                showMessage(`Error al guardar: ${error.message}`, 'danger');
            }
        }
        
        // Confirmar eliminación de registro
        function confirmDelete(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este registro? Esta acción no se puede deshacer.')) {
                deleteRecord(id);
            }
        }
        
        // Eliminar registro
        async function deleteRecord(id = null) {
            if (!currentTable) return;
            
            const recordId = id || currentRecordId;
            if (!recordId) return;
            
            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .eq('id', recordId);
                
                if (error) throw error;
                
                showMessage('Registro eliminado correctamente', 'success');
                
                // Ocultar formulario y actualizar tabla
                hideForm();
                loadTableData();
                loadStatistics();
                
            } catch (error) {
                console.error('Error al eliminar registro:', error);
                showMessage(`Error al eliminar: ${error.message}`, 'danger');
            }
        }
        
        // Ocultar formulario
        function hideForm() {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('dataForm').reset();
            currentRecordId = null;
        }
        
        // Refrescar datos
        function refreshData() {
            if (currentTable) {
                loadTableData();
            }
            loadStatistics();
        }
        
        // Mostrar mensaje
        function showMessage(message, type) {
            const alertDiv = document.getElementById('messageAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.classList.remove('hidden');
            
            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Cerrar sesión
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
