<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Nexial Suite</title>
    <!-- Cargar Supabase desde un CDN que funcione con GitHub Pages -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #0f172a; 
            color: white; 
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #334155; 
        }
        h1 { 
            color: #e2e8f0; 
            font-size: 24px; 
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            font-size: 14px;
        }
        .btn-primary { 
            background: #7c3aed; 
            color: white; 
        }
        .btn-secondary { 
            background: #334155; 
            color: white; 
            border: 1px solid #475569; 
        }
        .btn-danger { 
            background: #dc2626; 
            color: white; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); 
        }
        .controls { 
            margin: 20px 0; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            background: #1e293b; 
            border-radius: 5px; 
            overflow: hidden; 
            border: 1px solid #334155;
        }
        th, td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #334155; 
        }
        th { 
            background: #0f172a; 
            color: #94a3b8; 
            font-weight: 600; 
        }
        tr:hover { 
            background: #2d3748; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content { 
            background: #1e293b; 
            padding: 30px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 500px; 
            border: 1px solid #475569; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .modal-title { 
            font-size: 20px; 
            color: #e2e8f0; 
        }
        .close-modal { 
            background: none; 
            border: none; 
            color: #94a3b8; 
            font-size: 24px; 
            cursor: pointer; 
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            color: #cbd5e1; 
        }
        .form-group input, 
        .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            background: #0f172a; 
            border: 1px solid #475569; 
            border-radius: 5px; 
            color: white; 
        }
        .form-group textarea { 
            min-height: 100px; 
            resize: vertical; 
        }
        .modal-footer { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 20px; 
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #94a3b8; 
        }
        .error-message { 
            color: #f87171; 
            padding: 15px; 
            margin: 10px 0; 
            background: rgba(220, 38, 38, 0.1); 
            border-radius: 5px; 
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: #94a3b8; 
            background: #1e293b;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #334155;
        }
        .actions { 
            display: flex; 
            gap: 5px; 
        }
        .btn-sm { 
            padding: 6px 12px; 
            font-size: 13px; 
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Director Corporativo - Gestión de Empresas</h1>
            <div class="user-info">
                <span id="userEmail">Cargando...</span>
                <button class="btn btn-secondary" id="logoutBtn">Cerrar Sesión</button>
            </div>
        </header>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="controls">
            <button class="btn btn-primary" id="refreshBtn">Actualizar Lista</button>
            <button class="btn btn-primary" id="createBtn">Nueva Empresa</button>
        </div>

        <div id="loading" class="loading">Cargando empresas...</div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <p>No hay empresas registradas</p>
            <button class="btn btn-primary" style="margin-top: 15px;" id="createFirstBtn">Crear primera empresa</button>
        </div>
        
        <div id="empresasContainer" style="display: none;">
            <table id="empresasTable">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>RUC</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Dirección</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="empresasBody">
                    <!-- Las empresas se cargarán aquí -->
                </tbody>
            </table>
        </div>

        <!-- Modal para crear/editar empresa -->
        <div id="modalEmpresa" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">Nueva Empresa</h2>
                    <button class="close-modal" id="closeModalBtn">&times;</button>
                </div>
                <form id="formEmpresa">
                    <div class="form-group">
                        <label for="nombre">Nombre de la Empresa *</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="ruc">RUC *</label>
                        <input type="text" id="ruc" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="tel" id="telefono">
                    </div>
                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" id="direccion">
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <textarea id="descripcion"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let supabase = null;
        let empresaEditando = null;
        let currentSession = null;

        // Inicializar Supabase
        function inicializarSupabase() {
            try {
                // Configurar cliente Supabase con las credenciales correctas
                const supabaseUrl = 'https://zshnzeqstrdzuljqueto.supabase.co';
                const supabaseKey = 'sb_publishable_J8vYye7ZumaK4hGoRwaIpQ_O_kj0ERX';
                
                // Crear cliente Supabase
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                console.log('Supabase inicializado correctamente');
                return true;
            } catch (error) {
                console.error('Error al inicializar Supabase:', error);
                mostrarError('Error al conectar con la base de datos. Recarga la página.');
                return false;
            }
        }

        // Verificar sesión
        async function verificarSesion() {
            try {
                if (!supabase) {
                    mostrarError('No se pudo conectar con el servidor');
                    return false;
                }

                // Obtener sesión actual
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Error al obtener sesión:', error);
                    window.location.href = 'login.html';
                    return false;
                }

                if (!session) {
                    console.log('No hay sesión activa, redirigiendo a login...');
                    window.location.href = 'login.html';
                    return false;
                }

                currentSession = session;
                
                // Mostrar email del usuario
                document.getElementById('userEmail').textContent = session.user.email;
                return true;
            } catch (error) {
                console.error('Error en verificarSesion:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Cargar empresas
        async function cargarEmpresas() {
            try {
                mostrarCargando(true);
                ocultarError();
                ocultarStatus();

                // Verificar sesión primero
                if (!currentSession) {
                    const autenticado = await verificarSesion();
                    if (!autenticado) return;
                }

                console.log('Cargando empresas...');
                
                // Intentar cargar desde Supabase
                const { data, error, status } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('Respuesta de Supabase:', { data, error, status });

                if (error) {
                    // Si es error de política RLS, mostrar mensaje específico
                    if (error.message.includes('policy') || error.code === '42501') {
                        mostrarError('Error de permisos: No tienes acceso a esta tabla. Verifica las políticas RLS en Supabase.');
                    } else if (error.message.includes('relation') || error.code === '42P01') {
                        mostrarError('La tabla "empresas" no existe. Crea la tabla en Supabase primero.');
                    } else {
                        mostrarError('Error al cargar empresas: ' + error.message);
                    }
                    return;
                }

                // Mostrar datos
                actualizarTabla(data || []);
                
            } catch (error) {
                console.error('Error en cargarEmpresas:', error);
                mostrarError('Error inesperado: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }

        // Actualizar tabla de empresas
        function actualizarTabla(empresas) {
            const tbody = document.getElementById('empresasBody');
            const container = document.getElementById('empresasContainer');
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';

            if (!empresas || empresas.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'block';

            empresas.forEach(empresa => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(empresa.nombre || '-')}</td>
                    <td>${escapeHtml(empresa.ruc || '-')}</td>
                    <td>${escapeHtml(empresa.email || '-')}</td>
                    <td>${escapeHtml(empresa.telefono || '-')}</td>
                    <td>${escapeHtml(empresa.direccion || '-')}</td>
                    <td class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="editarEmpresa('${empresa.id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarEmpresa('${empresa.id}', '${escapeHtml(empresa.nombre || empresa.ruc || 'esta empresa')}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Función para escapar HTML (seguridad)
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Abrir modal para crear empresa
        function abrirModalCrear() {
            empresaEditando = null;
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            document.getElementById('formEmpresa').reset();
            document.getElementById('modalEmpresa').style.display = 'flex';
        }

        // Editar empresa
        async function editarEmpresa(id) {
            try {
                mostrarCargando(true);
                
                const { data, error } = await supabase
                    .from('empresas')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) {
                    mostrarError('Error al cargar empresa: ' + error.message);
                    return;
                }

                empresaEditando = id;
                document.getElementById('modalTitle').textContent = 'Editar Empresa';
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('ruc').value = data.ruc || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('telefono').value = data.telefono || '';
                document.getElementById('direccion').value = data.direccion || '';
                document.getElementById('descripcion').value = data.descripcion || '';
                
                document.getElementById('modalEmpresa').style.display = 'flex';
            } catch (error) {
                mostrarError('Error: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }

        // Guardar empresa (crear o actualizar)
        async function guardarEmpresa(event) {
            event.preventDefault();
            
            try {
                const datosEmpresa = {
                    nombre: document.getElementById('nombre').value.trim(),
                    ruc: document.getElementById('ruc').value.trim(),
                    email: document.getElementById('email').value.trim() || null,
                    telefono: document.getElementById('telefono').value.trim() || null,
                    direccion: document.getElementById('direccion').value.trim() || null,
                    descripcion: document.getElementById('descripcion').value.trim() || null,
                    updated_at: new Date().toISOString()
                };

                // Validar campos obligatorios
                if (!datosEmpresa.nombre || !datosEmpresa.ruc) {
                    mostrarError('Nombre y RUC son campos obligatorios');
                    return;
                }

                let resultado;

                if (empresaEditando) {
                    // Actualizar empresa existente
                    const { data, error } = await supabase
                        .from('empresas')
                        .update(datosEmpresa)
                        .eq('id', empresaEditando)
                        .select();

                    if (error) {
                        mostrarError('Error al actualizar: ' + error.message);
                        return;
                    }
                    resultado = data;
                    mostrarStatus('Empresa actualizada correctamente');
                } else {
                    // Crear nueva empresa
                    datosEmpresa.created_at = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('empresas')
                        .insert([datosEmpresa])
                        .select();

                    if (error) {
                        mostrarError('Error al crear empresa: ' + error.message);
                        return;
                    }
                    resultado = data;
                    mostrarStatus('Empresa creada correctamente');
                }

                if (resultado && resultado.length > 0) {
                    cerrarModal();
                    cargarEmpresas();
                }
            } catch (error) {
                mostrarError('Error al guardar empresa: ' + error.message);
            }
        }

        // Eliminar empresa
        async function eliminarEmpresa(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar la empresa "${nombre}"? Esta acción no se puede deshacer.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('empresas')
                    .delete()
                    .eq('id', id);

                if (error) {
                    mostrarError('Error al eliminar empresa: ' + error.message);
                    return;
                }

                mostrarStatus('Empresa eliminada correctamente');
                cargarEmpresas();
            } catch (error) {
                mostrarError('Error: ' + error.message);
            }
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modalEmpresa').style.display = 'none';
            document.getElementById('formEmpresa').reset();
            empresaEditando = null;
        }

        // Cerrar sesión
        async function logout() {
            try {
                if (supabase) {
                    await supabase.auth.signOut();
                }
                localStorage.removeItem('nexial_user');
                localStorage.removeItem('supabase_url');
                localStorage.removeItem('supabase_key');
                window.location.href = 'index.html';
            } catch (error) {
                window.location.href = 'index.html';
            }
        }

        // Mostrar/ocultar carga
        function mostrarCargando(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
        }

        // Mostrar error
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
        }

        // Mostrar mensaje de éxito
        function mostrarStatus(mensaje) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = 'status-message success';
            statusDiv.style.display = 'block';
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // Ocultar error
        function ocultarError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Ocultar status
        function ocultarStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        // Configurar eventos
        function configurarEventos() {
            // Botones
            document.getElementById('refreshBtn').addEventListener('click', cargarEmpresas);
            document.getElementById('createBtn').addEventListener('click', abrirModalCrear);
            document.getElementById('createFirstBtn').addEventListener('click', abrirModalCrear);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Modal
            document.getElementById('closeModalBtn').addEventListener('click', cerrarModal);
            document.getElementById('cancelBtn').addEventListener('click', cerrarModal);
            
            // Formulario
            document.getElementById('formEmpresa').addEventListener('submit', guardarEmpresa);
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modalEmpresa').addEventListener('click', function(event) {
                if (event.target === this) {
                    cerrarModal();
                }
            });
        }

        // Inicializar aplicación
        async function inicializar() {
            try {
                console.log('Inicializando aplicación...');
                
                // Inicializar Supabase
                const supabaseInicializado = inicializarSupabase();
                if (!supabaseInicializado) {
                    mostrarError('No se pudo inicializar la conexión con la base de datos');
                    return;
                }

                // Verificar sesión
                const autenticado = await verificarSesion();
                if (!autenticado) return;

                // Configurar eventos
                configurarEventos();

                // Cargar empresas
                await cargarEmpresas();

                console.log('Aplicación inicializada correctamente');
            } catch (error) {
                console.error('Error al inicializar:', error);
                mostrarError('Error crítico: ' + error.message);
            }
        }

        // Iniciar cuando se cargue la página
        document.addEventListener('DOMContentLoaded', inicializar);

        // También manejar el evento de visibilidad de página
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Si la página se vuelve visible, verificar sesión
                if (supabase) {
                    verificarSesion().then(autenticado => {
                        if (autenticado) {
                            cargarEmpresas();
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
