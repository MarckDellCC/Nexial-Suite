<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Director Corporativo</title>
    <style>
        table, th, td {border:1px solid;border-collapse:collapse;padding:5px;}
        .modal {display:none;position:fixed;background:white;border:1px solid;padding:20px;}
    </style>
</head>
<body>
    <h1>Director Corporativo</h1>
    <button onclick="cerrarSesion()">Cerrar Sesión</button>
    <div>
        <button onclick="mostrarTab('empresas')">Empresas</button>
        <button onclick="mostrarTab('usuarios')">Usuarios</button>
    </div>
    
    <div id="empresas-tab">
        <button onclick="mostrarModalEmpresa()">Nueva Empresa</button>
        <table id="empresas-table"></table>
    </div>
    
    <div id="usuarios-tab" style="display:none;">
        <button onclick="mostrarModalUsuario()">Nuevo Usuario</button>
        <table id="usuarios-table"></table>
    </div>
    
    <div id="empresa-modal" class="modal">
        <h3>Empresa</h3>
        <form id="empresa-form">
            <input type="hidden" id="empresa-id">
            <input type="text" id="codigo_empresa" placeholder="Código" required><br>
            <input type="text" id="nombre_legal" placeholder="Nombre Legal" required><br>
            <button type="submit">Guardar</button>
            <button type="button" onclick="cerrarModal('empresa')">Cancelar</button>
        </form>
    </div>
    
    <div id="usuario-modal" class="modal">
        <h3>Usuario</h3>
        <form id="usuario-form">
            <input type="hidden" id="usuario-id">
            <input type="text" id="username" placeholder="Usuario" required><br>
            <input type="password" id="password_hash" placeholder="Contraseña" required><br>
            <select id="rol_sistema" required>
                <option value="DIRECTOR_CORPORATIVO">Director Corporativo</option>
                <option value="DIRECTOR_GENERAL">Director General</option>
            </select><br>
            <button type="submit">Guardar</button>
            <button type="button" onclick="cerrarModal('usuario')">Cancelar</button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = 'https://dcmzpbfhtcevinruphcz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_kIb5dk3KdkVJLGBfKEeyog_OxrzqsjB';
        
        // Verificar autenticación
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.rol_sistema !== 'DIRECTOR_CORPORATIVO') {
            window.location.href = 'login.html';
        }
        
        // Funciones básicas
        function mostrarTab(tab) {
            document.getElementById('empresas-tab').style.display = 'none';
            document.getElementById('usuarios-tab').style.display = 'none';
            document.getElementById(tab + '-tab').style.display = 'block';
        }
        
        function mostrarModalEmpresa() {
            document.getElementById('empresa-modal').style.display = 'block';
            document.getElementById('empresa-form').reset();
        }
        
        function mostrarModalUsuario() {
            document.getElementById('usuario-modal').style.display = 'block';
            document.getElementById('usuario-form').reset();
        }
        
        function cerrarModal(tipo) {
            document.getElementById(tipo + '-modal').style.display = 'none';
        }
        
        function cerrarSesion() {
            localStorage.removeItem('usuario');
            window.location.href = 'login.html';
        }
        
        // Cargar empresas
        async function cargarEmpresas() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/empresas`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const empresas = await response.json();
                const table = document.getElementById('empresas-table');
                table.innerHTML = '<tr><th>Código</th><th>Nombre</th><th>Acciones</th></tr>';
                empresas.forEach(empresa => {
                    const row = `<tr>
                        <td>${empresa.codigo_empresa}</td>
                        <td>${empresa.nombre_legal}</td>
                        <td>
                            <button onclick="editarEmpresa('${empresa.id}')">Editar</button>
                            <button onclick="eliminarEmpresa('${empresa.id}')">Eliminar</button>
                        </td>
                    </tr>`;
                    table.innerHTML += row;
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Cargar usuarios
        async function cargarUsuarios() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/usuarios?eliminado=eq.false`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const usuarios = await response.json();
                const table = document.getElementById('usuarios-table');
                table.innerHTML = '<tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr>';
                usuarios.forEach(usuario => {
                    const row = `<tr>
                        <td>${usuario.username}</td>
                        <td>${usuario.rol_sistema}</td>
                        <td>
                            <button onclick="editarUsuario('${usuario.id}')">Editar</button>
                            <button onclick="eliminarUsuario('${usuario.id}')">Eliminar</button>
                        </td>
                    </tr>`;
                    table.innerHTML += row;
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Formulario empresa
        document.getElementById('empresa-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                codigo_empresa: document.getElementById('codigo_empresa').value,
                nombre_legal: document.getElementById('nombre_legal').value,
                activa: true,
                moneda_principal: 'COP',
                zona_horaria: 'America/Bogota'
            };
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/empresas`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                cerrarModal('empresa');
                cargarEmpresas();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
        
        // Formulario usuario
        document.getElementById('usuario-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                username: document.getElementById('username').value,
                password_hash: document.getElementById('password_hash').value,
                rol_sistema: document.getElementById('rol_sistema').value,
                nivel_acceso: document.getElementById('rol_sistema').value === 'DIRECTOR_CORPORATIVO' ? 10 : 5,
                empresa_id: usuario.empresa_id,
                email: document.getElementById('username').value + '@empresa.com'
            };
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/usuarios`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                cerrarModal('usuario');
                cargarUsuarios();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
        
        // Funciones CRUD
        function editarEmpresa(id) {
            alert('Editar empresa: ' + id);
        }
        
        function editarUsuario(id) {
            alert('Editar usuario: ' + id);
        }
        
        async function eliminarEmpresa(id) {
            if (confirm('¿Eliminar empresa?')) {
                await fetch(`${SUPABASE_URL}/rest/v1/empresas?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                cargarEmpresas();
            }
        }
        
        async function eliminarUsuario(id) {
            if (confirm('¿Eliminar usuario?')) {
                await fetch(`${SUPABASE_URL}/rest/v1/usuarios?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ eliminado: true })
                });
                cargarUsuarios();
            }
        }
        
        // Inicializar
        cargarEmpresas();
        cargarUsuarios();
    </script>
</body>
</html>
