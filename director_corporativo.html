<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Nexial Suite</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Director Corporativo - Gestión de Empresas</h1>

    <h2>Agregar/Editar Empresa</h2>
    <form id="formEmpresa">
        <label for="codigo">Código:</label>
        <input type="text" id="codigo" required><br><br>

        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" required><br><br>

        <label for="documento_identidad">Documento Identidad:</label>
        <input type="text" id="documento_identidad"><br><br>

        <label for="tipo_documento">Tipo Documento:</label>
        <input type="text" id="tipo_documento"><br><br>

        <label for="direccion">Dirección:</label>
        <textarea id="direccion"></textarea><br><br>

        <label for="ciudad">Ciudad:</label>
        <input type="text" id="ciudad"><br><br>

        <label for="estado">Estado:</label>
        <input type="text" id="estado"><br><br>

        <label for="codigo_postal">Código Postal:</label>
        <input type="text" id="codigo_postal"><br><br>

        <label for="pais">País:</label>
        <input type="text" id="pais"><br><br>

        <label for="telefono">Teléfono:</label>
        <input type="text" id="telefono"><br><br>

        <label for="telefono2">Teléfono 2:</label>
        <input type="text" id="telefono2"><br><br>

        <label for="email">Email:</label>
        <input type="email" id="email"><br><br>

        <label for="email2">Email 2:</label>
        <input type="email" id="email2"><br><br>

        <label for="moneda_id">Moneda ID:</label>
        <input type="number" id="moneda_id"><br><br>

        <label for="logo_url">Logo URL:</label>
        <input type="text" id="logo_url"><br><br>

        <label for="activo">Activo:</label>
        <input type="checkbox" id="activo" checked><br><br>

        <label for="empresa_matriz_id">Empresa Matriz ID:</label>
        <input type="number" id="empresa_matriz_id"><br><br>

        <button type="submit" id="btnGuardar">Agregar Empresa</button>
        <button type="button" id="btnCancelar" style="display:none;">Cancelar</button>
    </form>

    <h2>Lista de Empresas</h2>
    <table id="tablaEmpresas" border="1">
        <thead>
            <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Documento</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Email</th>
                <th>Activo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas se llenan con JavaScript -->
        </tbody>
    </table>

    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://xfggpijyisejhjjfnowv.supabase.co';
        const supabaseAnonKey = 'sb_publishable_IJWD3UeDtyC9x9ON3EhjbQ_1oGokAxb';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let empresas = [];
        let editingId = null;

        // Verificar si el usuario está autenticado
        const user = sessionStorage.getItem('user');
        if (!user) {
            window.location.href = 'login.html';
        }

        // Cargar empresas al inicio
        document.addEventListener('DOMContentLoaded', cargarEmpresas);

        // Agregar evento al formulario
        document.getElementById('formEmpresa').addEventListener('submit', guardarEmpresa);
        document.getElementById('btnCancelar').addEventListener('click', limpiarFormulario);

        async function cargarEmpresas() {
            const { data, error } = await supabaseClient
                .from('Empresas')
                .select('*')
                .order('id', { ascending: true });

            if (error) {
                alert('Error al cargar empresas: ' + error.message);
                return;
            }

            empresas = data;
            mostrarEmpresas();
        }

        function mostrarEmpresas() {
            const tbody = document.querySelector('#tablaEmpresas tbody');
            tbody.innerHTML = '';

            empresas.forEach(empresa => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${empresa.codigo}</td>
                    <td>${empresa.nombre}</td>
                    <td>${empresa.documento_identidad || ''}</td>
                    <td>${empresa.direccion || ''}</td>
                    <td>${empresa.telefono || ''}</td>
                    <td>${empresa.email || ''}</td>
                    <td>${empresa.activo ? 'Sí' : 'No'}</td>
                    <td>
                        <button onclick="editarEmpresa(${empresa.id})">Editar</button>
                        <button onclick="eliminarEmpresa(${empresa.id})">Eliminar</button>
                    </td>
                `;
            });
        }

        async function guardarEmpresa(event) {
            event.preventDefault();
            
            const empresaData = {
                codigo: document.getElementById('codigo').value,
                nombre: document.getElementById('nombre').value,
                documento_identidad: document.getElementById('documento_identidad').value,
                tipo_documento: document.getElementById('tipo_documento').value,
                direccion: document.getElementById('direccion').value,
                ciudad: document.getElementById('ciudad').value,
                estado: document.getElementById('estado').value,
                codigo_postal: document.getElementById('codigo_postal').value,
                pais: document.getElementById('pais').value,
                telefono: document.getElementById('telefono').value,
                telefono2: document.getElementById('telefono2').value,
                email: document.getElementById('email').value,
                email2: document.getElementById('email2').value,
                moneda_id: document.getElementById('moneda_id').value ? parseInt(document.getElementById('moneda_id').value) : null,
                logo_url: document.getElementById('logo_url').value,
                activo: document.getElementById('activo').checked,
                empresa_matriz_id: document.getElementById('empresa_matriz_id').value ? parseInt(document.getElementById('empresa_matriz_id').value) : null
            };

            let error = null;

            if (editingId) {
                // Actualizar empresa existente
                const { error: updateError } = await supabaseClient
                    .from('Empresas')
                    .update(empresaData)
                    .eq('id', editingId);
                error = updateError;
            } else {
                // Crear nueva empresa
                const { error: insertError } = await supabaseClient
                    .from('Empresas')
                    .insert([empresaData]);
                error = insertError;
            }

            if (error) {
                alert('Error al guardar empresa: ' + error.message);
                return;
            }

            // Recargar la lista
            cargarEmpresas();
            // Limpiar formulario
            limpiarFormulario();
        }

        async function editarEmpresa(id) {
            const empresa = empresas.find(e => e.id === id);
            if (!empresa) return;

            editingId = id;
            
            // Llenar formulario con datos
            document.getElementById('codigo').value = empresa.codigo;
            document.getElementById('nombre').value = empresa.nombre;
            document.getElementById('documento_identidad').value = empresa.documento_identidad || '';
            document.getElementById('tipo_documento').value = empresa.tipo_documento || '';
            document.getElementById('direccion').value = empresa.direccion || '';
            document.getElementById('ciudad').value = empresa.ciudad || '';
            document.getElementById('estado').value = empresa.estado || '';
            document.getElementById('codigo_postal').value = empresa.codigo_postal || '';
            document.getElementById('pais').value = empresa.pais || '';
            document.getElementById('telefono').value = empresa.telefono || '';
            document.getElementById('telefono2').value = empresa.telefono2 || '';
            document.getElementById('email').value = empresa.email || '';
            document.getElementById('email2').value = empresa.email2 || '';
            document.getElementById('moneda_id').value = empresa.moneda_id || '';
            document.getElementById('logo_url').value = empresa.logo_url || '';
            document.getElementById('activo').checked = empresa.activo;
            document.getElementById('empresa_matriz_id').value = empresa.empresa_matriz_id || '';
            
            document.getElementById('btnGuardar').textContent = 'Actualizar Empresa';
            document.getElementById('btnCancelar').style.display = 'inline';
        }

        function limpiarFormulario() {
            document.getElementById('formEmpresa').reset();
            editingId = null;
            document.getElementById('btnGuardar').textContent = 'Agregar Empresa';
            document.getElementById('btnCancelar').style.display = 'none';
        }

        async function eliminarEmpresa(id) {
            if (!confirm('¿Está seguro de eliminar esta empresa?')) return;

            const { error } = await supabaseClient
                .from('Empresas')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error al eliminar empresa: ' + error.message);
                return;
            }

            cargarEmpresas();
        }
    </script>
</body>
</html>
