<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 20px; font-family: Arial; background: #0f172a; color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        h2 { color: #e2e8f0; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin-right: 10px; background: #7c3aed; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .logout { background: #dc2626; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #475569; padding: 10px; text-align: left; }
        th { background: #1e293b; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #1e293b; margin: 100px auto; padding: 20px; width: 400px; border-radius: 5px; }
        .modal input, .modal textarea { width: 100%; padding: 8px; margin: 5px 0; background: #0f172a; border: 1px solid #475569; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Director Corporativo - Gestión de Empresas</h2>
        
        <div class="controls">
            <button onclick="loadEmpresas()">Cargar Empresas</button>
            <button onclick="openCreateModal()">Crear Nueva Empresa</button>
            <button onclick="logout()" class="logout">Cerrar Sesión</button>
        </div>

        <div id="empresasTable"></div>
    </div>

    <!-- Modal para crear/editar empresa -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Nueva Empresa</h3>
            <input type="text" id="empresaNombre" placeholder="Nombre de la empresa">
            <input type="text" id="empresaRUC" placeholder="RUC">
            <input type="text" id="empresaDireccion" placeholder="Dirección">
            <input type="email" id="empresaEmail" placeholder="Email">
            <input type="tel" id="empresaTelefono" placeholder="Teléfono">
            <textarea id="empresaDescripcion" placeholder="Descripción" rows="3"></textarea>
            <div style="margin-top: 15px;">
                <button onclick="saveEmpresa()">Guardar</button>
                <button onclick="closeModal()" style="background: #64748b;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Configurar Supabase
        const supabaseUrl = localStorage.getItem('supabase_url');
        const supabaseKey = localStorage.getItem('supabase_key');
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let editingId = null;

        // Verificar autenticación
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            // Verificar que sea director corporativo
            const user = JSON.parse(localStorage.getItem('nexial_user') || '{}');
            if (user.hierarchy !== 'director_corporativo') {
                alert('Acceso no autorizado');
                window.location.href = 'login.html';
            }
        }

        // Cargar empresas
        async function loadEmpresas() {
            const { data, error } = await supabase
                .from('empresas')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                alert('Error al cargar empresas: ' + error.message);
                return;
            }

            let html = '<table>';
            html += '<tr><th>Nombre</th><th>RUC</th><th>Email</th><th>Teléfono</th><th>Acciones</th></tr>';
            
            data.forEach(empresa => {
                html += `<tr>
                    <td>${empresa.nombre || ''}</td>
                    <td>${empresa.ruc || ''}</td>
                    <td>${empresa.email || ''}</td>
                    <td>${empresa.telefono || ''}</td>
                    <td>
                        <button onclick="editEmpresa('${empresa.id}')">Editar</button>
                        <button onclick="deleteEmpresa('${empresa.id}')" style="background: #dc2626;">Eliminar</button>
                    </td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('empresasTable').innerHTML = html;
        }

        // Abrir modal para crear empresa
        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            clearModalFields();
            document.getElementById('modal').style.display = 'block';
        }

        // Editar empresa
        async function editEmpresa(id) {
            const { data, error } = await supabase
                .from('empresas')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert('Error al cargar empresa: ' + error.message);
                return;
            }

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Editar Empresa';
            document.getElementById('empresaNombre').value = data.nombre || '';
            document.getElementById('empresaRUC').value = data.ruc || '';
            document.getElementById('empresaDireccion').value = data.direccion || '';
            document.getElementById('empresaEmail').value = data.email || '';
            document.getElementById('empresaTelefono').value = data.telefono || '';
            document.getElementById('empresaDescripcion').value = data.descripcion || '';
            document.getElementById('modal').style.display = 'block';
        }

        // Guardar empresa (crear o actualizar)
        async function saveEmpresa() {
            const empresaData = {
                nombre: document.getElementById('empresaNombre').value,
                ruc: document.getElementById('empresaRUC').value,
                direccion: document.getElementById('empresaDireccion').value,
                email: document.getElementById('empresaEmail').value,
                telefono: document.getElementById('empresaTelefono').value,
                descripcion: document.getElementById('empresaDescripcion').value,
                updated_at: new Date().toISOString()
            };

            let error;
            
            if (editingId) {
                // Actualizar
                const { error: updateError } = await supabase
                    .from('empresas')
                    .update(empresaData)
                    .eq('id', editingId);
                error = updateError;
            } else {
                // Crear
                empresaData.created_at = new Date().toISOString();
                const { error: insertError } = await supabase
                    .from('empresas')
                    .insert([empresaData]);
                error = insertError;
            }

            if (error) {
                alert('Error al guardar: ' + error.message);
                return;
            }

            closeModal();
            loadEmpresas();
        }

        // Eliminar empresa
        async function deleteEmpresa(id) {
            if (!confirm('¿Está seguro de eliminar esta empresa?')) return;

            const { error } = await supabase
                .from('empresas')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error al eliminar: ' + error.message);
                return;
            }

            loadEmpresas();
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Limpiar campos del modal
        function clearModalFields() {
            document.getElementById('empresaNombre').value = '';
            document.getElementById('empresaRUC').value = '';
            document.getElementById('empresaDireccion').value = '';
            document.getElementById('empresaEmail').value = '';
            document.getElementById('empresaTelefono').value = '';
            document.getElementById('empresaDescripcion').value = '';
        }

        // Cerrar sesión
        async function logout() {
            await supabase.auth.signOut();
            localStorage.removeItem('nexial_user');
            window.location.href = 'index.html';
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadEmpresas();
        });
    </script>
</body>
</html>
