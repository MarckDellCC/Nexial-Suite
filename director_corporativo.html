<!DOCTYPE html>
<html>
<head>
    <title>Panel Director Corporativo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-add { background-color: #28a745; color: white; margin-bottom: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 50%; }
        .close { float: right; cursor: pointer; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 5px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>Gestión de Empresas</h2>
    <div id="userInfo"></div>
    <button class="btn btn-add" onclick="openAddModal()">Nueva Empresa</button>
    <div id="error" class="error"></div>
    <table id="empresasTable">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>RFC</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Email</th>
                <th>Website</th>
                <th>Moneda</th>
                <th>Logo</th>
                <th>Tipo Empresa</th>
                <th>Régimen Fiscal</th>
                <th>Activo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="empresasBody">
        </tbody>
    </table>

    <!-- Modal para agregar/editar empresa -->
    <div id="empresaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Nueva Empresa</h3>
            <form id="empresaForm">
                <input type="hidden" id="empresaId">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="nombre" required>
                </div>
                <div class="form-group">
                    <label>RFC *</label>
                    <input type="text" id="rfc" required>
                </div>
                <div class="form-group">
                    <label>Dirección</label>
                    <textarea id="direccion"></textarea>
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="text" id="telefono">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="website">
                </div>
                <div class="form-group">
                    <label>Moneda *</label>
                    <select id="moneda_id" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Logo URL</label>
                    <input type="url" id="logo_url">
                </div>
                <div class="form-group">
                    <label>Tipo Empresa</label>
                    <input type="text" id="tipo_empresa">
                </div>
                <div class="form-group">
                    <label>Régimen Fiscal</label>
                    <input type="text" id="regimen_fiscal">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="activo" checked> Activo
                    </label>
                </div>
                <button type="submit" class="btn btn-add">Guardar</button>
            </form>
        </div>
    </div>

    <script>
        // Configuración de Supabase - REEMPLAZA CON TU SERVICE ROLE KEY
        const SUPABASE_URL = 'https://sknyockrczifqemmdysx.supabase.co';
        const SUPABASE_SERVICE_KEY = 'tu-service-role-key'; // Reemplazar con la clave de servicio

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

        // Verificar sesión
        const userJson = sessionStorage.getItem('user');
        if (!userJson) {
            window.location.href = 'login.html';
        } else {
            const user = JSON.parse(userJson);
            if (user.rol !== 'Director Corporativo') {
                alert('Acceso no autorizado');
                window.location.href = 'login.html';
            } else {
                document.getElementById('userInfo').innerText = `Bienvenido, ${user.nombres} (${user.rol})`;
                loadMonedas();
                loadEmpresas();
            }
        }

        let monedas = [];

        async function loadMonedas() {
            const { data, error } = await supabase
                .from('monedas')
                .select('*')
                .eq('activo', true);
            if (error) {
                showError('Error cargando monedas: ' + error.message);
                return;
            }
            monedas = data;
            const select = document.getElementById('moneda_id');
            select.innerHTML = '<option value="">Seleccione...</option>';
            data.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.codigo} - ${m.nombre}`;
                select.appendChild(option);
            });
        }

        async function loadEmpresas() {
            const { data, error } = await supabase
                .from('empresas')
                .select('*, monedas(codigo)')
                .order('nombre');
            if (error) {
                showError('Error cargando empresas: ' + error.message);
                return;
            }
            renderEmpresas(data);
        }

        function renderEmpresas(empresas) {
            const tbody = document.getElementById('empresasBody');
            tbody.innerHTML = '';
            empresas.forEach(emp => {
                const row = tbody.insertRow();
                row.insertCell().textContent = emp.nombre || '';
                row.insertCell().textContent = emp.rfc || '';
                row.insertCell().textContent = emp.direccion || '';
                row.insertCell().textContent = emp.telefono || '';
                row.insertCell().textContent = emp.email || '';
                row.insertCell().textContent = emp.website || '';
                row.insertCell().textContent = emp.monedas?.codigo || '';
                row.insertCell().textContent = emp.logo_url ? 'Sí' : '';
                row.insertCell().textContent = emp.tipo_empresa || '';
                row.insertCell().textContent = emp.regimen_fiscal || '';
                row.insertCell().textContent = emp.activo ? 'Sí' : 'No';
                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-edit';
                editBtn.textContent = 'Editar';
                editBtn.onclick = () => openEditModal(emp);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-delete';
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.onclick = () => deleteEmpresa(emp.id);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            document.getElementById('empresaForm').reset();
            document.getElementById('empresaId').value = '';
            document.getElementById('activo').checked = true;
            document.getElementById('empresaModal').style.display = 'block';
        }

        function openEditModal(emp) {
            document.getElementById('modalTitle').textContent = 'Editar Empresa';
            document.getElementById('empresaId').value = emp.id;
            document.getElementById('nombre').value = emp.nombre || '';
            document.getElementById('rfc').value = emp.rfc || '';
            document.getElementById('direccion').value = emp.direccion || '';
            document.getElementById('telefono').value = emp.telefono || '';
            document.getElementById('email').value = emp.email || '';
            document.getElementById('website').value = emp.website || '';
            document.getElementById('moneda_id').value = emp.moneda_id || '';
            document.getElementById('logo_url').value = emp.logo_url || '';
            document.getElementById('tipo_empresa').value = emp.tipo_empresa || '';
            document.getElementById('regimen_fiscal').value = emp.regimen_fiscal || '';
            document.getElementById('activo').checked = emp.activo;
            document.getElementById('empresaModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('empresaModal').style.display = 'none';
        }

        document.getElementById('empresaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('empresaId').value;
            const empresaData = {
                nombre: document.getElementById('nombre').value,
                rfc: document.getElementById('rfc').value,
                direccion: document.getElementById('direccion').value || null,
                telefono: document.getElementById('telefono').value || null,
                email: document.getElementById('email').value || null,
                website: document.getElementById('website').value || null,
                moneda_id: document.getElementById('moneda_id').value,
                logo_url: document.getElementById('logo_url').value || null,
                tipo_empresa: document.getElementById('tipo_empresa').value || null,
                regimen_fiscal: document.getElementById('regimen_fiscal').value || null,
                activo: document.getElementById('activo').checked
            };
            if (id) {
                // Actualizar
                empresaData.actualizado_en = new Date();
                const { error } = await supabase
                    .from('empresas')
                    .update(empresaData)
                    .eq('id', id);
                if (error) {
                    showError('Error actualizando: ' + error.message);
                } else {
                    closeModal();
                    loadEmpresas();
                }
            } else {
                // Insertar
                const { error } = await supabase
                    .from('empresas')
                    .insert([empresaData]);
                if (error) {
                    showError('Error insertando: ' + error.message);
                } else {
                    closeModal();
                    loadEmpresas();
                }
            }
        });

        async function deleteEmpresa(id) {
            if (!confirm('¿Está seguro de eliminar esta empresa?')) return;
            const { error } = await supabase
                .from('empresas')
                .delete()
                .eq('id', id);
            if (error) {
                showError('Error eliminando: ' + error.message);
            } else {
                loadEmpresas();
            }
        }

        // Cerrar modal si se hace clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('empresaModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
