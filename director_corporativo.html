<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Director Corporativo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #333; }
        button { padding: 8px 12px; background: #0070f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0051bb; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #b02a37; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f2f2f2; }
        .actions { display: flex; gap: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 6px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal label { font-weight: bold; margin-top: 10px; display: block; }
        .close { float: right; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>
    <h1>Panel del Director Corporativo</h1>
    <button id="btnNuevaEmpresa">+ Nueva Empresa</button>
    <table id="tablaEmpresas">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>RFC</th>
                <th>Email</th>
                <th>Moneda</th>
                <th>Tipo</th>
                <th>Activo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Modal para crear/editar empresa -->
    <div id="modalEmpresa" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2 id="modalTitulo">Nueva Empresa</h2>
            <form id="formEmpresa">
                <input type="hidden" id="empresaId">
                
                <label>Nombre *</label>
                <input type="text" id="nombre" required>

                <label>RFC *</label>
                <input type="text" id="rfc" required>

                <label>Dirección</label>
                <textarea id="direccion"></textarea>

                <label>Teléfono</label>
                <input type="text" id="telefono">

                <label>Email</label>
                <input type="email" id="email">

                <label>Website</label>
                <input type="url" id="website">

                <label>Moneda *</label>
                <select id="moneda_id" required>
                    <option value="">Seleccione una moneda</option>
                </select>

                <label>Logo URL</label>
                <input type="url" id="logo_url">

                <label>Tipo de empresa</label>
                <input type="text" id="tipo_empresa">

                <label>Régimen fiscal</label>
                <input type="text" id="regimen_fiscal">

                <label>Activo</label>
                <select id="activo">
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                </select>

                <button type="submit" style="margin-top:15px;">Guardar</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const SUPABASE_URL = 'https://sknyockrczifqemmdysx.supabase.co';
        const SUPABASE_SERVICE_KEY = 'tu-service-role-key'; // Reemplazar con la service_role key

        // Crear cliente una sola vez
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

        // Verificar sesión
        (function verificarSesion() {
            const usuario = sessionStorage.getItem('usuario');
            if (!usuario) {
                window.location.href = 'login.html';
                return;
            }
            const userData = JSON.parse(usuario);
            if (userData.rol !== 'Director Corporativo') {
                alert('Acceso no autorizado');
                window.location.href = 'login.html';
            }
        })();

        // Variables globales del modal
        const modal = document.getElementById('modalEmpresa');
        const modalTitulo = document.getElementById('modalTitulo');
        const formEmpresa = document.getElementById('formEmpresa');
        const empresaId = document.getElementById('empresaId');

        // Cargar monedas al abrir la página y al abrir modal
        async function cargarMonedas() {
            const { data, error } = await supabase
                .from('monedas')
                .select('id, codigo, nombre')
                .eq('activo', true)
                .order('codigo');
            if (error) {
                console.error('Error cargando monedas:', error);
                return [];
            }
            return data;
        }

        async function llenarSelectMonedas() {
            const monedas = await cargarMonedas();
            const select = document.getElementById('moneda_id');
            select.innerHTML = '<option value="">Seleccione una moneda</option>';
            monedas.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.codigo} - ${m.nombre}`;
                select.appendChild(option);
            });
        }

        // Cargar empresas en la tabla
        async function loadEmpresas() {
            const { data, error } = await supabase
                .from('empresas')
                .select(`
                    *,
                    monedas (codigo, nombre)
                `)
                .order('nombre');

            if (error) {
                console.error('Error cargando empresas:', error);
                alert('Error al cargar empresas');
                return;
            }

            const tbody = document.querySelector('#tablaEmpresas tbody');
            tbody.innerHTML = '';
            data.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.nombre || ''}</td>
                    <td>${emp.rfc || ''}</td>
                    <td>${emp.email || ''}</td>
                    <td>${emp.monedas ? emp.monedas.codigo : ''}</td>
                    <td>${emp.tipo_empresa || ''}</td>
                    <td>${emp.activo ? 'Sí' : 'No'}</td>
                    <td class="actions">
                        <button onclick="editarEmpresa('${emp.id}')">Editar</button>
                        <button class="btn-danger" onclick="eliminarEmpresa('${emp.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Abrir modal para nueva empresa
        document.getElementById('btnNuevaEmpresa').addEventListener('click', async () => {
            modalTitulo.innerText = 'Nueva Empresa';
            formEmpresa.reset();
            empresaId.value = '';
            await llenarSelectMonedas();
            modal.style.display = 'flex';
        });

        // Cerrar modal
        document.getElementById('closeModal').addEventListener('click', () => {
            modal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // Guardar empresa (crear o actualizar)
        formEmpresa.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = empresaId.value;
            const data = {
                nombre: document.getElementById('nombre').value,
                rfc: document.getElementById('rfc').value,
                direccion: document.getElementById('direccion').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value,
                website: document.getElementById('website').value,
                moneda_id: document.getElementById('moneda_id').value,
                logo_url: document.getElementById('logo_url').value,
                tipo_empresa: document.getElementById('tipo_empresa').value,
                regimen_fiscal: document.getElementById('regimen_fiscal').value,
                activo: document.getElementById('activo').value === 'true'
            };

            let error;
            if (id) {
                // Actualizar
                const { error: updateError } = await supabase
                    .from('empresas')
                    .update(data)
                    .eq('id', id);
                error = updateError;
            } else {
                // Crear nuevo (sin id)
                const { error: insertError } = await supabase
                    .from('empresas')
                    .insert([data]);
                error = insertError;
            }

            if (error) {
                console.error('Error guardando empresa:', error);
                alert('Error al guardar la empresa');
            } else {
                modal.style.display = 'none';
                loadEmpresas();
            }
        });

        // Editar empresa
        window.editarEmpresa = async (id) => {
            const { data, error } = await supabase
                .from('empresas')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !data) {
                console.error('Error obteniendo empresa:', error);
                alert('No se pudo cargar la empresa');
                return;
            }

            modalTitulo.innerText = 'Editar Empresa';
            empresaId.value = data.id;
            document.getElementById('nombre').value = data.nombre || '';
            document.getElementById('rfc').value = data.rfc || '';
            document.getElementById('direccion').value = data.direccion || '';
            document.getElementById('telefono').value = data.telefono || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('website').value = data.website || '';
            document.getElementById('logo_url').value = data.logo_url || '';
            document.getElementById('tipo_empresa').value = data.tipo_empresa || '';
            document.getElementById('regimen_fiscal').value = data.regimen_fiscal || '';
            document.getElementById('activo').value = data.activo ? 'true' : 'false';

            await llenarSelectMonedas();
            document.getElementById('moneda_id').value = data.moneda_id || '';
            modal.style.display = 'flex';
        };

        // Eliminar empresa (con confirmación)
        window.eliminarEmpresa = async (id) => {
            if (!confirm('¿Está seguro de eliminar esta empresa? Esta acción puede afectar datos relacionados.')) return;

            const { error } = await supabase
                .from('empresas')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Error eliminando empresa:', error);
                alert('Error al eliminar la empresa');
            } else {
                loadEmpresas();
            }
        };

        // Cargar datos iniciales
        loadEmpresas();
    </script>
</body>
</html>
