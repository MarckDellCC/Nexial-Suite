<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Panel de Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        .role-check {
            background-color: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background-color: #34495e;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .tab-btn {
            background-color: #34495e;
            color: #ecf0f1;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .tab-btn:hover {
            background-color: #3d566e;
        }
        
        .tab-btn.active {
            background-color: #2c3e50;
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-section {
            margin-bottom: 30px;
        }
        
        .tab-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background-color: #2c3e50;
            color: white;
            text-align: left;
            padding: 12px 15px;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .data-table .actions {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .json-field {
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Control - Director Corporativo</h1>
            <button id="logoutBtn" class="logout-btn">Cerrar Sesión</button>
        </div>
        
        <div id="roleCheck" class="role-check">
            <h2>Acceso Denegado</h2>
            <p>Solo usuarios con rol "Director Corporativo" pueden acceder a este panel.</p>
            <p>Redirigiendo al inicio...</p>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" data-tab="empresas">Empresas</button>
                <button class="tab-btn" data-tab="usuarios">Usuarios</button>
                <button class="tab-btn" data-tab="empleados">Empleados</button>
                <button class="tab-btn" data-tab="clientes">Clientes</button>
                <button class="tab-btn" data-tab="productos">Productos</button>
                <button class="tab-btn" data-tab="ventas">Ventas</button>
                <button class="tab-btn" data-tab="monedas">Monedas</button>
                <button class="tab-btn" data-tab="config">Configuración</button>
            </div>
            
            <!-- Mensajes de estado -->
            <div id="message" class="message"></div>
            
            <!-- Loading indicator -->
            <div id="loading" class="loading">
                <p>Cargando datos...</p>
            </div>
            
            <!-- Tabla de Empresas -->
            <div id="empresas" class="tab-content active">
                <div class="tab-section">
                    <h3>Registrar Nueva Empresa</h3>
                    <form id="empresaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="empresa_nombre">Nombre *</label>
                                <input type="text" id="empresa_nombre" required>
                            </div>
                            <div class="form-group">
                                <label for="empresa_rfc">RFC *</label>
                                <input type="text" id="empresa_rfc" required>
                            </div>
                            <div class="form-group">
                                <label for="empresa_direccion">Dirección</label>
                                <textarea id="empresa_direccion"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="empresa_telefono">Teléfono</label>
                                <input type="text" id="empresa_telefono">
                            </div>
                            <div class="form-group">
                                <label for="empresa_email">Email</label>
                                <input type="email" id="empresa_email">
                            </div>
                            <div class="form-group">
                                <label for="empresa_website">Website</label>
                                <input type="text" id="empresa_website">
                            </div>
                            <div class="form-group">
                                <label for="empresa_moneda">Moneda</label>
                                <select id="empresa_moneda">
                                    <option value="">Seleccionar moneda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empresa_logo">Logo URL</label>
                                <input type="text" id="empresa_logo">
                            </div>
                            <div class="form-group">
                                <label for="empresa_tipo">Tipo de Empresa</label>
                                <input type="text" id="empresa_tipo" placeholder="Ej: SA de CV, SRL, etc.">
                            </div>
                            <div class="form-group">
                                <label for="empresa_regimen">Régimen Fiscal</label>
                                <input type="text" id="empresa_regimen">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Empresa</button>
                            <button type="button" id="clearEmpresaForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="empresa_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Empresas</h3>
                    <div class="search-box">
                        <input type="text" id="searchEmpresa" placeholder="Buscar empresa por nombre, RFC o email...">
                        <button id="searchEmpresaBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetEmpresaSearch" class="btn btn-warning">Mostrar Todas</button>
                    </div>
                    <div id="empresasTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Usuarios -->
            <div id="usuarios" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nuevo Usuario</h3>
                    <form id="usuarioForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="usuario_empresa">Empresa *</label>
                                <select id="usuario_empresa" required>
                                    <option value="">Seleccionar empresa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="usuario_empleado">Empleado</label>
                                <select id="usuario_empleado">
                                    <option value="">Seleccionar empleado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="usuario_nombres">Nombres *</label>
                                <input type="text" id="usuario_nombres" required>
                            </div>
                            <div class="form-group">
                                <label for="usuario_apellido_paterno">Apellido Paterno *</label>
                                <input type="text" id="usuario_apellido_paterno" required>
                            </div>
                            <div class="form-group">
                                <label for="usuario_apellido_materno">Apellido Materno</label>
                                <input type="text" id="usuario_apellido_materno">
                            </div>
                            <div class="form-group">
                                <label for="usuario_email">Email *</label>
                                <input type="email" id="usuario_email" required>
                            </div>
                            <div class="form-group">
                                <label for="usuario_usuario">Usuario *</label>
                                <input type="text" id="usuario_usuario" required>
                            </div>
                            <div class="form-group">
                                <label for="usuario_contrasena">Contraseña *</label>
                                <input type="password" id="usuario_contrasena" required>
                            </div>
                            <div class="form-group">
                                <label for="usuario_rol">Rol *</label>
                                <select id="usuario_rol" required>
                                    <option value="">Seleccionar rol</option>
                                    <option value="Director Corporativo">Director Corporativo</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Gerente">Gerente</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="Empleado">Empleado</option>
                                    <option value="Vendedor">Vendedor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="usuario_foto">Foto URL</label>
                                <input type="text" id="usuario_foto">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Usuario</button>
                            <button type="button" id="clearUsuarioForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="usuario_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Usuarios</h3>
                    <div class="search-box">
                        <input type="text" id="searchUsuario" placeholder="Buscar usuario por nombre, email o usuario...">
                        <button id="searchUsuarioBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetUsuarioSearch" class="btn btn-warning">Mostrar Todos</button>
                    </div>
                    <div id="usuariosTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Empleados -->
            <div id="empleados" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nuevo Empleado</h3>
                    <form id="empleadoForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="empleado_empresa">Empresa *</label>
                                <select id="empleado_empresa" required>
                                    <option value="">Seleccionar empresa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empleado_nombres">Nombres *</label>
                                <input type="text" id="empleado_nombres" required>
                            </div>
                            <div class="form-group">
                                <label for="empleado_apellido_paterno">Apellido Paterno *</label>
                                <input type="text" id="empleado_apellido_paterno" required>
                            </div>
                            <div class="form-group">
                                <label for="empleado_apellido_materno">Apellido Materno</label>
                                <input type="text" id="empleado_apellido_materno">
                            </div>
                            <div class="form-group">
                                <label for="empleado_documento">Documento de Identidad</label>
                                <input type="text" id="empleado_documento">
                            </div>
                            <div class="form-group">
                                <label for="empleado_tipo_documento">Tipo de Documento</label>
                                <select id="empleado_tipo_documento">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="DNI">DNI</option>
                                    <option value="CURP">CURP</option>
                                    <option value="RFC">RFC</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                    <option value="Licencia">Licencia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empleado_direccion">Dirección</label>
                                <textarea id="empleado_direccion"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="empleado_telefono">Teléfono</label>
                                <input type="text" id="empleado_telefono">
                            </div>
                            <div class="form-group">
                                <label for="empleado_email">Email</label>
                                <input type="email" id="empleado_email">
                            </div>
                            <div class="form-group">
                                <label for="empleado_fecha_nacimiento">Fecha de Nacimiento</label>
                                <input type="date" id="empleado_fecha_nacimiento">
                            </div>
                            <div class="form-group">
                                <label for="empleado_genero">Género</label>
                                <select id="empleado_genero">
                                    <option value="">Seleccionar</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empleado_foto">Foto URL</label>
                                <input type="text" id="empleado_foto">
                            </div>
                            <div class="form-group">
                                <label for="empleado_fecha_contratacion">Fecha de Contratación</label>
                                <input type="date" id="empleado_fecha_contratacion">
                            </div>
                            <div class="form-group">
                                <label for="empleado_salario">Salario Base</label>
                                <input type="number" step="0.01" id="empleado_salario">
                            </div>
                            <div class="form-group">
                                <label for="empleado_moneda">Moneda Salario</label>
                                <select id="empleado_moneda">
                                    <option value="">Seleccionar moneda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empleado_tipo_contrato">Tipo de Contrato</label>
                                <select id="empleado_tipo_contrato">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="Indefinido">Indefinido</option>
                                    <option value="Temporal">Temporal</option>
                                    <option value="Por Obra">Por Obra</option>
                                    <option value="Practicas">Prácticas</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Empleado</button>
                            <button type="button" id="clearEmpleadoForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="empleado_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Empleados</h3>
                    <div class="search-box">
                        <input type="text" id="searchEmpleado" placeholder="Buscar empleado por nombre, documento o email...">
                        <button id="searchEmpleadoBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetEmpleadoSearch" class="btn btn-warning">Mostrar Todos</button>
                    </div>
                    <div id="empleadosTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Clientes -->
            <div id="clientes" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nuevo Cliente</h3>
                    <form id="clienteForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="cliente_empresa">Empresa *</label>
                                <select id="cliente_empresa" required>
                                    <option value="">Seleccionar empresa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cliente_categoria">Categoría de Negocio</label>
                                <select id="cliente_categoria">
                                    <option value="">Seleccionar categoría</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cliente_nombres">Nombres *</label>
                                <input type="text" id="cliente_nombres" required>
                            </div>
                            <div class="form-group">
                                <label for="cliente_apellido_paterno">Apellido Paterno *</label>
                                <input type="text" id="cliente_apellido_paterno" required>
                            </div>
                            <div class="form-group">
                                <label for="cliente_apellido_materno">Apellido Materno</label>
                                <input type="text" id="cliente_apellido_materno">
                            </div>
                            <div class="form-group">
                                <label for="cliente_documento">Documento de Identidad</label>
                                <input type="text" id="cliente_documento">
                            </div>
                            <div class="form-group">
                                <label for="cliente_tipo_documento">Tipo de Documento</label>
                                <select id="cliente_tipo_documento">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="DNI">DNI</option>
                                    <option value="CURP">CURP</option>
                                    <option value="RFC">RFC</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                    <option value="Licencia">Licencia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cliente_ciudad">Ciudad</label>
                                <input type="text" id="cliente_ciudad">
                            </div>
                            <div class="form-group">
                                <label for="cliente_estado">Estado</label>
                                <input type="text" id="cliente_estado">
                            </div>
                            <div class="form-group">
                                <label for="cliente_pais">País</label>
                                <input type="text" id="cliente_pais">
                            </div>
                            <div class="form-group">
                                <label for="cliente_codigo_postal">Código Postal</label>
                                <input type="text" id="cliente_codigo_postal">
                            </div>
                            <div class="form-group">
                                <label for="cliente_telefono">Teléfono</label>
                                <input type="text" id="cliente_telefono">
                            </div>
                            <div class="form-group">
                                <label for="cliente_email">Email</label>
                                <input type="email" id="cliente_email">
                            </div>
                            <div class="form-group">
                                <label for="cliente_fecha_nacimiento">Fecha de Nacimiento</label>
                                <input type="date" id="cliente_fecha_nacimiento">
                            </div>
                            <div class="form-group">
                                <label for="cliente_genero">Género</label>
                                <select id="cliente_genero">
                                    <option value="">Seleccionar</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cliente_foto">Foto URL</label>
                                <input type="text" id="cliente_foto">
                            </div>
                            <div class="form-group">
                                <label for="cliente_direcciones">Direcciones (JSON)</label>
                                <textarea id="cliente_direcciones" class="json-field" placeholder='[{"tipo": "casa", "direccion": "Calle 123"}]'></textarea>
                            </div>
                            <div class="form-group">
                                <label for="cliente_horarios">Horarios de Apertura (JSON)</label>
                                <textarea id="cliente_horarios" class="json-field" placeholder='[{"dia": "Lunes", "apertura": "09:00", "cierre": "18:00"}]'></textarea>
                            </div>
                            <div class="form-group">
                                <label for="cliente_tipo">Tipo de Cliente</label>
                                <select id="cliente_tipo">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="Minorista">Minorista</option>
                                    <option value="Mayorista">Mayorista</option>
                                    <option value="Distribuidor">Distribuidor</option>
                                    <option value="Corporativo">Corporativo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cliente_limite_credito">Límite de Crédito</label>
                                <input type="number" step="0.01" id="cliente_limite_credito">
                            </div>
                            <div class="form-group">
                                <label for="cliente_dias_credito">Días de Crédito</label>
                                <input type="number" id="cliente_dias_credito">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                            <button type="button" id="clearClienteForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="cliente_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Clientes</h3>
                    <div class="search-box">
                        <input type="text" id="searchCliente" placeholder="Buscar cliente por nombre, documento o email...">
                        <button id="searchClienteBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetClienteSearch" class="btn btn-warning">Mostrar Todos</button>
                    </div>
                    <div id="clientesTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Productos -->
            <div id="productos" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nuevo Producto</h3>
                    <form id="productoForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="producto_empresa">Empresa *</label>
                                <select id="producto_empresa" required>
                                    <option value="">Seleccionar empresa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producto_codigo">Código *</label>
                                <input type="text" id="producto_codigo" required>
                            </div>
                            <div class="form-group">
                                <label for="producto_nombre">Nombre *</label>
                                <input type="text" id="producto_nombre" required>
                            </div>
                            <div class="form-group">
                                <label for="producto_descripcion">Descripción</label>
                                <textarea id="producto_descripcion"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="producto_categoria">Categoría</label>
                                <select id="producto_categoria">
                                    <option value="">Seleccionar categoría</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producto_precio_compra">Precio de Compra</label>
                                <input type="number" step="0.01" id="producto_precio_compra">
                            </div>
                            <div class="form-group">
                                <label for="producto_precio_venta">Precio de Venta *</label>
                                <input type="number" step="0.01" id="producto_precio_venta" required>
                            </div>
                            <div class="form-group">
                                <label for="producto_moneda">Moneda *</label>
                                <select id="producto_moneda" required>
                                    <option value="">Seleccionar moneda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producto_imagen">Imagen URL</label>
                                <input type="text" id="producto_imagen">
                            </div>
                            <div class="form-group">
                                <label for="producto_peso">Peso</label>
                                <input type="number" step="0.01" id="producto_peso">
                            </div>
                            <div class="form-group">
                                <label for="producto_dimensiones">Dimensiones</label>
                                <input type="text" id="producto_dimensiones" placeholder="Ej: 10x20x30 cm">
                            </div>
                            <div class="form-group">
                                <label for="producto_unidad_medida">Unidad de Medida</label>
                                <select id="producto_unidad_medida">
                                    <option value="">Seleccionar unidad</option>
                                    <option value="Unidad">Unidad</option>
                                    <option value="Kilogramo">Kilogramo</option>
                                    <option value="Gramo">Gramo</option>
                                    <option value="Litro">Litro</option>
                                    <option value="Mililitro">Mililitro</option>
                                    <option value="Metro">Metro</option>
                                    <option value="Centimetro">Centímetro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producto_es_clave">¿Es Producto Clave?</label>
                                <select id="producto_es_clave">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producto_compra_minima_cantidad">Compra Mínima (Cantidad)</label>
                                <input type="number" id="producto_compra_minima_cantidad" value="1">
                            </div>
                            <div class="form-group">
                                <label for="producto_compra_minima_monto">Compra Mínima (Monto)</label>
                                <input type="number" step="0.01" id="producto_compra_minima_monto" value="0">
                            </div>
                            <div class="form-group">
                                <label for="producto_compra_minima_peso">Compra Mínima (Peso)</label>
                                <input type="number" step="0.01" id="producto_compra_minima_peso" value="0">
                            </div>
                            <div class="form-group">
                                <label for="producto_codigo_barras">Código de Barras</label>
                                <input type="text" id="producto_codigo_barras">
                            </div>
                            <div class="form-group">
                                <label for="producto_ubicacion_almacen">Ubicación en Almacén</label>
                                <input type="text" id="producto_ubicacion_almacen">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Producto</button>
                            <button type="button" id="clearProductoForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="producto_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Productos</h3>
                    <div class="search-box">
                        <input type="text" id="searchProducto" placeholder="Buscar producto por código, nombre o descripción...">
                        <button id="searchProductoBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetProductoSearch" class="btn btn-warning">Mostrar Todos</button>
                    </div>
                    <div id="productosTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Ventas -->
            <div id="ventas" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nueva Venta</h3>
                    <form id="ventaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="venta_empresa">Empresa *</label>
                                <select id="venta_empresa" required>
                                    <option value="">Seleccionar empresa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_cliente">Cliente *</label>
                                <select id="venta_cliente" required>
                                    <option value="">Seleccionar cliente</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_empleado">Empleado</label>
                                <select id="venta_empleado">
                                    <option value="">Seleccionar empleado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_almacen">Almacén</label>
                                <select id="venta_almacen">
                                    <option value="">Seleccionar almacén</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_numero">Número de Venta *</label>
                                <input type="text" id="venta_numero" required>
                            </div>
                            <div class="form-group">
                                <label for="venta_fecha">Fecha</label>
                                <input type="datetime-local" id="venta_fecha">
                            </div>
                            <div class="form-group">
                                <label for="venta_subtotal">Subtotal *</label>
                                <input type="number" step="0.01" id="venta_subtotal" required>
                            </div>
                            <div class="form-group">
                                <label for="venta_impuesto">Impuesto *</label>
                                <input type="number" step="0.01" id="venta_impuesto" required>
                            </div>
                            <div class="form-group">
                                <label for="venta_total">Total *</label>
                                <input type="number" step="0.01" id="venta_total" required>
                            </div>
                            <div class="form-group">
                                <label for="venta_moneda">Moneda *</label>
                                <select id="venta_moneda" required>
                                    <option value="">Seleccionar moneda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_estado">Estado</label>
                                <select id="venta_estado">
                                    <option value="pendiente">Pendiente</option>
                                    <option value="completada">Completada</option>
                                    <option value="cancelada">Cancelada</option>
                                    <option value="devuelta">Devuelta</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_metodo_pago">Método de Pago</label>
                                <select id="venta_metodo_pago">
                                    <option value="">Seleccionar método</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta Crédito">Tarjeta Crédito</option>
                                    <option value="Tarjeta Débito">Tarjeta Débito</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_tipo">Tipo de Venta</label>
                                <select id="venta_tipo">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="Contado">Contado</option>
                                    <option value="Crédito">Crédito</option>
                                    <option value="Mayoreo">Mayoreo</option>
                                    <option value="Menudeo">Menudeo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="venta_observaciones">Observaciones</label>
                                <textarea id="venta_observaciones"></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Venta</button>
                            <button type="button" id="clearVentaForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="venta_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Ventas</h3>
                    <div class="search-box">
                        <input type="text" id="searchVenta" placeholder="Buscar venta por número, cliente o empleado...">
                        <button id="searchVentaBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetVentaSearch" class="btn btn-warning">Mostrar Todas</button>
                    </div>
                    <div id="ventasTableContainer"></div>
                </div>
            </div>
            
            <!-- Tabla de Monedas -->
            <div id="monedas" class="tab-content">
                <div class="tab-section">
                    <h3>Registrar Nueva Moneda</h3>
                    <form id="monedaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="moneda_codigo">Código *</label>
                                <input type="text" id="moneda_codigo" required maxlength="3" placeholder="Ej: USD, EUR, MXN">
                            </div>
                            <div class="form-group">
                                <label for="moneda_nombre">Nombre *</label>
                                <input type="text" id="moneda_nombre" required placeholder="Ej: Dólar Estadounidense">
                            </div>
                            <div class="form-group">
                                <label for="moneda_simbolo">Símbolo</label>
                                <input type="text" id="moneda_simbolo" placeholder="Ej: $, €, £">
                            </div>
                            <div class="form-group">
                                <label for="moneda_pais">País</label>
                                <input type="text" id="moneda_pais" placeholder="Ej: Estados Unidos">
                            </div>
                            <div class="form-group">
                                <label for="moneda_tasa_cambio">Tasa de Cambio</label>
                                <input type="number" step="0.000001" id="moneda_tasa_cambio" placeholder="1.000000">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Moneda</button>
                            <button type="button" id="clearMonedaForm" class="btn btn-warning">Limpiar Formulario</button>
                            <input type="hidden" id="moneda_id">
                        </div>
                    </form>
                </div>
                
                <div class="tab-section">
                    <h3>Lista de Monedas</h3>
                    <div class="search-box">
                        <input type="text" id="searchMoneda" placeholder="Buscar moneda por código, nombre o país...">
                        <button id="searchMonedaBtn" class="btn btn-primary">Buscar</button>
                        <button id="resetMonedaSearch" class="btn btn-warning">Mostrar Todas</button>
                    </div>
                    <div id="monedasTableContainer"></div>
                </div>
            </div>
            
            <!-- Configuración -->
            <div id="config" class="tab-content">
                <div class="tab-section">
                    <h3>Configuración del Sistema</h3>
                    <p>Esta sección permite configurar parámetros del sistema.</p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="config_supabase_url">Supabase URL</label>
                            <input type="text" id="config_supabase_url" value="https://bsbsvvszfxpzxsybzuvf.supabase.co" readonly>
                        </div>
                        <div class="form-group">
                            <label for="config_supabase_key">Supabase Anon Key</label>
                            <input type="text" id="config_supabase_key" value="sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-" readonly>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button id="testConnection" class="btn btn-primary">Probar Conexión a Supabase</button>
                        <button id="loadAllData" class="btn btn-success">Cargar Todos los Datos</button>
                        <button id="clearAllForms" class="btn btn-warning">Limpiar Todos los Formularios</button>
                    </div>
                </div>
                
                <div class="tab-section">
                    <h3>Estadísticas del Sistema</h3>
                    <div id="statsContainer">
                        <p>Cargando estadísticas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const supabaseAnonKey = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // Variables globales
        let currentUser = null;
        let empresas = [];
        let monedas = [];
        let categoriasNegocio = [];
        let categoriasProductos = [];
        let almacenes = [];
        
        // Función para mostrar mensajes
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // Función para mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        // Verificar rol del usuario
        async function checkUserRole() {
            showLoading(true);
            
            try {
                // Obtener sesión actual
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    throw sessionError;
                }
                
                if (!session) {
                    // No hay sesión activa
                    window.location.href = 'login.html';
                    return;
                }
                
                // Obtener información del usuario
                const { data: userData, error: userError } = await supabase.auth.getUser();
                
                if (userError) {
                    throw userError;
                }
                
                currentUser = userData.user;
                
                // Buscar el usuario en la tabla de usuarios
                const { data: usuarioData, error: usuarioError } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', currentUser.email)
                    .single();
                
                if (usuarioError || !usuarioData) {
                    showMessage('Usuario no encontrado en el sistema', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                // Verificar si es Director Corporativo
                if (usuarioData.rol !== 'Director Corporativo') {
                    document.getElementById('roleCheck').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    document.getElementById('roleCheck').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    loadInitialData();
                }
                
            } catch (error) {
                console.error('Error verificando rol:', error);
                showMessage('Error al verificar permisos de usuario', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } finally {
                showLoading(false);
            }
        }
        
        // Cargar datos iniciales
        async function loadInitialData() {
            showLoading(true);
            
            try {
                // Cargar empresas
                const { data: empresasData, error: empresasError } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('nombre');
                
                if (!empresasError) {
                    empresas = empresasData || [];
                    populateEmpresaSelects();
                }
                
                // Cargar monedas
                const { data: monedasData, error: monedasError } = await supabase
                    .from('monedas')
                    .select('*')
                    .order('codigo');
                
                if (!monedasError) {
                    monedas = monedasData || [];
                    populateMonedaSelects();
                }
                
                // Cargar categorías de negocio
                const { data: categoriasData, error: categoriasError } = await supabase
                    .from('categoria_negocios')
                    .select('*')
                    .order('nombre');
                
                if (!categoriasError) {
                    categoriasNegocio = categoriasData || [];
                    populateCategoriaNegocioSelect();
                }
                
                // Cargar categorías de productos
                const { data: catProductosData, error: catProductosError } = await supabase
                    .from('categoria_productos')
                    .select('*')
                    .order('nombre');
                
                if (!catProductosError) {
                    categoriasProductos = catProductosData || [];
                    populateCategoriaProductoSelect();
                }
                
                // Cargar almacenes
                const { data: almacenesData, error: almacenesError } = await supabase
                    .from('almacenes')
                    .select('*')
                    .order('nombre');
                
                if (!almacenesError) {
                    almacenes = almacenesData || [];
                    populateAlmacenSelects();
                }
                
                // Cargar datos de la primera pestaña
                loadEmpresas();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos iniciales', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Poblar selects de empresas
        function populateEmpresaSelects() {
            const selects = document.querySelectorAll('select[id$="_empresa"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Seleccionar empresa</option>';
                empresas.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa.id;
                    option.textContent = empresa.nombre;
                    select.appendChild(option);
                });
            });
        }
        
        // Poblar selects de monedas
        function populateMonedaSelects() {
            const selects = document.querySelectorAll('select[id$="_moneda"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Seleccionar moneda</option>';
                monedas.forEach(moneda => {
                    const option = document.createElement('option');
                    option.value = moneda.id;
                    option.textContent = `${moneda.codigo} - ${moneda.nombre}`;
                    select.appendChild(option);
                });
            });
        }
        
        // Poblar select de categorías de negocio
        function populateCategoriaNegocioSelect() {
            const select = document.getElementById('cliente_categoria');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar categoría</option>';
                categoriasNegocio.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nombre;
                    select.appendChild(option);
                });
            }
        }
        
        // Poblar select de categorías de productos
        function populateCategoriaProductoSelect() {
            const select = document.getElementById('producto_categoria');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar categoría</option>';
                categoriasProductos.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nombre;
                    select.appendChild(option);
                });
            }
        }
        
        // Poblar selects de almacenes
        function populateAlmacenSelects() {
            const selects = document.querySelectorAll('select[id$="_almacen"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Seleccionar almacén</option>';
                almacenes.forEach(almacen => {
                    const option = document.createElement('option');
                    option.value = almacen.id;
                    option.textContent = almacen.nombre;
                    select.appendChild(option);
                });
            });
        }
        
        // Cargar empleados para select
        async function loadEmpleadosForSelect(empresaId, selectId) {
            if (!empresaId) {
                document.getElementById(selectId).innerHTML = '<option value="">Seleccionar empleado</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('empleados')
                    .select('id, nombres, apellido_paterno, apellido_materno')
                    .eq('empresa_id', empresaId)
                    .eq('activo', true)
                    .order('nombres');
                
                if (!error) {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Seleccionar empleado</option>';
                    
                    data.forEach(empleado => {
                        const option = document.createElement('option');
                        option.value = empleado.id;
                        option.textContent = `${empleado.nombres} ${empleado.apellido_paterno} ${empleado.apellido_materno || ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando empleados:', error);
            }
        }
        
        // Cargar clientes para select
        async function loadClientesForSelect(empresaId, selectId) {
            if (!empresaId) {
                document.getElementById(selectId).innerHTML = '<option value="">Seleccionar cliente</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nombres, apellido_paterno, apellido_materno')
                    .eq('empresa_id', empresaId)
                    .eq('activo', true)
                    .order('nombres');
                
                if (!error) {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Seleccionar cliente</option>';
                    
                    data.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = `${cliente.nombres} ${cliente.apellido_paterno} ${cliente.apellido_materno || ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando clientes:', error);
            }
        }
        
        // ============================================
        // FUNCIONES PARA EMPRESAS
        // ============================================
        
        // Cargar empresas en tabla
        async function loadEmpresas(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('empresas')
                    .select('*')
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`nombre.ilike.%${searchTerm}%,rfc.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>RFC</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="7" style="text-align: center;">No hay empresas registradas</td></tr>`;
                } else {
                    data.forEach(empresa => {
                        html += `
                            <tr>
                                <td>${empresa.nombre || ''}</td>
                                <td>${empresa.rfc || ''}</td>
                                <td>${empresa.email || ''}</td>
                                <td>${empresa.telefono || ''}</td>
                                <td>${empresa.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(empresa.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editEmpresa('${empresa.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteEmpresa('${empresa.id}', '${empresa.nombre}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('empresasTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando empresas:', error);
                showMessage('Error al cargar empresas: ' + error.message, 'error');
                document.getElementById('empresasTableContainer').innerHTML = `<p>Error al cargar empresas: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar empresa
        window.editEmpresa = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('empresas')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('empresa_id').value = data.id;
                document.getElementById('empresa_nombre').value = data.nombre || '';
                document.getElementById('empresa_rfc').value = data.rfc || '';
                document.getElementById('empresa_direccion').value = data.direccion || '';
                document.getElementById('empresa_telefono').value = data.telefono || '';
                document.getElementById('empresa_email').value = data.email || '';
                document.getElementById('empresa_website').value = data.website || '';
                document.getElementById('empresa_moneda').value = data.moneda_id || '';
                document.getElementById('empresa_logo').value = data.logo_url || '';
                document.getElementById('empresa_tipo').value = data.tipo_empresa || '';
                document.getElementById('empresa_regimen').value = data.regimen_fiscal || '';
                
                // Cambiar texto del botón
                document.querySelector('#empresaForm button[type="submit"]').textContent = 'Actualizar Empresa';
                
                // Desplazarse al formulario
                document.getElementById('empresas').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Empresa cargada para edición');
                
            } catch (error) {
                console.error('Error cargando empresa:', error);
                showMessage('Error al cargar empresa: ' + error.message, 'error');
            }
        };
        
        // Eliminar empresa
        window.deleteEmpresa = async function(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar la empresa "${nombre}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('empresas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Empresa eliminada correctamente');
                loadEmpresas();
                
                // Actualizar lista de empresas en selects
                const { data: empresasData } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('nombre');
                
                empresas = empresasData || [];
                populateEmpresaSelects();
                
            } catch (error) {
                console.error('Error eliminando empresa:', error);
                showMessage('Error al eliminar empresa: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar empresa (crear o actualizar)
        document.getElementById('empresaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const empresaId = document.getElementById('empresa_id').value;
            const isEdit = empresaId !== '';
            
            const empresaData = {
                nombre: document.getElementById('empresa_nombre').value,
                rfc: document.getElementById('empresa_rfc').value,
                direccion: document.getElementById('empresa_direccion').value,
                telefono: document.getElementById('empresa_telefono').value,
                email: document.getElementById('empresa_email').value,
                website: document.getElementById('empresa_website').value,
                moneda_id: document.getElementById('empresa_moneda').value || null,
                logo_url: document.getElementById('empresa_logo').value || null,
                tipo_empresa: document.getElementById('empresa_tipo').value || null,
                regimen_fiscal: document.getElementById('empresa_regimen').value || null,
                activo: true,
                actualizado_en: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('empresas')
                        .update(empresaData)
                        .eq('id', empresaId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('empresas')
                        .insert([empresaData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Empresa ${isEdit ? 'actualizada' : 'creada'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('empresaForm').reset();
                document.getElementById('empresa_id').value = '';
                document.querySelector('#empresaForm button[type="submit"]').textContent = 'Guardar Empresa';
                
                // Recargar datos
                loadEmpresas();
                
                // Actualizar lista de empresas en selects
                const { data: empresasData } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('nombre');
                
                empresas = empresasData || [];
                populateEmpresaSelects();
                
            } catch (error) {
                console.error('Error guardando empresa:', error);
                showMessage('Error al guardar empresa: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA USUARIOS
        // ============================================
        
        // Cargar usuarios en tabla
        async function loadUsuarios(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('usuarios')
                    .select(`
                        *,
                        empresas(nombre),
                        empleados(nombres, apellido_paterno, apellido_materno)
                    `)
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`nombres.ilike.%${searchTerm}%,apellido_paterno.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%,usuario.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Empresa</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="8" style="text-align: center;">No hay usuarios registrados</td></tr>`;
                } else {
                    data.forEach(usuario => {
                        html += `
                            <tr>
                                <td>${usuario.usuario || ''}</td>
                                <td>${usuario.nombres || ''} ${usuario.apellido_paterno || ''} ${usuario.apellido_materno || ''}</td>
                                <td>${usuario.email || ''}</td>
                                <td>${usuario.rol || ''}</td>
                                <td>${usuario.empresas?.nombre || ''}</td>
                                <td>${usuario.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(usuario.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editUsuario('${usuario.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteUsuario('${usuario.id}', '${usuario.usuario}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('usuariosTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showMessage('Error al cargar usuarios: ' + error.message, 'error');
                document.getElementById('usuariosTableContainer').innerHTML = `<p>Error al cargar usuarios: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar usuario
        window.editUsuario = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('usuario_id').value = data.id;
                document.getElementById('usuario_empresa').value = data.empresa_id || '';
                document.getElementById('usuario_empleado').value = data.empleado_id || '';
                document.getElementById('usuario_nombres').value = data.nombres || '';
                document.getElementById('usuario_apellido_paterno').value = data.apellido_paterno || '';
                document.getElementById('usuario_apellido_materno').value = data.apellido_materno || '';
                document.getElementById('usuario_email').value = data.email || '';
                document.getElementById('usuario_usuario').value = data.usuario || '';
                document.getElementById('usuario_contrasena').value = '';
                document.getElementById('usuario_rol').value = data.rol || '';
                document.getElementById('usuario_foto').value = data.foto_url || '';
                
                // Cargar empleados para esta empresa
                if (data.empresa_id) {
                    loadEmpleadosForSelect(data.empresa_id, 'usuario_empleado');
                }
                
                // Cambiar texto del botón
                document.querySelector('#usuarioForm button[type="submit"]').textContent = 'Actualizar Usuario';
                
                // Desplazarse al formulario
                document.getElementById('usuarios').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Usuario cargado para edición');
                
            } catch (error) {
                console.error('Error cargando usuario:', error);
                showMessage('Error al cargar usuario: ' + error.message, 'error');
            }
        };
        
        // Eliminar usuario
        window.deleteUsuario = async function(id, usuario) {
            if (!confirm(`¿Está seguro de eliminar el usuario "${usuario}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('usuarios')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Usuario eliminado correctamente');
                loadUsuarios();
                
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showMessage('Error al eliminar usuario: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar usuario (crear o actualizar)
        document.getElementById('usuarioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const usuarioId = document.getElementById('usuario_id').value;
            const isEdit = usuarioId !== '';
            
            const usuarioData = {
                empresa_id: document.getElementById('usuario_empresa').value,
                empleado_id: document.getElementById('usuario_empleado').value || null,
                nombres: document.getElementById('usuario_nombres').value,
                apellido_paterno: document.getElementById('usuario_apellido_paterno').value,
                apellido_materno: document.getElementById('usuario_apellido_materno').value || null,
                email: document.getElementById('usuario_email').value,
                usuario: document.getElementById('usuario_usuario').value,
                rol: document.getElementById('usuario_rol').value,
                foto_url: document.getElementById('usuario_foto').value || null,
                activo: true,
                actualizado_en: new Date().toISOString()
            };
            
            // Solo incluir contraseña si se está creando o si se cambió
            const contrasena = document.getElementById('usuario_contrasena').value;
            if (contrasena) {
                usuarioData.contrasena_plano = contrasena;
            }
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('usuarios')
                        .update(usuarioData)
                        .eq('id', usuarioId);
                    
                    error = updateError;
                } else {
                    if (!contrasena) {
                        throw new Error('La contraseña es obligatoria para nuevos usuarios');
                    }
                    
                    const { error: insertError } = await supabase
                        .from('usuarios')
                        .insert([usuarioData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Usuario ${isEdit ? 'actualizado' : 'creado'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('usuarioForm').reset();
                document.getElementById('usuario_id').value = '';
                document.querySelector('#usuarioForm button[type="submit"]').textContent = 'Guardar Usuario';
                
                // Recargar datos
                loadUsuarios();
                
            } catch (error) {
                console.error('Error guardando usuario:', error);
                showMessage('Error al guardar usuario: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA EMPLEADOS
        // ============================================
        
        // Cargar empleados en tabla
        async function loadEmpleados(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('empleados')
                    .select(`
                        *,
                        empresas(nombre),
                        monedas(codigo, nombre)
                    `)
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`nombres.ilike.%${searchTerm}%,apellido_paterno.ilike.%${searchTerm}%,documento_identidad.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Documento</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Empresa</th>
                                <th>Salario</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="9" style="text-align: center;">No hay empleados registrados</td></tr>`;
                } else {
                    data.forEach(empleado => {
                        const salario = empleado.salario_base ? 
                            `${empleado.salario_base} ${empleado.monedas?.codigo || ''}` : 
                            'N/A';
                        
                        html += `
                            <tr>
                                <td>${empleado.nombres || ''} ${empleado.apellido_paterno || ''} ${empleado.apellido_materno || ''}</td>
                                <td>${empleado.documento_identidad || ''}</td>
                                <td>${empleado.email || ''}</td>
                                <td>${empleado.telefono || ''}</td>
                                <td>${empleado.empresas?.nombre || ''}</td>
                                <td>${salario}</td>
                                <td>${empleado.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(empleado.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editEmpleado('${empleado.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteEmpleado('${empleado.id}', '${empleado.nombres}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('empleadosTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando empleados:', error);
                showMessage('Error al cargar empleados: ' + error.message, 'error');
                document.getElementById('empleadosTableContainer').innerHTML = `<p>Error al cargar empleados: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar empleado
        window.editEmpleado = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('empleados')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('empleado_id').value = data.id;
                document.getElementById('empleado_empresa').value = data.empresa_id || '';
                document.getElementById('empleado_nombres').value = data.nombres || '';
                document.getElementById('empleado_apellido_paterno').value = data.apellido_paterno || '';
                document.getElementById('empleado_apellido_materno').value = data.apellido_materno || '';
                document.getElementById('empleado_documento').value = data.documento_identidad || '';
                document.getElementById('empleado_tipo_documento').value = data.tipo_documento || '';
                document.getElementById('empleado_direccion').value = data.direccion || '';
                document.getElementById('empleado_telefono').value = data.telefono || '';
                document.getElementById('empleado_email').value = data.email || '';
                document.getElementById('empleado_fecha_nacimiento').value = data.fecha_nacimiento || '';
                document.getElementById('empleado_genero').value = data.genero || '';
                document.getElementById('empleado_foto').value = data.foto_url || '';
                document.getElementById('empleado_fecha_contratacion').value = data.fecha_contratacion || '';
                document.getElementById('empleado_salario').value = data.salario_base || '';
                document.getElementById('empleado_moneda').value = data.moneda_id || '';
                document.getElementById('empleado_tipo_contrato').value = data.tipo_contrato || '';
                
                // Cambiar texto del botón
                document.querySelector('#empleadoForm button[type="submit"]').textContent = 'Actualizar Empleado';
                
                // Desplazarse al formulario
                document.getElementById('empleados').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Empleado cargado para edición');
                
            } catch (error) {
                console.error('Error cargando empleado:', error);
                showMessage('Error al cargar empleado: ' + error.message, 'error');
            }
        };
        
        // Eliminar empleado
        window.deleteEmpleado = async function(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar al empleado "${nombre}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('empleados')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Empleado eliminado correctamente');
                loadEmpleados();
                
            } catch (error) {
                console.error('Error eliminando empleado:', error);
                showMessage('Error al eliminar empleado: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar empleado (crear o actualizar)
        document.getElementById('empleadoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const empleadoId = document.getElementById('empleado_id').value;
            const isEdit = empleadoId !== '';
            
            const empleadoData = {
                empresa_id: document.getElementById('empleado_empresa').value,
                nombres: document.getElementById('empleado_nombres').value,
                apellido_paterno: document.getElementById('empleado_apellido_paterno').value,
                apellido_materno: document.getElementById('empleado_apellido_materno').value || null,
                documento_identidad: document.getElementById('empleado_documento').value || null,
                tipo_documento: document.getElementById('empleado_tipo_documento').value || null,
                direccion: document.getElementById('empleado_direccion').value || null,
                telefono: document.getElementById('empleado_telefono').value || null,
                email: document.getElementById('empleado_email').value || null,
                fecha_nacimiento: document.getElementById('empleado_fecha_nacimiento').value || null,
                genero: document.getElementById('empleado_genero').value || null,
                foto_url: document.getElementById('empleado_foto').value || null,
                fecha_contratacion: document.getElementById('empleado_fecha_contratacion').value || null,
                salario_base: document.getElementById('empleado_salario').value || null,
                moneda_id: document.getElementById('empleado_moneda').value || null,
                tipo_contrato: document.getElementById('empleado_tipo_contrato').value || null,
                activo: true,
                actualizado_en: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('empleados')
                        .update(empleadoData)
                        .eq('id', empleadoId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('empleados')
                        .insert([empleadoData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Empleado ${isEdit ? 'actualizado' : 'creado'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('empleadoForm').reset();
                document.getElementById('empleado_id').value = '';
                document.querySelector('#empleadoForm button[type="submit"]').textContent = 'Guardar Empleado';
                
                // Recargar datos
                loadEmpleados();
                
            } catch (error) {
                console.error('Error guardando empleado:', error);
                showMessage('Error al guardar empleado: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA CLIENTES
        // ============================================
        
        // Cargar clientes en tabla
        async function loadClientes(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('clientes')
                    .select(`
                        *,
                        empresas(nombre),
                        categoria_negocios(nombre)
                    `)
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`nombres.ilike.%${searchTerm}%,apellido_paterno.ilike.%${searchTerm}%,documento_identidad.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Documento</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Ciudad</th>
                                <th>Empresa</th>
                                <th>Tipo</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="10" style="text-align: center;">No hay clientes registrados</td></tr>`;
                } else {
                    data.forEach(cliente => {
                        html += `
                            <tr>
                                <td>${cliente.nombres || ''} ${cliente.apellido_paterno || ''} ${cliente.apellido_materno || ''}</td>
                                <td>${cliente.documento_identidad || ''}</td>
                                <td>${cliente.email || ''}</td>
                                <td>${cliente.telefono || ''}</td>
                                <td>${cliente.ciudad || ''}</td>
                                <td>${cliente.empresas?.nombre || ''}</td>
                                <td>${cliente.tipo_cliente || ''}</td>
                                <td>${cliente.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(cliente.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editCliente('${cliente.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteCliente('${cliente.id}', '${cliente.nombres}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('clientesTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando clientes:', error);
                showMessage('Error al cargar clientes: ' + error.message, 'error');
                document.getElementById('clientesTableContainer').innerHTML = `<p>Error al cargar clientes: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar cliente
        window.editCliente = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('cliente_id').value = data.id;
                document.getElementById('cliente_empresa').value = data.empresa_id || '';
                document.getElementById('cliente_categoria').value = data.categoria_negocio_id || '';
                document.getElementById('cliente_nombres').value = data.nombres || '';
                document.getElementById('cliente_apellido_paterno').value = data.apellido_paterno || '';
                document.getElementById('cliente_apellido_materno').value = data.apellido_materno || '';
                document.getElementById('cliente_documento').value = data.documento_identidad || '';
                document.getElementById('cliente_tipo_documento').value = data.tipo_documento || '';
                document.getElementById('cliente_ciudad').value = data.ciudad || '';
                document.getElementById('cliente_estado').value = data.estado || '';
                document.getElementById('cliente_pais').value = data.pais || '';
                document.getElementById('cliente_codigo_postal').value = data.codigo_postal || '';
                document.getElementById('cliente_telefono').value = data.telefono || '';
                document.getElementById('cliente_email').value = data.email || '';
                document.getElementById('cliente_fecha_nacimiento').value = data.fecha_nacimiento || '';
                document.getElementById('cliente_genero').value = data.genero || '';
                document.getElementById('cliente_foto').value = data.foto_url || '';
                document.getElementById('cliente_direcciones').value = data.direcciones ? JSON.stringify(data.direcciones, null, 2) : '';
                document.getElementById('cliente_horarios').value = data.horarios_apertura ? JSON.stringify(data.horarios_apertura, null, 2) : '';
                document.getElementById('cliente_tipo').value = data.tipo_cliente || '';
                document.getElementById('cliente_limite_credito').value = data.limite_credito || '';
                document.getElementById('cliente_dias_credito').value = data.dias_credito || '';
                
                // Cambiar texto del botón
                document.querySelector('#clienteForm button[type="submit"]').textContent = 'Actualizar Cliente';
                
                // Desplazarse al formulario
                document.getElementById('clientes').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Cliente cargado para edición');
                
            } catch (error) {
                console.error('Error cargando cliente:', error);
                showMessage('Error al cargar cliente: ' + error.message, 'error');
            }
        };
        
        // Eliminar cliente
        window.deleteCliente = async function(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar al cliente "${nombre}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('clientes')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Cliente eliminado correctamente');
                loadClientes();
                
            } catch (error) {
                console.error('Error eliminando cliente:', error);
                showMessage('Error al eliminar cliente: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar cliente (crear o actualizar)
        document.getElementById('clienteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const clienteId = document.getElementById('cliente_id').value;
            const isEdit = clienteId !== '';
            
            // Procesar campos JSON
            let direcciones = [];
            let horarios = [];
            
            try {
                const direccionesText = document.getElementById('cliente_direcciones').value;
                if (direccionesText) {
                    direcciones = JSON.parse(direccionesText);
                }
            } catch (e) {
                showMessage('Error en el formato JSON de direcciones', 'error');
                return;
            }
            
            try {
                const horariosText = document.getElementById('cliente_horarios').value;
                if (horariosText) {
                    horarios = JSON.parse(horariosText);
                }
            } catch (e) {
                showMessage('Error en el formato JSON de horarios', 'error');
                return;
            }
            
            const clienteData = {
                empresa_id: document.getElementById('cliente_empresa').value,
                categoria_negocio_id: document.getElementById('cliente_categoria').value || null,
                nombres: document.getElementById('cliente_nombres').value,
                apellido_paterno: document.getElementById('cliente_apellido_paterno').value,
                apellido_materno: document.getElementById('cliente_apellido_materno').value || null,
                documento_identidad: document.getElementById('cliente_documento').value || null,
                tipo_documento: document.getElementById('cliente_tipo_documento').value || null,
                ciudad: document.getElementById('cliente_ciudad').value || null,
                estado: document.getElementById('cliente_estado').value || null,
                pais: document.getElementById('cliente_pais').value || null,
                codigo_postal: document.getElementById('cliente_codigo_postal').value || null,
                telefono: document.getElementById('cliente_telefono').value || null,
                email: document.getElementById('cliente_email').value || null,
                fecha_nacimiento: document.getElementById('cliente_fecha_nacimiento').value || null,
                genero: document.getElementById('cliente_genero').value || null,
                foto_url: document.getElementById('cliente_foto').value || null,
                direcciones: direcciones,
                horarios_apertura: horarios,
                tipo_cliente: document.getElementById('cliente_tipo').value || null,
                limite_credito: document.getElementById('cliente_limite_credito').value || null,
                dias_credito: document.getElementById('cliente_dias_credito').value || null,
                activo: true,
                actualizado_en: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('clientes')
                        .update(clienteData)
                        .eq('id', clienteId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('clientes')
                        .insert([clienteData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Cliente ${isEdit ? 'actualizado' : 'creado'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('clienteForm').reset();
                document.getElementById('cliente_id').value = '';
                document.querySelector('#clienteForm button[type="submit"]').textContent = 'Guardar Cliente';
                
                // Recargar datos
                loadClientes();
                
            } catch (error) {
                console.error('Error guardando cliente:', error);
                showMessage('Error al guardar cliente: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA PRODUCTOS
        // ============================================
        
        // Cargar productos en tabla
        async function loadProductos(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('productos')
                    .select(`
                        *,
                        empresas(nombre),
                        categoria_productos(nombre),
                        monedas(codigo)
                    `)
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`codigo.ilike.%${searchTerm}%,nombre.ilike.%${searchTerm}%,descripcion.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio Venta</th>
                                <th>Empresa</th>
                                <th>Es Clave</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="9" style="text-align: center;">No hay productos registrados</td></tr>`;
                } else {
                    data.forEach(producto => {
                        html += `
                            <tr>
                                <td>${producto.codigo || ''}</td>
                                <td>${producto.nombre || ''}</td>
                                <td>${producto.categoria_productos?.nombre || ''}</td>
                                <td>${producto.precio_venta || 0} ${producto.monedas?.codigo || ''}</td>
                                <td>${producto.empresas?.nombre || ''}</td>
                                <td>${producto.es_producto_clave ? 'Sí' : 'No'}</td>
                                <td>${producto.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(producto.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editProducto('${producto.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteProducto('${producto.id}', '${producto.nombre}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('productosTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                showMessage('Error al cargar productos: ' + error.message, 'error');
                document.getElementById('productosTableContainer').innerHTML = `<p>Error al cargar productos: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar producto
        window.editProducto = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('productos')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('producto_id').value = data.id;
                document.getElementById('producto_empresa').value = data.empresa_id || '';
                document.getElementById('producto_codigo').value = data.codigo || '';
                document.getElementById('producto_nombre').value = data.nombre || '';
                document.getElementById('producto_descripcion').value = data.descripcion || '';
                document.getElementById('producto_categoria').value = data.categoria_id || '';
                document.getElementById('producto_precio_compra').value = data.precio_compra || '';
                document.getElementById('producto_precio_venta').value = data.precio_venta || '';
                document.getElementById('producto_moneda').value = data.moneda_id || '';
                document.getElementById('producto_imagen').value = data.imagen_url || '';
                document.getElementById('producto_peso').value = data.peso || '';
                document.getElementById('producto_dimensiones').value = data.dimensiones || '';
                document.getElementById('producto_unidad_medida').value = data.unidad_medida || '';
                document.getElementById('producto_es_clave').value = data.es_producto_clave ? 'true' : 'false';
                document.getElementById('producto_compra_minima_cantidad').value = data.compra_minima_cantidad || 1;
                document.getElementById('producto_compra_minima_monto').value = data.compra_minima_monto || 0;
                document.getElementById('producto_compra_minima_peso').value = data.compra_minima_peso || 0;
                document.getElementById('producto_codigo_barras').value = data.codigo_barras || '';
                document.getElementById('producto_ubicacion_almacen').value = data.ubicacion_almacen || '';
                
                // Cambiar texto del botón
                document.querySelector('#productoForm button[type="submit"]').textContent = 'Actualizar Producto';
                
                // Desplazarse al formulario
                document.getElementById('productos').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Producto cargado para edición');
                
            } catch (error) {
                console.error('Error cargando producto:', error);
                showMessage('Error al cargar producto: ' + error.message, 'error');
            }
        };
        
        // Eliminar producto
        window.deleteProducto = async function(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar el producto "${nombre}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('productos')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Producto eliminado correctamente');
                loadProductos();
                
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showMessage('Error al eliminar producto: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar producto (crear o actualizar)
        document.getElementById('productoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productoId = document.getElementById('producto_id').value;
            const isEdit = productoId !== '';
            
            const productoData = {
                empresa_id: document.getElementById('producto_empresa').value,
                codigo: document.getElementById('producto_codigo').value,
                nombre: document.getElementById('producto_nombre').value,
                descripcion: document.getElementById('producto_descripcion').value || null,
                categoria_id: document.getElementById('producto_categoria').value || null,
                precio_compra: document.getElementById('producto_precio_compra').value || null,
                precio_venta: document.getElementById('producto_precio_venta').value,
                moneda_id: document.getElementById('producto_moneda').value,
                imagen_url: document.getElementById('producto_imagen').value || null,
                peso: document.getElementById('producto_peso').value || null,
                dimensiones: document.getElementById('producto_dimensiones').value || null,
                unidad_medida: document.getElementById('producto_unidad_medida').value || null,
                es_producto_clave: document.getElementById('producto_es_clave').value === 'true',
                compra_minima_cantidad: document.getElementById('producto_compra_minima_cantidad').value || 1,
                compra_minima_monto: document.getElementById('producto_compra_minima_monto').value || 0,
                compra_minima_peso: document.getElementById('producto_compra_minima_peso').value || 0,
                codigo_barras: document.getElementById('producto_codigo_barras').value || null,
                ubicacion_almacen: document.getElementById('producto_ubicacion_almacen').value || null,
                activo: true,
                actualizado_en: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('productos')
                        .update(productoData)
                        .eq('id', productoId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('productos')
                        .insert([productoData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Producto ${isEdit ? 'actualizado' : 'creado'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('productoForm').reset();
                document.getElementById('producto_id').value = '';
                document.querySelector('#productoForm button[type="submit"]').textContent = 'Guardar Producto';
                
                // Recargar datos
                loadProductos();
                
            } catch (error) {
                console.error('Error guardando producto:', error);
                showMessage('Error al guardar producto: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA VENTAS
        // ============================================
        
        // Cargar ventas en tabla
        async function loadVentas(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('ventas')
                    .select(`
                        *,
                        empresas(nombre),
                        clientes(nombres, apellido_paterno, apellido_materno),
                        empleados(nombres, apellido_paterno),
                        almacenes(nombre),
                        monedas(codigo)
                    `)
                    .order('creado_en', { ascending: false });
                
                if (searchTerm) {
                    query = query.or(`numero_venta.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Empleado</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Método Pago</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="9" style="text-align: center;">No hay ventas registradas</td></tr>`;
                } else {
                    data.forEach(venta => {
                        html += `
                            <tr>
                                <td>${venta.numero_venta || ''}</td>
                                <td>${venta.clientes?.nombres || ''} ${venta.clientes?.apellido_paterno || ''}</td>
                                <td>${venta.empleados?.nombres || ''} ${venta.empleados?.apellido_paterno || ''}</td>
                                <td>${new Date(venta.fecha).toLocaleDateString()}</td>
                                <td>${venta.total || 0} ${venta.monedas?.codigo || ''}</td>
                                <td>${venta.estado || ''}</td>
                                <td>${venta.metodo_pago || ''}</td>
                                <td>${new Date(venta.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editVenta('${venta.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteVenta('${venta.id}', '${venta.numero_venta}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('ventasTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando ventas:', error);
                showMessage('Error al cargar ventas: ' + error.message, 'error');
                document.getElementById('ventasTableContainer').innerHTML = `<p>Error al cargar ventas: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar venta
        window.editVenta = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('ventas')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('venta_id').value = data.id;
                document.getElementById('venta_empresa').value = data.empresa_id || '';
                document.getElementById('venta_cliente').value = data.cliente_id || '';
                document.getElementById('venta_empleado').value = data.empleado_id || '';
                document.getElementById('venta_almacen').value = data.almacen_id || '';
                document.getElementById('venta_numero').value = data.numero_venta || '';
                
                // Formatear fecha para input datetime-local
                const fecha = new Date(data.fecha);
                const fechaFormatted = fecha.toISOString().slice(0, 16);
                document.getElementById('venta_fecha').value = fechaFormatted;
                
                document.getElementById('venta_subtotal').value = data.subtotal || 0;
                document.getElementById('venta_impuesto').value = data.impuesto || 0;
                document.getElementById('venta_total').value = data.total || 0;
                document.getElementById('venta_moneda').value = data.moneda_id || '';
                document.getElementById('venta_estado').value = data.estado || 'pendiente';
                document.getElementById('venta_metodo_pago').value = data.metodo_pago || '';
                document.getElementById('venta_tipo').value = data.tipo_venta || '';
                document.getElementById('venta_observaciones').value = data.observaciones || '';
                
                // Cargar clientes y empleados para esta empresa
                if (data.empresa_id) {
                    loadClientesForSelect(data.empresa_id, 'venta_cliente');
                    loadEmpleadosForSelect(data.empresa_id, 'venta_empleado');
                }
                
                // Cambiar texto del botón
                document.querySelector('#ventaForm button[type="submit"]').textContent = 'Actualizar Venta';
                
                // Desplazarse al formulario
                document.getElementById('ventas').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Venta cargada para edición');
                
            } catch (error) {
                console.error('Error cargando venta:', error);
                showMessage('Error al cargar venta: ' + error.message, 'error');
            }
        };
        
        // Eliminar venta
        window.deleteVenta = async function(id, numero) {
            if (!confirm(`¿Está seguro de eliminar la venta "${numero}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('ventas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Venta eliminada correctamente');
                loadVentas();
                
            } catch (error) {
                console.error('Error eliminando venta:', error);
                showMessage('Error al eliminar venta: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar venta (crear o actualizar)
        document.getElementById('ventaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ventaId = document.getElementById('venta_id').value;
            const isEdit = ventaId !== '';
            
            const ventaData = {
                empresa_id: document.getElementById('venta_empresa').value,
                cliente_id: document.getElementById('venta_cliente').value,
                empleado_id: document.getElementById('venta_empleado').value || null,
                almacen_id: document.getElementById('venta_almacen').value || null,
                numero_venta: document.getElementById('venta_numero').value,
                fecha: document.getElementById('venta_fecha').value || new Date().toISOString(),
                subtotal: document.getElementById('venta_subtotal').value,
                impuesto: document.getElementById('venta_impuesto').value,
                total: document.getElementById('venta_total').value,
                moneda_id: document.getElementById('venta_moneda').value,
                estado: document.getElementById('venta_estado').value,
                metodo_pago: document.getElementById('venta_metodo_pago').value || null,
                tipo_venta: document.getElementById('venta_tipo').value || null,
                observaciones: document.getElementById('venta_observaciones').value || null,
                actualizado_en: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('ventas')
                        .update(ventaData)
                        .eq('id', ventaId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('ventas')
                        .insert([ventaData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Venta ${isEdit ? 'actualizada' : 'creada'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('ventaForm').reset();
                document.getElementById('venta_id').value = '';
                document.querySelector('#ventaForm button[type="submit"]').textContent = 'Guardar Venta';
                
                // Recargar datos
                loadVentas();
                
            } catch (error) {
                console.error('Error guardando venta:', error);
                showMessage('Error al guardar venta: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES PARA MONEDAS
        // ============================================
        
        // Cargar monedas en tabla
        async function loadMonedas(searchTerm = '') {
            showLoading(true);
            
            try {
                let query = supabase
                    .from('monedas')
                    .select('*')
                    .order('codigo');
                
                if (searchTerm) {
                    query = query.or(`codigo.ilike.%${searchTerm}%,nombre.ilike.%${searchTerm}%,pais.ilike.%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Símbolo</th>
                                <th>País</th>
                                <th>Tasa Cambio</th>
                                <th>Activo</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="8" style="text-align: center;">No hay monedas registradas</td></tr>`;
                } else {
                    data.forEach(moneda => {
                        html += `
                            <tr>
                                <td>${moneda.codigo || ''}</td>
                                <td>${moneda.nombre || ''}</td>
                                <td>${moneda.simbolo || ''}</td>
                                <td>${moneda.pais || ''}</td>
                                <td>${moneda.tasa_cambio || ''}</td>
                                <td>${moneda.activo ? 'Sí' : 'No'}</td>
                                <td>${new Date(moneda.creado_en).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="action-btn btn-primary" onclick="editMoneda('${moneda.id}')">Editar</button>
                                    <button class="action-btn btn-danger" onclick="deleteMoneda('${moneda.id}', '${moneda.codigo}')">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('monedasTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando monedas:', error);
                showMessage('Error al cargar monedas: ' + error.message, 'error');
                document.getElementById('monedasTableContainer').innerHTML = `<p>Error al cargar monedas: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        // Editar moneda
        window.editMoneda = async function(id) {
            try {
                const { data, error } = await supabase
                    .from('monedas')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar formulario
                document.getElementById('moneda_id').value = data.id;
                document.getElementById('moneda_codigo').value = data.codigo || '';
                document.getElementById('moneda_nombre').value = data.nombre || '';
                document.getElementById('moneda_simbolo').value = data.simbolo || '';
                document.getElementById('moneda_pais').value = data.pais || '';
                document.getElementById('moneda_tasa_cambio').value = data.tasa_cambio || '';
                
                // Cambiar texto del botón
                document.querySelector('#monedaForm button[type="submit"]').textContent = 'Actualizar Moneda';
                
                // Desplazarse al formulario
                document.getElementById('monedas').scrollIntoView({ behavior: 'smooth' });
                
                showMessage('Moneda cargada para edición');
                
            } catch (error) {
                console.error('Error cargando moneda:', error);
                showMessage('Error al cargar moneda: ' + error.message, 'error');
            }
        };
        
        // Eliminar moneda
        window.deleteMoneda = async function(id, codigo) {
            if (!confirm(`¿Está seguro de eliminar la moneda "${codigo}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabase
                    .from('monedas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Moneda eliminada correctamente');
                loadMonedas();
                
                // Actualizar lista de monedas en selects
                const { data: monedasData } = await supabase
                    .from('monedas')
                    .select('*')
                    .order('codigo');
                
                monedas = monedasData || [];
                populateMonedaSelects();
                
            } catch (error) {
                console.error('Error eliminando moneda:', error);
                showMessage('Error al eliminar moneda: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Guardar moneda (crear o actualizar)
        document.getElementById('monedaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const monedaId = document.getElementById('moneda_id').value;
            const isEdit = monedaId !== '';
            
            const monedaData = {
                codigo: document.getElementById('moneda_codigo').value,
                nombre: document.getElementById('moneda_nombre').value,
                simbolo: document.getElementById('moneda_simbolo').value || null,
                pais: document.getElementById('moneda_pais').value || null,
                tasa_cambio: document.getElementById('moneda_tasa_cambio').value || null,
                activo: true
            };
            
            showLoading(true);
            
            try {
                let error;
                
                if (isEdit) {
                    const { error: updateError } = await supabase
                        .from('monedas')
                        .update(monedaData)
                        .eq('id', monedaId);
                    
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('monedas')
                        .insert([monedaData]);
                    
                    error = insertError;
                }
                
                if (error) throw error;
                
                showMessage(`Moneda ${isEdit ? 'actualizada' : 'creada'} correctamente`);
                
                // Limpiar formulario
                document.getElementById('monedaForm').reset();
                document.getElementById('moneda_id').value = '';
                document.querySelector('#monedaForm button[type="submit"]').textContent = 'Guardar Moneda';
                
                // Recargar datos
                loadMonedas();
                
                // Actualizar lista de monedas en selects
                const { data: monedasData } = await supabase
                    .from('monedas')
                    .select('*')
                    .order('codigo');
                
                monedas = monedasData || [];
                populateMonedaSelects();
                
            } catch (error) {
                console.error('Error guardando moneda:', error);
                showMessage('Error al guardar moneda: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // ============================================
        // FUNCIONES AUXILIARES Y EVENT LISTENERS
        // ============================================
        
        // Navegación por pestañas
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remover clase active de todos los botones y contenidos
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Agregar clase active al botón clickeado
                button.classList.add('active');
                
                // Mostrar el contenido correspondiente
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Cargar datos de la pestaña si es necesario
                switch(tabId) {
                    case 'empresas':
                        loadEmpresas();
                        break;
                    case 'usuarios':
                        loadUsuarios();
                        break;
                    case 'empleados':
                        loadEmpleados();
                        break;
                    case 'clientes':
                        loadClientes();
                        break;
                    case 'productos':
                        loadProductos();
                        break;
                    case 'ventas':
                        loadVentas();
                        break;
                    case 'monedas':
                        loadMonedas();
                        break;
                    case 'config':
                        loadStats();
                        break;
                }
            });
        });
        
        // Cargar empleados cuando se selecciona empresa en formulario de usuario
        document.getElementById('usuario_empresa').addEventListener('change', function() {
            loadEmpleadosForSelect(this.value, 'usuario_empleado');
        });
        
        // Cargar clientes y empleados cuando se selecciona empresa en formulario de venta
        document.getElementById('venta_empresa').addEventListener('change', function() {
            loadClientesForSelect(this.value, 'venta_cliente');
            loadEmpleadosForSelect(this.value, 'venta_empleado');
        });
        
        // Limpiar formularios
        document.getElementById('clearEmpresaForm').addEventListener('click', () => {
            document.getElementById('empresaForm').reset();
            document.getElementById('empresa_id').value = '';
            document.querySelector('#empresaForm button[type="submit"]').textContent = 'Guardar Empresa';
        });
        
        document.getElementById('clearUsuarioForm').addEventListener('click', () => {
            document.getElementById('usuarioForm').reset();
            document.getElementById('usuario_id').value = '';
            document.querySelector('#usuarioForm button[type="submit"]').textContent = 'Guardar Usuario';
        });
        
        document.getElementById('clearEmpleadoForm').addEventListener('click', () => {
            document.getElementById('empleadoForm').reset();
            document.getElementById('empleado_id').value = '';
            document.querySelector('#empleadoForm button[type="submit"]').textContent = 'Guardar Empleado';
        });
        
        document.getElementById('clearClienteForm').addEventListener('click', () => {
            document.getElementById('clienteForm').reset();
            document.getElementById('cliente_id').value = '';
            document.querySelector('#clienteForm button[type="submit"]').textContent = 'Guardar Cliente';
        });
        
        document.getElementById('clearProductoForm').addEventListener('click', () => {
            document.getElementById('productoForm').reset();
            document.getElementById('producto_id').value = '';
            document.querySelector('#productoForm button[type="submit"]').textContent = 'Guardar Producto';
        });
        
        document.getElementById('clearVentaForm').addEventListener('click', () => {
            document.getElementById('ventaForm').reset();
            document.getElementById('venta_id').value = '';
            document.querySelector('#ventaForm button[type="submit"]').textContent = 'Guardar Venta';
        });
        
        document.getElementById('clearMonedaForm').addEventListener('click', () => {
            document.getElementById('monedaForm').reset();
            document.getElementById('moneda_id').value = '';
            document.querySelector('#monedaForm button[type="submit"]').textContent = 'Guardar Moneda';
        });
        
        // Búsquedas
        document.getElementById('searchEmpresaBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchEmpresa').value;
            loadEmpresas(searchTerm);
        });
        
        document.getElementById('searchUsuarioBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchUsuario').value;
            loadUsuarios(searchTerm);
        });
        
        document.getElementById('searchEmpleadoBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchEmpleado').value;
            loadEmpleados(searchTerm);
        });
        
        document.getElementById('searchClienteBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchCliente').value;
            loadClientes(searchTerm);
        });
        
        document.getElementById('searchProductoBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchProducto').value;
            loadProductos(searchTerm);
        });
        
        document.getElementById('searchVentaBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchVenta').value;
            loadVentas(searchTerm);
        });
        
        document.getElementById('searchMonedaBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('searchMoneda').value;
            loadMonedas(searchTerm);
        });
        
        // Resetear búsquedas
        document.getElementById('resetEmpresaSearch').addEventListener('click', () => {
            document.getElementById('searchEmpresa').value = '';
            loadEmpresas();
        });
        
        document.getElementById('resetUsuarioSearch').addEventListener('click', () => {
            document.getElementById('searchUsuario').value = '';
            loadUsuarios();
        });
        
        document.getElementById('resetEmpleadoSearch').addEventListener('click', () => {
            document.getElementById('searchEmpleado').value = '';
            loadEmpleados();
        });
        
        document.getElementById('resetClienteSearch').addEventListener('click', () => {
            document.getElementById('searchCliente').value = '';
            loadClientes();
        });
        
        document.getElementById('resetProductoSearch').addEventListener('click', () => {
            document.getElementById('searchProducto').value = '';
            loadProductos();
        });
        
        document.getElementById('resetVentaSearch').addEventListener('click', () => {
            document.getElementById('searchVenta').value = '';
            loadVentas();
        });
        
        document.getElementById('resetMonedaSearch').addEventListener('click', () => {
            document.getElementById('searchMoneda').value = '';
            loadMonedas();
        });
        
        // Funciones de configuración
        async function loadStats() {
            try {
                const statsContainer = document.getElementById('statsContainer');
                statsContainer.innerHTML = '<p>Cargando estadísticas...</p>';
                
                // Obtener conteos de diferentes tablas
                const tables = ['empresas', 'usuarios', 'empleados', 'clientes', 'productos', 'ventas', 'monedas'];
                const counts = {};
                
                for (const table of tables) {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (!error) {
                        counts[table] = count;
                    }
                }
                
                let statsHtml = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Empresas</label>
                            <input type="text" value="${counts.empresas || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Usuarios</label>
                            <input type="text" value="${counts.usuarios || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Empleados</label>
                            <input type="text" value="${counts.empleados || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Clientes</label>
                            <input type="text" value="${counts.clientes || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Productos</label>
                            <input type="text" value="${counts.productos || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Ventas</label>
                            <input type="text" value="${counts.ventas || 0}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Monedas</label>
                            <input type="text" value="${counts.monedas || 0}" readonly>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML = statsHtml;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                document.getElementById('statsContainer').innerHTML = `<p>Error al cargar estadísticas: ${error.message}</p>`;
            }
        }
        
        // Probar conexión a Supabase
        document.getElementById('testConnection').addEventListener('click', async () => {
            showLoading(true);
            
            try {
                const { data, error } = await supabase
                    .from('empresas')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                showMessage(`Conexión exitosa a Supabase. Base de datos operativa.`, 'success');
            } catch (error) {
                console.error('Error probando conexión:', error);
                showMessage(`Error de conexión: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // Cargar todos los datos
        document.getElementById('loadAllData').addEventListener('click', async () => {
            showLoading(true);
            
            try {
                await Promise.all([
                    loadEmpresas(),
                    loadUsuarios(),
                    loadEmpleados(),
                    loadClientes(),
                    loadProductos(),
                    loadVentas(),
                    loadMonedas()
                ]);
                
                showMessage('Todos los datos han sido cargados', 'success');
            } catch (error) {
                console.error('Error cargando todos los datos:', error);
                showMessage('Error al cargar todos los datos: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // Limpiar todos los formularios
        document.getElementById('clearAllForms').addEventListener('click', () => {
            const forms = [
                'empresaForm', 'usuarioForm', 'empleadoForm', 
                'clienteForm', 'productoForm', 'ventaForm', 'monedaForm'
            ];
            
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    form.reset();
                    
                    // Limpiar hidden ID fields
                    const idField = form.querySelector('input[type="hidden"]');
                    if (idField) {
                        idField.value = '';
                    }
                    
                    // Restaurar texto del botón submit
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = submitBtn.textContent.replace('Actualizar', 'Guardar');
                    }
                }
            });
            
            showMessage('Todos los formularios han sido limpiados', 'success');
        });
        
        // Cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            showLoading(true);
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) throw error;
                
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error cerrando sesión:', error);
                showMessage('Error al cerrar sesión: ' + error.message, 'error');
                showLoading(false);
            }
        });
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            checkUserRole();
        });
    </script>
</body>
</html>
