<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Corporativo - Nexial</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Panel del Director Corporativo</h1>
    <div id="user-info"></div>
    <div id="empresas-list"></div>
    <button onclick="logout()">Cerrar Sesión</button>

    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const supabaseAnonKey = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Verificar sesión al cargar la página
        document.addEventListener('DOMContentLoaded', async function() {
            await checkSession();
            await loadEmpresas();
        });

        async function checkSession() {
            const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError || !sessionData.session) {
                window.location.href = 'login.html';
                return;
            }

            // Obtener información del usuario
            const { data: userData } = await supabase.auth.getUser();
            
            if (userData.user) {
                const { data: dbUser } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', userData.user.email)
                    .single();

                if (dbUser && dbUser.rol.toLowerCase().includes('director corporativo')) {
                    document.getElementById('user-info').innerHTML = `
                        <p>Bienvenido: ${dbUser.nombres} ${dbUser.apellido_paterno}</p>
                        <p>Rol: ${dbUser.rol}</p>
                        <p>Email: ${dbUser.email}</p>
                    `;
                } else {
                    alert('No tienes permisos para acceder a esta página.');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        }

        async function loadEmpresas() {
            const { data: empresas, error } = await supabase
                .from('empresas')
                .select('*')
                .order('creado_en', { ascending: false });

            if (error) {
                console.error('Error cargando empresas:', error);
                return;
            }

            const empresasDiv = document.getElementById('empresas-list');
            if (empresas && empresas.length > 0) {
                empresasDiv.innerHTML = '<h3>Empresas en el sistema:</h3>';
                empresas.forEach(empresa => {
                    empresasDiv.innerHTML += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 5px;">
                            <strong>${empresa.nombre}</strong><br>
                            RFC: ${empresa.rfc}<br>
                            Estado: ${empresa.activo ? 'Activa' : 'Inactiva'}
                        </div>
                    `;
                });
            } else {
                empresasDiv.innerHTML = '<p>No hay empresas registradas.</p>';
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
