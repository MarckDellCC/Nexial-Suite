<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Director Corporativo - Empresas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        h1 { color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: #ffc107; color: black; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-add { background: #28a745; color: white; margin-bottom: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .checkbox { width: auto; margin-right: 5px; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestión de Empresas - Director Corporativo</h1>
        <div id="userInfo" style="margin-bottom: 10px;"></div>
        <button class="btn btn-add" id="showFormBtn">+ Nueva Empresa</button>
        
        <!-- Formulario de empresa (oculto inicialmente) -->
        <div class="card" id="formCard" style="display: none;">
            <h3 id="formTitle">Nueva Empresa</h3>
            <form id="empresaForm">
                <input type="hidden" id="empresaId">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="nombre" required>
                </div>
                <div class="form-group">
                    <label>RFC *</label>
                    <input type="text" id="rfc" required>
                </div>
                <div class="form-group">
                    <label>Dirección</label>
                    <textarea id="direccion"></textarea>
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="text" id="telefono">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="website">
                </div>
                <div class="form-group">
                    <label>Moneda *</label>
                    <select id="moneda_id" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Logo URL</label>
                    <input type="url" id="logo_url">
                </div>
                <div class="form-group">
                    <label>Tipo de Empresa</label>
                    <input type="text" id="tipo_empresa">
                </div>
                <div class="form-group">
                    <label>Régimen Fiscal</label>
                    <input type="text" id="regimen_fiscal">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="activo" class="checkbox" checked> Activo</label>
                </div>
                <button type="submit" class="btn btn-add">Guardar</button>
                <button type="button" class="btn btn-delete" id="cancelFormBtn">Cancelar</button>
                <div id="formError" class="error"></div>
                <div id="formSuccess" class="success"></div>
            </form>
        </div>

        <!-- Tabla de empresas -->
        <div class="card">
            <h3>Listado de Empresas</h3>
            <table id="empresasTable">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>RFC</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th>Moneda</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="empresasBody">
                    <tr><td colspan="7">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sknyockrczifqemmdysx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_H3NG5ebaUykfhQgXSezZzw_mwhWAcVQ';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Verificar autenticación y rol
        const sessionData = sessionStorage.getItem('usuario');
        if (!sessionData) {
            window.location.href = 'login.html';
        } else {
            const usuario = JSON.parse(sessionData);
            if (usuario.rol !== 'Director Corporativo') {
                alert('Acceso no autorizado. Se requiere rol Director Corporativo.');
                window.location.href = 'login.html';
            } else {
                document.getElementById('userInfo').innerHTML = `Bienvenido, ${usuario.nombres} ${usuario.apellidos} (${usuario.rol})`;
            }
        }

        // Cargar monedas para el select
        async function cargarMonedas() {
            const { data, error } = await supabase
                .from('monedas')
                .select('id, codigo, nombre')
                .eq('activo', true)
                .order('codigo');
            if (error) {
                console.error('Error cargando monedas:', error);
                return;
            }
            const select = document.getElementById('moneda_id');
            select.innerHTML = '<option value="">Seleccione...</option>';
            data.forEach(moneda => {
                const option = document.createElement('option');
                option.value = moneda.id;
                option.textContent = `${moneda.codigo} - ${moneda.nombre}`;
                select.appendChild(option);
            });
        }

        // Cargar empresas y mostrarlas en la tabla
        async function cargarEmpresas() {
            const tbody = document.getElementById('empresasBody');
            tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
            const { data, error } = await supabase
                .from('empresas')
                .select(`
                    *,
                    monedas (codigo, nombre)
                `)
                .order('nombre');
            if (error) {
                tbody.innerHTML = `<tr><td colspan="7">Error: ${error.message}</td></tr>`;
                return;
            }
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="7">No hay empresas registradas.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            data.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.nombre}</td>
                    <td>${emp.rfc}</td>
                    <td>${emp.telefono || ''}</td>
                    <td>${emp.email || ''}</td>
                    <td>${emp.monedas?.codigo || ''}</td>
                    <td>${emp.activo ? 'Sí' : 'No'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarEmpresa('${emp.id}')">Editar</button>
                        <button class="btn btn-delete" onclick="eliminarEmpresa('${emp.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Mostrar formulario para nueva empresa
        document.getElementById('showFormBtn').addEventListener('click', () => {
            document.getElementById('empresaForm').reset();
            document.getElementById('empresaId').value = '';
            document.getElementById('formTitle').textContent = 'Nueva Empresa';
            document.getElementById('formCard').style.display = 'block';
            document.getElementById('formError').textContent = '';
            document.getElementById('formSuccess').textContent = '';
        });

        document.getElementById('cancelFormBtn').addEventListener('click', () => {
            document.getElementById('formCard').style.display = 'none';
        });

        // Manejar envío del formulario
        document.getElementById('empresaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('empresaId').value;
            const empresaData = {
                nombre: document.getElementById('nombre').value,
                rfc: document.getElementById('rfc').value,
                direccion: document.getElementById('direccion').value || null,
                telefono: document.getElementById('telefono').value || null,
                email: document.getElementById('email').value || null,
                website: document.getElementById('website').value || null,
                moneda_id: document.getElementById('moneda_id').value,
                logo_url: document.getElementById('logo_url').value || null,
                tipo_empresa: document.getElementById('tipo_empresa').value || null,
                regimen_fiscal: document.getElementById('regimen_fiscal').value || null,
                activo: document.getElementById('activo').checked
            };

            try {
                let error;
                if (id) {
                    // Actualizar
                    const { error: updateError } = await supabase
                        .from('empresas')
                        .update(empresaData)
                        .eq('id', id);
                    error = updateError;
                } else {
                    // Insertar
                    const { error: insertError } = await supabase
                        .from('empresas')
                        .insert([empresaData]);
                    error = insertError;
                }

                if (error) throw error;

                document.getElementById('formSuccess').textContent = id ? 'Empresa actualizada correctamente' : 'Empresa creada correctamente';
                document.getElementById('formError').textContent = '';
                cargarEmpresas();
                setTimeout(() => {
                    document.getElementById('formCard').style.display = 'none';
                }, 1500);
            } catch (err) {
                document.getElementById('formError').textContent = `Error: ${err.message}`;
                document.getElementById('formSuccess').textContent = '';
            }
        });

        // Función para editar
        window.editarEmpresa = async (id) => {
            const { data, error } = await supabase
                .from('empresas')
                .select('*')
                .eq('id', id)
                .single();
            if (error) {
                alert('Error al cargar datos de la empresa');
                return;
            }
            document.getElementById('empresaId').value = data.id;
            document.getElementById('nombre').value = data.nombre;
            document.getElementById('rfc').value = data.rfc;
            document.getElementById('direccion').value = data.direccion || '';
            document.getElementById('telefono').value = data.telefono || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('website').value = data.website || '';
            document.getElementById('moneda_id').value = data.moneda_id;
            document.getElementById('logo_url').value = data.logo_url || '';
            document.getElementById('tipo_empresa').value = data.tipo_empresa || '';
            document.getElementById('regimen_fiscal').value = data.regimen_fiscal || '';
            document.getElementById('activo').checked = data.activo;
            document.getElementById('formTitle').textContent = 'Editar Empresa';
            document.getElementById('formCard').style.display = 'block';
            document.getElementById('formError').textContent = '';
            document.getElementById('formSuccess').textContent = '';
        };

        // Función para eliminar
        window.eliminarEmpresa = async (id) => {
            if (!confirm('¿Está seguro de eliminar esta empresa? Esta acción puede afectar a datos relacionados.')) return;
            const { error } = await supabase
                .from('empresas')
                .delete()
                .eq('id', id);
            if (error) {
                alert('Error al eliminar: ' + error.message);
            } else {
                cargarEmpresas();
            }
        };

        // Inicializar
        cargarMonedas();
        cargarEmpresas();
    </script>
</body>
</html>
