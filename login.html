<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 400px; margin: auto; padding-top: 50px; }
        input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px; width: 100%; background: #4CAF50; color: white; border: none; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>Iniciar Sesión</h2>
    <form id="loginForm">
        <div>
            <label>Usuario o Email:</label>
            <input type="text" id="username" required>
        </div>
        <div>
            <label>Contraseña:</label>
            <input type="password" id="password" required>
        </div>
        <button type="submit">Entrar</button>
        <div id="error" class="error"></div>
    </form>

    <script>
        // Configuración de Supabase - REEMPLAZA CON TU SERVICE ROLE KEY (NO LA ANON)
        const SUPABASE_URL = 'https://sknyockrczifqemmdysx.supabase.co';
        const SUPABASE_SERVICE_KEY = 'tu-service-role-key'; // Reemplazar con la clave de servicio

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '';

            try {
                // Buscar usuario por usuario o email
                const { data: users, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .or(`usuario.eq.${username},email.eq.${username}`)
                    .eq('activo', true);

                if (error) throw error;
                if (!users || users.length === 0) {
                    errorDiv.textContent = 'Usuario no encontrado o inactivo';
                    return;
                }

                const user = users[0];
                // Comparar contraseña con bcrypt
                const match = bcrypt.compareSync(password, user.contrasena);
                if (!match) {
                    errorDiv.textContent = 'Contraseña incorrecta';
                    return;
                }

                // Actualizar último acceso
                await supabase
                    .from('usuarios')
                    .update({ ultimo_acceso: new Date() })
                    .eq('id', user.id);

                // Guardar datos del usuario en sessionStorage
                const userData = {
                    id: user.id,
                    rol: user.rol,
                    empresa_id: user.empresa_id,
                    nombres: user.nombres,
                    apellidos: `${user.apellido_paterno} ${user.apellido_materno || ''}`.trim()
                };
                sessionStorage.setItem('user', JSON.stringify(userData));

                // Redirigir según rol
                if (user.rol === 'Director Corporativo') {
                    window.location.href = 'director_corporativo.html';
                } else {
                    // Por ahora, solo tenemos página para Director Corporativo
                    errorDiv.textContent = 'Acceso no autorizado a esta página';
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
            }
        });
    </script>
</body>
</html>
