<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <div style="max-width: 300px; margin: 100px auto; padding: 20px;">
        <h2>Iniciar Sesión</h2>
        <div id="error" style="color: red; display: none; margin-bottom: 10px;"></div>
        
        <div style="margin-bottom: 15px;">
            <label>Usuario o Email:</label>
            <input type="text" id="username" style="width: 100%; padding: 5px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>Contraseña:</label>
            <input type="password" id="password" style="width: 100%; padding: 5px;">
        </div>
        
        <button onclick="login()" 
                style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer;">
            Ingresar
        </button>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="window.location.href='index.html'" 
                    style="padding: 5px 10px; background: #6c757d; color: white; border: none; cursor: pointer;">
                Volver
            </button>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://dcmzpbfhtcevinruphcz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_kIb5dk3KdkVJLGBfKEeyog_OxrzqsjB';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Función para hacer hash SHA256 (simple, sin salt por ahora)
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }
        
        async function login() {
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('error');
            
            errorDiv.style.display = 'none';
            
            if (!usernameInput || !passwordInput) {
                errorDiv.textContent = 'Por favor complete todos los campos';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Calcular hash de la contraseña
            const passwordHash = hashPassword(passwordInput);
            
            try {
                // Buscar usuario por username o email
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .or(`username.eq.${usernameInput},email.eq.${usernameInput}`)
                    .eq('eliminado', false)
                    .eq('cuenta_bloqueada', false);
                
                if (error) throw error;
                
                if (!usuarios || usuarios.length === 0) {
                    errorDiv.textContent = 'Usuario no encontrado';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const usuario = usuarios[0];
                
                // Verificar contraseña (comparación simple del hash)
                // NOTA: En producción necesitarías usar el salt del usuario
                if (usuario.password_hash === passwordHash) {
                    // Actualizar último login
                    await supabase
                        .from('usuarios')
                        .update({ fecha_ultimo_login: new Date().toISOString(), intentos_fallidos: 0 })
                        .eq('id', usuario.id);
                    
                    // Guardar usuario en sessionStorage
                    sessionStorage.setItem('usuario', JSON.stringify({
                        id: usuario.id,
                        username: usuario.username,
                        email: usuario.email,
                        rol_sistema: usuario.rol_sistema,
                        nivel_acceso: usuario.nivel_acceso,
                        empresa_id: usuario.empresa_id
                    }));
                    
                    // Redirigir según rol
                    if (usuario.rol_sistema === 'DIRECTOR_CORPORATIVO') {
                        window.location.href = 'Director Corporativo.html';
                    } else {
                        errorDiv.textContent = 'Acceso denegado. Solo el Director Corporativo puede acceder por ahora';
                        errorDiv.style.display = 'block';
                    }
                } else {
                    // Incrementar intentos fallidos
                    const nuevosIntentos = (usuario.intentos_fallidos || 0) + 1;
                    await supabase
                        .from('usuarios')
                        .update({ intentos_fallidos: nuevosIntentos })
                        .eq('id', usuario.id);
                    
                    if (nuevosIntentos >= 5) {
                        await supabase
                            .from('usuarios')
                            .update({ cuenta_bloqueada: true, fecha_bloqueo: new Date().toISOString() })
                            .eq('id', usuario.id);
                        
                        errorDiv.textContent = 'Cuenta bloqueada por muchos intentos fallidos';
                    } else {
                        errorDiv.textContent = 'Contraseña incorrecta. Intentos: ' + nuevosIntentos + '/5';
                    }
                    errorDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error de login:', error);
                errorDiv.textContent = 'Error de conexión con la base de datos';
                errorDiv.style.display = 'block';
            }
        }
        
        // Permitir login con Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
