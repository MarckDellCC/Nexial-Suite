<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Nexial</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Login Sistema Nexial</h1>
    
    <div id="login-form">
        <input type="email" id="email" placeholder="Correo electrónico" required>
        <input type="password" id="password" placeholder="Contraseña" required>
        <button onclick="login()">Iniciar Sesión</button>
    </div>

    <div id="message" style="color: red; margin-top: 10px;"></div>

    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://bsbsvvszfxpzxsybzuvf.supabase.co';
        const supabaseAnonKey = 'sb_publishable_NrJZZp3mSnvJNhdCZJdWzw_8oeI_Ol-';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('message');

            if (!email || !password) {
                messageDiv.textContent = 'Por favor, completa todos los campos.';
                return;
            }

            messageDiv.textContent = 'Verificando credenciales...';

            try {
                // 1. Autenticación con Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) {
                    throw new Error(authError.message);
                }

                const userId = authData.user.id;

                // 2. Obtener información del usuario desde nuestra tabla 'usuarios'
                const { data: userData, error: userError } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (userError) {
                    throw new Error('Usuario no encontrado en el sistema.');
                }

                // 3. Redirigir según el rol
                const userRole = userData.rol;
                messageDiv.textContent = `Bienvenido ${userData.nombres}, Rol: ${userRole}`;

                // Redirección basada en rol
                if (userRole.toLowerCase().includes('director corporativo')) {
                    window.location.href = 'director_corporativo.html';
                } else if (userRole.toLowerCase().includes('director general')) {
                    window.location.href = 'director_general.html';
                } else if (userRole.toLowerCase().includes('director financiero')) {
                    window.location.href = 'director_financiero.html';
                } else {
                    messageDiv.textContent += ' - No tienes una página específica asignada.';
                }

            } catch (error) {
                messageDiv.textContent = 'Error: ' + error.message;
                console.error(error);
            }
        }

        // Permitir login con Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
