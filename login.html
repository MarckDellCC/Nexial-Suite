<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
</head>
<body>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Usuario" required>
        <input type="password" id="password" placeholder="Contraseña" required>
        <button type="submit">Entrar</button>
    </form>
    <div id="error"></div>

    <script>
        const SUPABASE_URL = 'https://dcmzpbfhtcevinruphcz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_kIb5dk3KdkVJLGBfKEeyog_OxrzqsjB';
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '';
            
            try {
                // Primero obtener todos los usuarios
                const response = await fetch(`${SUPABASE_URL}/rest/v1/usuarios`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error de conexión');
                }
                
                const usuarios = await response.json();
                
                // Buscar usuario manualmente
                const usuario = usuarios.find(u => 
                    (u.username === username || u.email === username) && 
                    u.password_hash === password && 
                    u.eliminado === false &&
                    u.cuenta_bloqueada === false
                );
                
                if (!usuario) {
                    throw new Error('Credenciales incorrectas');
                }
                
                // Guardar sesión
                localStorage.setItem('usuario', JSON.stringify({
                    id: usuario.id,
                    username: usuario.username,
                    email: usuario.email,
                    rol_sistema: usuario.rol_sistema,
                    nivel_acceso: usuario.nivel_acceso,
                    empresa_id: usuario.empresa_id
                }));
                
                // Redirigir según rol
                if (usuario.rol_sistema === 'DIRECTOR_CORPORATIVO') {
                    window.location.href = 'Director%20Corporativo.html';
                } else {
                    errorDiv.textContent = 'Acceso restringido. Solo Director Corporativo.';
                }
                
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        });
        
        // Verificar sesión existente
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (usuario && usuario.rol_sistema === 'DIRECTOR_CORPORATIVO') {
            window.location.href = 'Director%20Corporativo.html';
        }
    </script>
</body>
</html>
